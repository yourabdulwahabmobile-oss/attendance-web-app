<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GPS Sheinwal - RF Attendance v8.1 FIXED</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    
    :root{
      --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --bg:#f8fafc; 
      --card:#ffffff; 
      --text:#1e293b; 
      --muted:#64748b;
      --brand:#6366f1; 
      --brand-hover:#4f46e5;
      --brand-light:#eef2ff;
      --ok:#10b981; 
      --warn:#f59e0b; 
      --bad:#ef4444;
      --border:#e2e8f0; 
      --shadow:0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
      --shadow-lg:0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
    }
    
    * { box-sizing: border-box; margin:0; padding:0; }
    
    html,body{
      min-height:100%;
      background:var(--bg);
      color:var(--text);
      font-family:'Inter',system-ui,-apple-system,sans-serif;
      line-height:1.6;
    }

    header{
      position:sticky;
      top:0;
      z-index:50;
      background:var(--bg-gradient);
      color:#fff;
      text-align:center;
      padding:16px;
      box-shadow:var(--shadow-lg);
    }
    
    .school-name{
      font-size:clamp(18px, 4vw, 24px);
      font-weight:800;
      margin-bottom:4px;
      text-shadow:0 2px 4px rgba(0,0,0,0.1);
      letter-spacing:-0.5px;
    }
    
    .bar h1{
      font-size:clamp(14px, 3.5vw, 18px);
      margin:0;
      font-weight:600;
      letter-spacing:0.5px;
      opacity:0.95;
    }

    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:12px;
    }

    .card{
      background:var(--card);
      border-radius:16px;
      box-shadow:var(--shadow-lg);
      padding:20px;
      border:1px solid var(--border);
      margin-bottom:16px;
    }

    .main-tabs{
      display:grid;
      grid-template-columns:repeat(2, 1fr);
      gap:10px;
      margin-bottom:16px;
    }
    
    .main-tabs button{
      padding:14px 10px;
      border-radius:12px;
      border:2px solid transparent;
      background:var(--card);
      cursor:pointer;
      font-weight:700;
      font-size:14px;
      transition:all 0.3s;
      box-shadow:var(--shadow);
      color:var(--text);
    }
    
    .main-tabs button:hover{
      transform:translateY(-2px);
      box-shadow:0 8px 16px -4px rgba(99,102,241,0.3);
    }
    
    .main-tabs button.active{
      background:var(--bg-gradient);
      color:#fff;
      box-shadow:0 8px 16px -4px rgba(99,102,241,0.5);
    }

    .sub-tabs{
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:8px;
      margin-bottom:16px;
      background:var(--brand-light);
      padding:8px;
      border-radius:12px;
    }

    .sub-tabs button{
      padding:10px 8px;
      border-radius:8px;
      border:none;
      background:white;
      cursor:pointer;
      font-weight:600;
      font-size:12px;
      transition:all 0.3s;
      color:var(--text);
    }

    .sub-tabs button.active{
      background:var(--brand);
      color:white;
      box-shadow:0 4px 8px rgba(99,102,241,0.3);
    }

    .toolbar{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
      margin-bottom:16px;
    }
    
    .label-text{
      font-weight:600;
      font-size:12px;
      color:var(--text);
      margin-bottom:6px;
      display:block;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    
    input[type="text"],input[type="password"],input[type="number"],select{
      padding:12px 14px;
      border-radius:10px;
      border:2px solid var(--border);
      font-size:14px;
      width:100%;
      transition:all 0.2s;
      background:var(--card);
      font-family:inherit;
    }
    
    input:focus,select:focus{
      outline:none;
      border-color:var(--brand);
      box-shadow:0 0 0 3px var(--brand-light);
    }

    .select-all-bar{
      background:var(--brand-light);
      border:2px solid var(--brand);
      border-radius:10px;
      padding:14px 16px;
      margin-bottom:12px;
      display:flex;
      align-items:center;
      gap:10px;
    }

    .select-all-bar input[type="checkbox"]{
      width:20px;
      height:20px;
      cursor:pointer;
    }

    .select-all-bar label{
      font-weight:700;
      font-size:14px;
      color:var(--brand);
      cursor:pointer;
      flex:1;
    }

    .selected-count{
      background:var(--brand);
      color:white;
      padding:4px 12px;
      border-radius:16px;
      font-weight:700;
      font-size:12px;
    }

    .list{
      background:var(--card);
      border:2px solid var(--border);
      border-radius:12px;
      overflow:hidden;
      margin-bottom:80px;
      box-shadow:var(--shadow);
      max-height: 60vh;
      overflow-y: auto;
    }
    
    .row-item{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 14px;
      border-top:1px solid var(--border);
      transition:all 0.2s;
      gap:10px;
    }
    
    .row-item:first-child{border-top:none}
    
    .row-item:hover{
      background:var(--brand-light);
    }

    .row-item.selected{
      background:#d1fae5;
    }
    
    .student-info{
      flex:1;
      min-width:0;
    }

    .name{
      font-weight:700;
      font-size:14px;
      color:var(--text);
      margin-bottom:2px;
    }
    
    .meta{
      font-size:11px;
      color:var(--muted);
      font-weight:500;
    }

    .student-checkbox{
      width:20px;
      height:20px;
      cursor:pointer;
      flex-shrink:0;
    }

    .fab{
      position:fixed;
      bottom:16px;
      left:50%;
      transform:translateX(-50%);
      z-index:100;
      width:calc(100% - 24px);
      max-width:400px;
    }
    
    .fab button{
      width:100%;
      padding:14px 24px;
      border-radius:50px;
      font-size:15px;
      font-weight:700;
      background:var(--bg-gradient);
      color:#fff;
      border:none;
      box-shadow:0 10px 25px -5px rgba(99,102,241,0.5);
      cursor:pointer;
      transition:all 0.3s;
    }
    
    .fab button:hover{
      transform:translateY(-3px);
      box-shadow:0 15px 30px -5px rgba(99,102,241,0.6);
    }

    .fab button:disabled{
      opacity:0.6;
      cursor:not-allowed;
    }

    .upload-toast{
      position:fixed;
      top:80px;
      right:12px;
      background:white;
      border:2px solid var(--brand);
      border-radius:12px;
      padding:16px;
      box-shadow:var(--shadow-lg);
      z-index:90;
      min-width:280px;
      animation:slideIn 0.3s ease;
    }

    @keyframes slideIn{
      from{transform:translateX(400px);opacity:0;}
      to{transform:translateX(0);opacity:1;}
    }

    .upload-progress-bar{
      width:100%;
      height:8px;
      background:var(--border);
      border-radius:4px;
      overflow:hidden;
      margin:10px 0;
    }

    .upload-progress-fill{
      height:100%;
      background:var(--brand);
      transition:width 0.3s;
    }

    .hidden{display:none!important}

    .login-container {
      text-align:center;
      max-width:400px;
      margin:40px auto;
    }
    
    .login-icon {
      width:70px;
      height:70px;
      margin:0 auto 16px;
      background:var(--bg-gradient);
      border-radius:16px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:36px;
      box-shadow:var(--shadow-lg);
    }

    .cache-status {
      position: fixed;
      bottom: 80px;
      right: 12px;
      background: white;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 11px;
      box-shadow: var(--shadow);
      z-index: 50;
    }

    @media (min-width: 768px) {
      .wrap { padding:20px; }
      .toolbar { grid-template-columns:1fr 1fr; }
      .main-tabs { grid-template-columns:repeat(4, 1fr); }
    }
  </style>
</head>
<body>
  <header>
    <div class="school-name">üéì GPS Sheinwal (Shamaskay)</div>
    <div class="bar"><h1>RFID Attendance System v8.1 FIXED</h1></div>
  </header>
  
  <div class="wrap">
    <!-- LOGIN VIEW -->
    <section id="viewLogin" class="card login-container">
      <div class="login-icon">üîê</div>
      <div style="font-size:24px;font-weight:800;margin-bottom:6px;color:var(--text);">Secure Login</div>
      <div style="color:var(--muted);margin-bottom:20px;font-size:14px;">Enter your password to continue</div>
      <div id="loginDateTime" style="color:var(--muted);margin-bottom:16px;font-size:12px;"></div>
      <input id="pinInput" type="password" inputmode="numeric" maxlength="20" placeholder="Enter Password" 
        style="width:90%;padding:12px 18px;text-align:center;letter-spacing:3px;margin-bottom:16px;font-size:16px;" />
      <button id="loginBtn" style="padding:12px 36px;border:none;border-radius:10px;background:var(--bg-gradient);
        color:white;font-size:15px;font-weight:700;cursor:pointer;box-shadow:0 4px 12px rgba(99,102,241,0.4);transition:all 0.3s;">
        Login ‚Üí
      </button>
      <div id="loginError" style="margin-top:14px;color:var(--bad);font-weight:600;font-size:13px;"></div>
    </section>

    <!-- MAIN VIEW -->
    <section id="viewMain" class="hidden">
      <div class="main-tabs">
        <button id="tabAttendance" class="active">üìã Attendance</button>
        <button id="tabReports">üìÑ Reports</button>
        <button id="tabSummary">üìä Summary</button>
        <button id="tabSystemInfo">üîß System</button>
      </div>

      <div id="sectionAttendance">
        <div class="sub-tabs">
          <button id="subTabManual" class="active">‚úçÔ∏è Manual</button>
          <button id="subTabQR">üì∑ QR Scan</button>
          <button id="subTabStudentInfo">üë§ Student Info</button>
        </div>

        <div id="subSectionManual">
          <div class="toolbar">
            <div>
              <span class="label-text">üìö Select Class</span>
              <select id="classSelect">
                <option value="">All Classes</option>
              </select>
            </div>
            <div>
              <span class="label-text">üîç Search Student</span>
              <input type="text" id="searchInput" placeholder="Search by name, father name or enrollment..." />
            </div>
          </div>

          <div class="select-all-bar">
            <input type="checkbox" id="selectAllCheckbox" />
            <label for="selectAllCheckbox">Select All (Present)</label>
            <span class="selected-count" id="selectedCount">0 Selected</span>
          </div>

          <div id="studentList" class="list"></div>
          
          <div class="fab">
            <button id="submitBtn">‚úì Submit Attendance</button>
          </div>
        </div>

        <div id="subSectionQR" class="hidden">
          <div class="card" style="text-align:center;padding:60px 20px;">
            <div style="font-size:48px;margin-bottom:16px;">üì∑</div>
            <h3 style="color:var(--brand);margin-bottom:12px;">QR Code Scanner</h3>
            <p style="color:var(--muted);font-size:14px;">Coming soon...</p>
          </div>
        </div>

        <div id="subSectionStudentInfo" class="hidden">
          <div class="toolbar">
            <div>
              <span class="label-text">üîç Search Student</span>
              <input type="text" id="singleStudentSearch" placeholder="Enter name or enrollment..." />
            </div>
          </div>
          <div id="studentDetailResult"></div>
        </div>
      </div>

      <div id="sectionReports" class="hidden">
        <div class="card">
          <h3 style="color:var(--brand);margin-bottom:16px;">üìÑ Download Reports</h3>
          <a href="https://docs.google.com/spreadsheets/d/1woOwa-1ydra43sLalpjGB4x-1ZjeE_rWSy9LDvGBpJA/export?format=xlsx&gid=493301113" 
             style="display:block;padding:14px;background:white;border:2px solid var(--border);border-radius:10px;margin-bottom:10px;text-decoration:none;color:var(--text);font-weight:600;" target="_blank">
            üìä Download Student Data
          </a>
        </div>
      </div>

      <div id="sectionSummary" class="hidden">
        <div class="card">
          <h3 style="color:var(--brand);margin-bottom:16px;">üìä Summary</h3>
          <div id="summaryContent"></div>
        </div>
      </div>

      <div id="sectionSystemInfo" class="hidden">
        <div class="card">
          <h3 style="color:var(--brand);margin-bottom:16px;">üîß System Info</h3>
          <div id="systemInfoContent"></div>
        </div>
      </div>
    </section>
  </div>

  <div id="cacheStatus" class="cache-status hidden"></div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxurppG7uSSGVirNqwO-qpUFDz760NdU_N9qdKU1Q1UOgxaQ2yBTFXeorhUAz4TNSeQGg/exec";
    const PIN = "39310242";
    const WIFI_SSID = "Mirza Gee 3";
    
    let g_students = [];
    let g_filteredStudents = [];
    let g_selectedUIDs = new Set();
    let g_todayAttendance = {};
    let g_sessionStats = { totalUploaded: 0, totalDuplicate: 0, totalFailed: 0 };

    // ===== IMPROVED LOCALSTORAGE CACHING =====
    function saveStudentsToCache(students) {
      try {
        const cacheData = {
          students: students,
          timestamp: Date.now(),
          version: 'v8.1',
          count: students.length
        };
        localStorage.setItem('gps_students_cache', JSON.stringify(cacheData));
        console.log(`‚úÖ Cached ${students.length} students to localStorage`);
        updateCacheStatus(`Cached: ${students.length} students`);
      } catch (error) {
        console.error('‚ùå Failed to save cache:', error);
      }
    }

    function loadStudentsFromCache() {
      try {
        const cached = localStorage.getItem('gps_students_cache');
        if (!cached) {
          console.log('‚ÑπÔ∏è No cache found');
          return null;
        }

        const data = JSON.parse(cached);
        const ageHours = (Date.now() - data.timestamp) / (1000 * 60 * 60);
        
        if (ageHours > 24) {
          console.log('‚ö†Ô∏è Cache expired (>24h), clearing...');
          localStorage.removeItem('gps_students_cache');
          return null;
        }

        if (!data.students || data.students.length === 0) {
          console.log('‚ö†Ô∏è Cache empty');
          return null;
        }

        console.log(`‚úÖ Loaded ${data.students.length} students from cache (${ageHours.toFixed(1)}h old)`);
        updateCacheStatus(`Cache: ${data.students.length} students (${ageHours.toFixed(1)}h old)`);
        return data.students;
      } catch (error) {
        console.error('‚ùå Error loading cache:', error);
        localStorage.removeItem('gps_students_cache');
        return null;
      }
    }

    function updateCacheStatus(message) {
      const status = document.getElementById('cacheStatus');
      if (status) {
        status.textContent = message;
        status.classList.remove('hidden');
        setTimeout(() => status.classList.add('hidden'), 5000);
      }
    }

    function saveToLocalStorage() {
      const today = new Date().toLocaleDateString('en-GB');
      localStorage.setItem('attendanceDate', today);
      localStorage.setItem('todayAttendance', JSON.stringify(g_todayAttendance));
      localStorage.setItem('selectedUIDs', JSON.stringify([...g_selectedUIDs]));
      localStorage.setItem('sessionStats', JSON.stringify(g_sessionStats));
    }

    function loadFromLocalStorage() {
      const today = new Date().toLocaleDateString('en-GB');
      const storedDate = localStorage.getItem('attendanceDate');
      
      if (storedDate === today) {
        const attendance = localStorage.getItem('todayAttendance');
        const selected = localStorage.getItem('selectedUIDs');
        const stats = localStorage.getItem('sessionStats');
        
        if (attendance) g_todayAttendance = JSON.parse(attendance);
        if (selected) g_selectedUIDs = new Set(JSON.parse(selected));
        if (stats) g_sessionStats = JSON.parse(stats);
      }
    }

    // ===== LOGIN =====
    document.getElementById('loginBtn')?.addEventListener('click', handleLogin);
    document.getElementById('pinInput')?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') handleLogin();
    });

    function handleLogin() {
      const pin = document.getElementById('pinInput').value.trim();
      if (pin === PIN) {
        document.getElementById('viewLogin').classList.add('hidden');
        document.getElementById('viewMain').classList.remove('hidden');
        initializeApp();
      } else {
        document.getElementById('loginError').textContent = '‚ùå Invalid Password!';
      }
    }

    setInterval(() => {
      const el = document.getElementById('loginDateTime');
      if (el) el.textContent = new Date().toLocaleString('en-GB');
    }, 1000);

    // ===== INITIALIZE APP =====
    async function initializeApp() {
      console.log('üöÄ Initializing app...');
      
      loadFromLocalStorage();
      
      const cached = loadStudentsFromCache();
      if (cached && cached.length > 0) {
        g_students = cached;
        console.log(`‚úÖ Using cached data: ${g_students.length} students`);
        populateClassDropdown();
        filterAndRender();
        updateSummary();
        
        loadAllStudents(true);
      } else {
        console.log('üì• No cache, loading fresh data...');
        showLoadingIndicator();
        await loadAllStudents(false);
      }
    }

    function showLoadingIndicator() {
      const container = document.getElementById('studentList');
      if (container) {
        container.innerHTML = `
          <div style="padding:60px 20px;text-align:center;">
            <div style="font-size:48px;margin-bottom:16px;">üì•</div>
            <div style="color:var(--brand);font-weight:700;font-size:16px;">Loading Students...</div>
          </div>
        `;
      }
    }

    // ===== LOAD ALL STUDENTS WITH IMPROVED CACHING =====
    async function loadAllStudents(isBackgroundRefresh = false) {
      try {
        console.log(isBackgroundRefresh ? 'üîÑ Background refresh...' : 'üì• Loading students...');
        
        if (!isBackgroundRefresh) showLoadingIndicator();
        
        const classes = ['Nursery', '1', '2', '3', '4', '5'];
        const newStudents = [];
        
        for (const cls of classes) {
          try {
            const response = await fetch(`${SCRIPT_URL}?action=getstudents&class=${encodeURIComponent(cls)}`, {
              method: 'GET',
              mode: 'cors',
              cache: 'no-cache'
            });
            
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const data = await response.json();
            
            if (data.success && data.students && data.students.length > 0) {
              data.students.forEach(student => {
                newStudents.push({
                  ...student,
                  identifier: student.enrollment || student.name
                });
              });
              console.log(`‚úÖ Loaded class ${cls}: ${data.students.length} students`);
            }
          } catch (err) {
            console.log(`‚ö†Ô∏è Failed to load class ${cls}:`, err.message);
          }
          
          await new Promise(r => setTimeout(r, 200));
        }
        
        if (newStudents.length > 0) {
          g_students = newStudents;
          console.log(`‚úÖ Total loaded: ${g_students.length} students`);
          
          saveStudentsToCache(g_students);
          
          if (!isBackgroundRefresh) {
            populateClassDropdown();
            filterAndRender();
            updateSummary();
          } else {
            console.log('‚úÖ Background refresh complete');
          }
        } else {
          throw new Error('No students loaded');
        }
        
      } catch (error) {
        console.error('‚ùå Load failed:', error);
        
        if (g_students.length === 0) {
          alert('‚ö†Ô∏è Failed to load students. Using test data.');
          loadMockData();
        }
      }
    }

    function loadMockData() {
      g_students = [
        { srNo: '1', enrollment: '2501', name: 'MUHAMMAD ALI', gender: 'M', father: 'AHMED KHAN', class: 'Nursery', mobile: '03001234567', identifier: '2501' },
        { srNo: '2', enrollment: '2502', name: 'FATIMA BIBI', gender: 'F', father: 'HASSAN ALI', class: 'Nursery', mobile: '03009876543', identifier: '2502' },
        { srNo: '3', enrollment: '2503', name: 'ABDULLAH SHAH', gender: 'M', father: 'KARIM SHAH', class: '1', mobile: '03112345678', identifier: '2503' },
        { srNo: '4', enrollment: '2504', name: 'AYESHA KHAN', gender: 'F', father: 'IMRAN KHAN', class: '2', mobile: '03223456789', identifier: '2504' },
        { srNo: '5', enrollment: '2505', name: 'BILAL AHMED', gender: 'M', father: 'AHMED HUSSAIN', class: '3', mobile: '03334567890', identifier: '2505' }
      ];
      
      saveStudentsToCache(g_students);
      populateClassDropdown();
      filterAndRender();
      updateSummary();
    }

    // ===== POPULATE CLASS DROPDOWN =====
    function populateClassDropdown() {
      const select = document.getElementById('classSelect');
      if (!select) return;
      
      const classSet = new Set(g_students.map(s => s.class).filter(c => c));
      const classes = Array.from(classSet).sort((a, b) => {
        if (a === 'Nursery') return -1;
        if (b === 'Nursery') return 1;
        return parseInt(a) - parseInt(b);
      });
      
      select.innerHTML = '<option value="">All Classes</option>';
      classes.forEach(cls => {
        const opt = document.createElement('option');
        opt.value = cls;
        opt.textContent = cls;
        select.appendChild(opt);
      });
      
      console.log(`‚úÖ Classes populated: ${classes.join(', ')}`);
    }

    // ===== FILTER & RENDER (OPTIMIZED) =====
    document.getElementById('classSelect')?.addEventListener('change', filterAndRender);
    document.getElementById('searchInput')?.addEventListener('input', filterAndRender);

    function filterAndRender() {
      const classFilter = document.getElementById('classSelect')?.value || '';
      const searchText = document.getElementById('searchInput')?.value?.toLowerCase() || '';
      
      g_filteredStudents = g_students.filter(s => {
        const matchClass = !classFilter || s.class === classFilter;
        const matchSearch = !searchText || 
          s.name.toLowerCase().includes(searchText) ||
          s.father.toLowerCase().includes(searchText) ||
          (s.enrollment && s.enrollment.toLowerCase().includes(searchText));
        
        return matchClass && matchSearch;
      });
      
      console.log(`üîç Filtered: ${g_filteredStudents.length} of ${g_students.length}`);
      
      renderStudentList();
      updateSelectAllCheckbox();
    }

    function renderStudentList() {
      const container = document.getElementById('studentList');
      if (!container) return;
      
      container.innerHTML = '';
      
      if (g_filteredStudents.length === 0) {
        container.innerHTML = '<div style="padding:40px;text-align:center;color:var(--muted);">No students found</div>';
        return;
      }
      
      g_filteredStudents.forEach(student => {
        const identifier = student.identifier;
        const isMarked = g_todayAttendance[identifier] !== undefined;
        
        const div = document.createElement('div');
        div.className = 'row-item';
        
        if (g_selectedUIDs.has(identifier)) div.classList.add('selected');
        
        div.innerHTML = `
          <div class="student-info">
            <div class="name">${student.name}</div>
            <div class="meta">üë®‚Äçüëß ${student.father} | üéì ${student.class} | üÜî ${student.enrollment || 'N/A'}</div>
          </div>
          <input type="checkbox" class="student-checkbox" data-identifier="${identifier}" ${g_selectedUIDs.has(identifier) ? 'checked' : ''} />
        `;
        
        container.appendChild(div);
      });
      
      document.querySelectorAll('.student-checkbox').forEach(cb => {
        cb.addEventListener('change', handleCheckboxChange);
      });
      
      updateSelectedCount();
    }

    function handleCheckboxChange(e) {
      const identifier = e.target.dataset.identifier;
      
      if (e.target.checked) {
        g_selectedUIDs.add(identifier);
        e.target.closest('.row-item').classList.add('selected');
      } else {
        g_selectedUIDs.delete(identifier);
        e.target.closest('.row-item').classList.remove('selected');
      }
      
      updateSelectedCount();
      updateSelectAllCheckbox();
      saveToLocalStorage();
    }

    document.getElementById('selectAllCheckbox')?.addEventListener('change', (e) => {
      const checked = e.target.checked;
      
      g_filteredStudents.forEach(s => {
        const id = s.identifier;
        if (!g_todayAttendance[id]) {
          if (checked) g_selectedUIDs.add(id);
          else g_selectedUIDs.delete(id);
        }
      });
      
      renderStudentList();
      saveToLocalStorage();
    });

    function updateSelectAllCheckbox() {
      const checkbox = document.getElementById('selectAllCheckbox');
      if (!checkbox) return;
      
      const unmarked = g_filteredStudents.filter(s => !g_todayAttendance[s.identifier]);
      checkbox.checked = unmarked.length > 0 && unmarked.every(s => g_selectedUIDs.has(s.identifier));
    }

    function updateSelectedCount() {
      document.getElementById('selectedCount').textContent = `${g_selectedUIDs.size} Selected`;
    }

    // ===== SUBMIT ATTENDANCE =====
    document.getElementById('submitBtn')?.addEventListener('click', submitAttendance);

    async function submitAttendance() {
      if (g_selectedUIDs.size === 0) {
        alert('‚ùå Please select students!');
        return;
      }

      const selected = g_students.filter(s => g_selectedUIDs.has(s.identifier) && !g_todayAttendance[s.identifier]);
      if (selected.length === 0) {
        alert('‚ùå All selected students already marked!');
        return;
      }

      const total = selected.length;
      let success = 0, duplicate = 0, failed = 0;

      const btn = document.getElementById('submitBtn');
      btn.disabled = true;
      btn.textContent = `Uploading 0/${total}...`;

      showUploadToast(0, total);

      for (let i = 0; i < selected.length; i++) {
        const student = selected[i];
        
        try {
          const result = await uploadSingleAttendance(student, 'present');
          
          if (result.success) {
            success++;
            g_sessionStats.totalUploaded++;
            g_todayAttendance[student.identifier] = 'present';
            g_selectedUIDs.delete(student.identifier);
          } else if (result.alreadyMarked) {
            duplicate++;
            g_sessionStats.totalDuplicate++;
            g_todayAttendance[student.identifier] = 'present';
            g_selectedUIDs.delete(student.identifier);
          } else {
            failed++;
            g_sessionStats.totalFailed++;
          }
          
          btn.textContent = `Uploading ${i + 1}/${total}...`;
          updateUploadToast(i + 1, total, success, duplicate, failed);
          
          await new Promise(r => setTimeout(r, 800));
        } catch (error) {
          console.error('Upload error:', error);
          failed++;
          g_sessionStats.totalFailed++;
        }
      }

      btn.disabled = false;
      btn.textContent = '‚úì Submit Attendance';
      hideUploadToast();

      saveToLocalStorage();
      renderStudentList();
      updateSummary();

      alert(`üìä Complete!\n‚úÖ Success: ${success}\n‚ö†Ô∏è Duplicate: ${duplicate}\n‚ùå Failed: ${failed}`);
    }

    async function uploadSingleAttendance(student, status) {
      let url = `${SCRIPT_URL}?action=insert&status=${status}`;
      
      if (student.enrollment) url += `&enrollment=${encodeURIComponent(student.enrollment)}`;
      url += `&name=${encodeURIComponent(student.name)}`;
      url += `&father=${encodeURIComponent(student.father)}`;
      if (student.uid) url += `&uid=${encodeURIComponent(student.uid)}`;
      
      const response = await fetch(url, { method: 'GET' });
      return await response.json();
    }

    function showUploadToast(current, total) {
      const existing = document.getElementById('uploadToast');
      if (existing) existing.remove();

      const toast = document.createElement('div');
      toast.id = 'uploadToast';
      toast.className = 'upload-toast';
      toast.innerHTML = `
        <div style="font-weight:700;margin-bottom:8px;">üì§ Uploading...</div>
        <div class="upload-progress-bar">
          <div class="upload-progress-fill" style="width:0%"></div>
        </div>
        <div id="uploadStats" style="font-size:12px;color:var(--muted);margin-top:6px;">0 / ${total}</div>
      `;
      document.body.appendChild(toast);
    }

    function updateUploadToast(current, total, success, duplicate, failed) {
      const progress = (current / total) * 100;
      const fill = document.querySelector('.upload-progress-fill');
      const stats = document.getElementById('uploadStats');
      
      if (fill) fill.style.width = `${progress}%`;
      if (stats) stats.innerHTML = `${current}/${total} | ‚úÖ${success} ‚ö†Ô∏è${duplicate} ‚ùå${failed}`;
    }

    function hideUploadToast() {
      setTimeout(() => {
        const toast = document.getElementById('uploadToast');
        if (toast) toast.remove();
      }, 2000);
    }

    // ===== SUMMARY =====
    function updateSummary() {
      const totalStudents = g_students.length;
      const presentToday = Object.values(g_todayAttendance).filter(s => s === 'present').length;
      const rate = totalStudents > 0 ? Math.round((presentToday / totalStudents) * 100) : 0;
      
      const content = document.getElementById('summaryContent');
      if (!content) return;
      
      content.innerHTML = `
        <div style="display:grid;gap:16px;">
          <div style="background:var(--brand-light);padding:20px;border-radius:12px;">
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px;">
              <div style="text-align:center;padding:12px;background:white;border-radius:8px;">
                <div style="font-size:24px;font-weight:800;color:#10b981;">${presentToday}</div>
                <div style="font-size:11px;color:var(--muted);font-weight:600;">PRESENT</div>
              </div>
              <div style="text-align:center;padding:12px;background:white;border-radius:8px;">
                <div style="font-size:24px;font-weight:800;color:#6366f1;">${totalStudents}</div>
                <div style="font-size:11px;color:var(--muted);font-weight:600;">TOTAL</div>
              </div>
              <div style="text-align:center;padding:12px;background:white;border-radius:8px;">
                <div style="font-size:24px;font-weight:800;color:#f59e0b;">${rate}%</div>
                <div style="font-size:11px;color:var(--muted);font-weight:600;">RATE</div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // ===== SYSTEM INFO =====
    function updateSystemInfo() {
      const content = document.getElementById('systemInfoContent');
      if (!content) return;
      
      const cached = localStorage.getItem('gps_students_cache');
      const cacheInfo = cached ? JSON.parse(cached) : null;
      const cacheAge = cacheInfo ? Math.round((Date.now() - cacheInfo.timestamp) / (1000 * 60)) : 0;
      
      content.innerHTML = `
        <div style="display:grid;gap:12px;">
          <div style="padding:16px;background:var(--brand-light);border-radius:10px;">
            <div style="font-weight:700;color:var(--brand);margin-bottom:12px;">üìä Student Data</div>
            <div style="font-size:13px;line-height:1.8;">
              <strong>Total Students:</strong> ${g_students.length}<br>
              <strong>Cache Status:</strong> ${cacheInfo ? '‚úÖ Active' : '‚ùå None'}<br>
              <strong>Cache Age:</strong> ${cacheAge} minutes<br>
              <strong>Last Updated:</strong> ${cacheInfo ? new Date(cacheInfo.timestamp).toLocaleString('en-GB') : 'Never'}
            </div>
          </div>
          
          <div style="padding:16px;background:white;border-radius:10px;border:2px solid var(--border);">
            <div style="font-weight:700;color:var(--brand);margin-bottom:12px;">üîß System</div>
            <div style="font-size:13px;line-height:1.8;">
              <strong>Version:</strong> v8.1 FIXED<br>
              <strong>WiFi:</strong> ${WIFI_SSID}<br>
              <strong>Status:</strong> <span style="color:#10b981;">‚úÖ Connected</span>
            </div>
          </div>
          
          <button onclick="clearCache()" style="padding:12px;border:none;border-radius:8px;background:var(--bad);color:white;font-weight:700;cursor:pointer;">
            üóëÔ∏è Clear Cache & Reload
          </button>
        </div>
      `;
    }

    window.clearCache = function() {
      if (confirm('Clear all cached data and reload?')) {
        localStorage.clear();
        location.reload();
      }
    };

    // ===== TAB SWITCHING =====
    document.querySelectorAll('.main-tabs button').forEach(btn => {
      btn.addEventListener('click', (e) => {
        document.querySelectorAll('.main-tabs button').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        
        document.querySelectorAll('[id^="section"]').forEach(s => s.classList.add('hidden'));
        
        if (e.target.id === 'tabAttendance') document.getElementById('sectionAttendance')?.classList.remove('hidden');
        if (e.target.id === 'tabReports') document.getElementById('sectionReports')?.classList.remove('hidden');
        if (e.target.id === 'tabSummary') {
          document.getElementById('sectionSummary')?.classList.remove('hidden');
          updateSummary();
        }
        if (e.target.id === 'tabSystemInfo') {
          document.getElementById('sectionSystemInfo')?.classList.remove('hidden');
          updateSystemInfo();
        }
      });
    });

    document.querySelectorAll('.sub-tabs button').forEach(btn => {
      btn.addEventListener('click', (e) => {
        document.querySelectorAll('.sub-tabs button').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        
        document.querySelectorAll('[id^="subSection"]').forEach(s => s.classList.add('hidden'));
        
        if (e.target.id === 'subTabManual') document.getElementById('subSectionManual')?.classList.remove('hidden');
        if (e.target.id === 'subTabQR') document.getElementById('subSectionQR')?.classList.remove('hidden');
        if (e.target.id === 'subTabStudentInfo') document.getElementById('subSectionStudentInfo')?.classList.remove('hidden');
      });
    });

    // Auto-save on exit
    window.addEventListener('beforeunload', saveToLocalStorage);

    console.log('‚úÖ GPS Sheinwal v8.1 FIXED Ready');
  </script>
</body>
</html>