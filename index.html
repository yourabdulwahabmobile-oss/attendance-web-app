<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GPS Sheinwal - v8.3 TABLE ROZNAMCHA</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;500;600;700&display=swap');
    
    :root{
      --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --bg:#f8fafc; 
      --card:#ffffff; 
      --text:#1e293b; 
      --muted:#64748b;
      --brand:#6366f1; 
      --brand-hover:#4f46e5;
      --brand-light:#eef2ff;
      --ok:#10b981; 
      --warn:#f59e0b; 
      --bad:#ef4444;
      --border:#e2e8f0; 
      --shadow:0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
      --shadow-lg:0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
    }
    
    * { box-sizing: border-box; margin:0; padding:0; }
    
    html,body{
      min-height:100%;
      background:var(--bg);
      color:var(--text);
      font-family:'Inter',system-ui,-apple-system,sans-serif;
      line-height:1.6;
    }

    header{
      position:sticky;
      top:0;
      z-index:50;
      background:var(--bg-gradient);
      color:#fff;
      text-align:center;
      padding:16px;
      box-shadow:var(--shadow-lg);
    }
    
    .school-name{
      font-size:clamp(18px, 4vw, 24px);
      font-weight:800;
      margin-bottom:4px;
      text-shadow:0 2px 4px rgba(0,0,0,0.1);
      letter-spacing:-0.5px;
    }
    
    .bar h1{
      font-size:clamp(14px, 3.5vw, 18px);
      margin:0;
      font-weight:600;
      letter-spacing:0.5px;
      opacity:0.95;
    }

    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:12px;
    }

    .card{
      background:var(--card);
      border-radius:16px;
      box-shadow:var(--shadow-lg);
      padding:20px;
      border:1px solid var(--border);
      margin-bottom:16px;
    }

    .main-tabs{
      display:grid;
      grid-template-columns:repeat(2, 1fr);
      gap:10px;
      margin-bottom:16px;
    }
    
    .main-tabs button{
      padding:14px 10px;
      border-radius:12px;
      border:2px solid transparent;
      background:var(--card);
      cursor:pointer;
      font-weight:700;
      font-size:14px;
      transition:all 0.3s;
      box-shadow:var(--shadow);
      color:var(--text);
    }
    
    .main-tabs button:hover{
      transform:translateY(-2px);
      box-shadow:0 8px 16px -4px rgba(99,102,241,0.3);
    }
    
    .main-tabs button.active{
      background:var(--bg-gradient);
      color:#fff;
      box-shadow:0 8px 16px -4px rgba(99,102,241,0.5);
    }

    .sub-tabs{
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:8px;
      margin-bottom:16px;
      background:var(--brand-light);
      padding:8px;
      border-radius:12px;
    }

    .sub-tabs button{
      padding:10px 8px;
      border-radius:8px;
      border:none;
      background:white;
      cursor:pointer;
      font-weight:600;
      font-size:12px;
      transition:all 0.3s;
      color:var(--text);
    }

    .sub-tabs button.active{
      background:var(--brand);
      color:white;
      box-shadow:0 4px 8px rgba(99,102,241,0.3);
    }

    .toolbar{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
      margin-bottom:16px;
    }
    
    .label-text{
      font-weight:600;
      font-size:12px;
      color:var(--text);
      margin-bottom:6px;
      display:block;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    
    input[type="text"],input[type="password"],input[type="number"],input[type="tel"],select{
      padding:12px 14px;
      border-radius:10px;
      border:2px solid var(--border);
      font-size:14px;
      width:100%;
      transition:all 0.2s;
      background:var(--card);
      font-family:inherit;
    }
    
    input:focus,select:focus{
      outline:none;
      border-color:var(--brand);
      box-shadow:0 0 0 3px var(--brand-light);
    }

    .select-all-bar{
      background:var(--brand-light);
      border:2px solid var(--brand);
      border-radius:10px;
      padding:14px 16px;
      margin-bottom:12px;
      display:flex;
      align-items:center;
      gap:10px;
    }

    .select-all-bar input[type="checkbox"]{
      width:20px;
      height:20px;
      cursor:pointer;
    }

    .select-all-bar label{
      font-weight:700;
      font-size:14px;
      color:var(--brand);
      cursor:pointer;
      flex:1;
    }

    .selected-count{
      background:var(--brand);
      color:white;
      padding:4px 12px;
      border-radius:16px;
      font-weight:700;
      font-size:12px;
    }

    .class-total-badge{
      background:var(--ok);
      color:white;
      padding:6px 14px;
      border-radius:20px;
      font-weight:700;
      font-size:13px;
      margin-bottom:12px;
      display:inline-block;
    }

    .list{
      background:var(--card);
      border:2px solid var(--border);
      border-radius:12px;
      overflow:hidden;
      margin-bottom:80px;
      box-shadow:var(--shadow);
      max-height: 60vh;
      overflow-y: auto;
    }
    
    .row-item{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 14px;
      border-top:1px solid var(--border);
      transition:all 0.2s;
      gap:10px;
    }
    
    .row-item:first-child{border-top:none}
    
    .row-item:hover{
      background:var(--brand-light);
    }

    .row-item.selected{
      background:#d1fae5;
    }
    
    .student-info{
      flex:1;
      min-width:0;
    }

    .name{
      font-weight:700;
      font-size:14px;
      color:var(--text);
      margin-bottom:2px;
    }
    
    .meta{
      font-size:11px;
      color:var(--muted);
      font-weight:500;
    }

    .student-checkbox{
      width:20px;
      height:20px;
      cursor:pointer;
      flex-shrink:0;
    }

    .fab{
      position:fixed;
      bottom:16px;
      left:50%;
      transform:translateX(-50%);
      z-index:100;
      width:calc(100% - 24px);
      max-width:400px;
    }
    
    .fab button{
      width:100%;
      padding:14px 24px;
      border-radius:50px;
      font-size:15px;
      font-weight:700;
      background:var(--bg-gradient);
      color:#fff;
      border:none;
      box-shadow:0 10px 25px -5px rgba(99,102,241,0.5);
      cursor:pointer;
      transition:all 0.3s;
    }
    
    .fab button:hover{
      transform:translateY(-3px);
      box-shadow:0 15px 30px -5px rgba(99,102,241,0.6);
    }

    .fab button:disabled{
      opacity:0.6;
      cursor:not-allowed;
    }

    .upload-toast{
      position:fixed;
      top:80px;
      right:12px;
      background:white;
      border:2px solid var(--brand);
      border-radius:12px;
      padding:16px;
      box-shadow:var(--shadow-lg);
      z-index:90;
      min-width:280px;
      animation:slideIn 0.3s ease;
    }

    .error-banner{
      background:linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color:white;
      padding:20px;
      border-radius:12px;
      margin:16px 0;
      box-shadow:0 8px 16px rgba(239,68,68,0.3);
    }

    .success-banner{
      background:linear-gradient(135deg, #10b981 0%, #059669 100%);
      color:white;
      padding:20px;
      border-radius:12px;
      margin:16px 0;
      box-shadow:0 8px 16px rgba(16,185,129,0.3);
    }

    @keyframes slideIn{
      from{transform:translateX(400px);opacity:0;}
      to{transform:translateX(0);opacity:1;}
    }

    .upload-progress-bar{
      width:100%;
      height:8px;
      background:var(--border);
      border-radius:4px;
      overflow:hidden;
      margin:10px 0;
    }

    .upload-progress-fill{
      height:100%;
      background:var(--brand);
      transition:width 0.3s;
    }

    .hidden{display:none!important}

    .login-container {
      text-align:center;
      max-width:400px;
      margin:40px auto;
    }
    
    .login-icon {
      width:70px;
      height:70px;
      margin:0 auto 16px;
      background:var(--bg-gradient);
      border-radius:16px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:36px;
      box-shadow:var(--shadow-lg);
    }

    .btn-primary{
      padding:10px 20px;
      border-radius:8px;
      border:none;
      background:var(--brand);
      color:white;
      font-weight:700;
      font-size:13px;
      cursor:pointer;
      transition:all 0.3s;
    }

    .btn-primary:hover{
      background:var(--brand-hover);
      transform:translateY(-2px);
    }

    .btn-success{
      background:var(--ok);
    }

    .btn-danger{
      background:var(--bad);
    }

    .loading-spinner {
      border: 4px solid var(--border);
      border-top: 4px solid var(--brand);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .autocomplete-container {
      position: relative;
    }

    .autocomplete-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 3px solid var(--brand);
      border-top: none;
      border-radius: 0 0 16px 16px;
      max-height: 400px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 15px 35px -5px rgba(99,102,241,0.4);
      display: none;
    }

    .autocomplete-dropdown.show {
      display: block;
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .autocomplete-item {
      padding: 16px 16px;
      cursor: pointer;
      border-bottom: 2px solid #f1f5f9;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 14px;
      background: white;
    }

    .autocomplete-item:last-child {
      border-bottom: none;
      border-radius: 0 0 14px 14px;
    }

    .autocomplete-item:hover {
      background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
      transform: translateX(5px);
      box-shadow: inset 4px 0 0 var(--brand);
    }

    .autocomplete-item-avatar {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      flex-shrink: 0;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .autocomplete-item-avatar.male {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }

    .autocomplete-item-avatar.female {
      background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
    }

    .autocomplete-item-info {
      flex: 1;
      min-width: 0;
    }

    .autocomplete-item-name {
      font-weight: 700;
      font-size: 15px;
      color: var(--text);
      margin-bottom: 6px;
      line-height: 1.2;
    }

    .autocomplete-item-meta {
      font-size: 12px;
      color: var(--muted);
      font-weight: 600;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .autocomplete-item-badge {
      background: var(--brand-light);
      color: var(--brand);
      padding: 3px 8px;
      border-radius: 6px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .autocomplete-empty {
      padding: 30px 20px;
      text-align: center;
      color: var(--muted);
      font-size: 14px;
      font-weight: 600;
    }

    .autocomplete-empty::before {
      content: "üîç";
      display: block;
      font-size: 40px;
      margin-bottom: 10px;
      opacity: 0.5;
    }

    .student-detail-card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-top: 16px;
      box-shadow: var(--shadow);
      border: 2px solid var(--brand);
    }

    .student-detail-row {
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
      font-size: 12px;
      line-height: 1.5;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .student-detail-row:last-child {
      border-bottom: none;
    }

    .student-detail-label {
      font-weight: 700;
      color: var(--text);
      min-width: 100px;
    }

    .student-detail-value {
      flex: 1;
      color: var(--muted);
    }

    .mobile-edit-container {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
    }

    .mobile-edit-input {
      flex: 1;
      padding: 6px 10px;
      border-radius: 6px;
      border: 2px solid var(--brand);
      font-size: 12px;
    }

    .btn-small {
      padding: 6px 12px;
      border-radius: 6px;
      border: none;
      font-weight: 700;
      font-size: 11px;
      cursor:pointer;
      transition: all 0.2s;
    }

    .btn-edit {
      background: var(--brand);
      color: white;
    }

    .btn-save {
      background: var(--ok);
      color: white;
    }

    .btn-cancel {
      background: var(--muted);
      color: white;
    }

    /* SYSTEM TAB STYLES */
    .system-section-card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
      border: 1px solid var(--border);
      transition: all 0.3s;
    }

    .system-section-card:hover {
      box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
      transform: translateY(-2px);
    }

    .system-section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid var(--brand);
    }

    .system-section-icon {
      width: 48px;
      height: 48px;
      background: var(--bg-gradient);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0 4px 6px rgba(99,102,241,0.3);
    }

    .system-section-title {
      flex: 1;
    }

    .system-section-title h3 {
      font-size: 18px;
      font-weight: 800;
      color: var(--text);
      margin-bottom: 4px;
    }

    .system-section-title p {
      font-size: 12px;
      color: var(--muted);
      font-weight: 500;
    }

    .system-info-grid {
      display: grid;
      gap: 12px;
    }

    .system-info-item {
      background: var(--brand-light);
      border-radius: 10px;
      padding: 14px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      transition: all 0.2s;
    }

    .system-info-item:hover {
      background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
      transform: translateX(3px);
    }

    .system-info-item-icon {
      font-size: 20px;
      min-width: 24px;
      text-align: center;
    }

    .system-info-item-content {
      flex: 1;
      min-width: 0;
    }

    .system-info-item-label {
      font-size: 11px;
      font-weight: 700;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .system-info-item-value {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      word-break: break-word;
    }

    .system-status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      background: #d1fae5;
      color: #059669;
    }

    .system-status-badge.error {
      background: #fee2e2;
      color: #dc2626;
    }

    .software-link-item {
      background: white;
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      transition: all 0.3s;
    }

    .software-link-item:hover {
      border-color: var(--brand);
      box-shadow: 0 4px 12px rgba(99,102,241,0.15);
    }

    .software-link-icon {
      width: 40px;
      height: 40px;
      background: var(--bg-gradient);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
    }

    .software-link-content {
      flex: 1;
      min-width: 0;
    }

    .software-link-label {
      font-size: 12px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .software-link-value {
      font-size: 11px;
      color: var(--muted);
      font-family: monospace;
      word-break: break-all;
      line-height: 1.4;
    }

    .btn-copy {
      padding: 8px 16px;
      border-radius: 8px;
      border: 2px solid var(--brand);
      background: white;
      color: var(--brand);
      font-weight: 700;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
      flex-shrink: 0;
    }

    .btn-copy:hover {
      background: var(--brand);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(99,102,241,0.3);
    }

    .btn-copy:active {
      transform: scale(0.95);
    }

    .btn-copy.copied {
      background: var(--ok);
      border-color: var(--ok);
      color: white;
    }

    .copy-toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--ok);
      color: white;
      padding: 12px 24px;
      border-radius: 30px;
      font-weight: 700;
      font-size: 14px;
      box-shadow: 0 10px 25px rgba(16,185,129,0.3);
      z-index: 1000;
      animation: slideUp 0.3s ease;
      display: none;
    }

    .copy-toast.show {
      display: block;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translate(-50%, 20px); }
      to { opacity: 1; transform: translate(-50%, 0); }
    }

    /* ROZNAMCHA TABLE STYLES */
    .roznamcha-wrapper {
      background: white;
      border-radius: 16px;
      box-shadow: var(--shadow-lg);
      overflow: hidden;
      border: 2px solid #333;
      margin-bottom: 20px;
    }

    .roznamcha-title-bar {
      background: white;
      color: #000;
      padding: 16px;
      text-align: center;
      font-family: 'Noto Nastaliq Urdu', serif;
      font-size: 20px;
      font-weight: 700;
      direction: rtl;
      border-bottom: 2px solid #333;
    }

    .roznamcha-refresh-info {
      background: var(--brand-light);
      padding: 8px;
      text-align: center;
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      border-bottom: 2px solid #333;
    }

    .refresh-indicator {
      width: 6px;
      height: 6px;
      background: #10b981;
      border-radius: 50%;
      animation: pulse-dot 2s infinite;
    }

    @keyframes pulse-dot {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    .roznamcha-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      background: white;
    }

    .roznamcha-table th,
    .roznamcha-table td {
      border: 2px solid #333;
      padding: 10px 6px;
      text-align: center;
      font-weight: 600;
    }

    .roznamcha-table .day-header {
      background: white;
      font-weight: 700;
      font-size: 18px;
      color: #dc2626;
    }

    .roznamcha-table .class-header {
      background: #444;
      color: white;
      font-weight: 700;
      text-transform: uppercase;
      font-size: 14px;
    }

    .roznamcha-table .section-header {
      background: white;
      color: #dc2626;
      font-weight: 700;
      font-family: 'Noto Nastaliq Urdu', serif;
      direction: rtl;
      font-size: 16px;
      padding: 12px 6px;
    }

    .roznamcha-table .sub-header {
      background: #666;
      color: white;
      font-weight: 700;
      font-size: 13px;
    }

    .roznamcha-table .class-name-cell {
      background: white;
      text-align: left;
      font-weight: 700;
      padding-left: 12px;
      font-size: 14px;
    }

    .roznamcha-table .class-name-urdu {
      color: #dc2626;
      font-family: 'Noto Nastaliq Urdu', serif;
      direction: rtl;
      font-size: 13px;
      font-weight: 600;
      display: block;
      margin-top: 2px;
    }

    .roznamcha-table .total-row {
      background: #444;
      color: white;
      font-weight: 700;
      font-size: 15px;
    }

    .roznamcha-table .data-cell {
      background: white;
      font-weight: 600;
      font-size: 15px;
    }

    .roznamcha-footer {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 0;
    }

    .roznamcha-footer-cell {
      padding: 14px;
      text-align: center;
      font-weight: 700;
      border-right: 2px solid #333;
      font-size: 15px;
      border-top: 2px solid #333;
    }

    .roznamcha-footer-cell:last-child {
      border-right: none;
    }

    .roznamcha-footer-date {
      background: white;
      font-size: 16px;
    }

    .roznamcha-footer-percent {
      background: white;
      color: #dc2626;
      font-size: 24px;
      font-weight: 800;
    }

    .roznamcha-footer-label {
      background: white;
      color: #dc2626;
      font-family: 'Noto Nastaliq Urdu', serif;
      direction: rtl;
      font-size: 16px;
    }

    .roznamcha-loading {
      text-align: center;
      padding: 60px 20px;
      background: white;
      border-radius: 16px;
    }

    .roznamcha-error {
      background: #fee2e2;
      border: 2px solid #ef4444;
      border-radius: 12px;
      padding: 24px;
      text-align: center;
      color: #dc2626;
    }

    .roznamcha-error h3 {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    @media (min-width: 768px) {
      .wrap { padding:20px; }
      .toolbar { grid-template-columns:1fr 1fr; }
      .main-tabs { grid-template-columns:repeat(4, 1fr); }
      .system-info-grid { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 767px) {
      .upload-toast { right:12px; left:12px; min-width:unset; }
      .software-link-item { flex-direction: column; align-items: stretch; }
      .btn-copy { width: 100%; justify-content: center; }
      .roznamcha-table { font-size: 11px; }
      .roznamcha-table th, .roznamcha-table td { padding: 6px 3px; }
      .roznamcha-title-bar { font-size: 16px; padding: 12px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="school-name">üéì GPS Sheinwal (Shamaskay)</div>
    <div class="bar"><h1>RFID Attendance Management System v8.3 TABLE ROZNAMCHA</h1></div>
  </header>
  
  <div class="wrap">
    <!-- LOGIN VIEW -->
    <section id="viewLogin" class="card login-container">
      <div class="login-icon">üîê</div>
      <div style="font-size:24px;font-weight:800;margin-bottom:6px;color:var(--text);">Secure Login</div>
      <div style="color:var(--muted);margin-bottom:20px;font-size:14px;">Enter your password to continue</div>
      <div id="loginDateTime" style="color:var(--muted);margin-bottom:16px;font-size:12px;"></div>
      <input id="pinInput" type="password" inputmode="numeric" maxlength="20" placeholder="Enter Password" 
        style="width:90%;padding:12px 18px;text-align:center;letter-spacing:3px;margin-bottom:16px;font-size:16px;" />
      <button id="loginBtn" style="padding:12px 36px;border:none;border-radius:10px;background:var(--bg-gradient);
        color:white;font-size:15px;font-weight:700;cursor:pointer;box-shadow:0 4px 12px rgba(99,102,241,0.4);transition:all 0.3s;">
        Login ‚Üí
      </button>
      <div id="loginError" style="margin-top:14px;color:var(--bad);font-weight:600;font-size:13px;"></div>
    </section>

    <!-- MAIN VIEW -->
    <section id="viewMain" class="hidden">
      <!-- Data Load Status -->
      <div id="dataLoadStatus"></div>

      <!-- Main Tabs -->
      <div class="main-tabs">
        <button id="tabAttendance" class="active">üìã Attendance</button>
        <button id="tabReports">üìÑ Reports</button>
        <button id="tabRoznamcha">üìä Roznamcha</button>
        <button id="tabSystemInfo">üîß System</button>
      </div>

      <!-- ATTENDANCE SECTION -->
      <div id="sectionAttendance">
        <!-- Sub Tabs -->
        <div class="sub-tabs">
          <button id="subTabManual" class="active">‚úçÔ∏è Manual</button>
          <button id="subTabQR">üì∑ QR Scan</button>
          <button id="subTabStudentInfo">üë§ Student Info</button>
        </div>

        <!-- Manual Attendance -->
        <div id="subSectionManual">
          <div class="toolbar">
            <div>
              <span class="label-text">üìö Select Class</span>
              <select id="classSelect">
                <option value="">All Classes</option>
              </select>
            </div>
            <div>
              <span class="label-text">üîç Search Student</span>
              <input type="text" id="searchInput" placeholder="Search by name, father name or enrollment..." />
            </div>
          </div>

          <div id="classTotalBadge"></div>

          <div class="select-all-bar">
            <input type="checkbox" id="selectAllCheckbox" />
            <label for="selectAllCheckbox">Select All (Present)</label>
            <span class="selected-count" id="selectedCount">0 Selected</span>
          </div>

          <div id="studentList" class="list"></div>
          
          <div class="fab" id="submitFab">
            <button id="submitBtn">‚úì Submit Attendance</button>
          </div>
        </div>

        <!-- QR Scan -->
        <div id="subSectionQR" class="hidden">
          <div class="card" style="text-align:center;padding:60px 20px;">
            <div style="font-size:48px;margin-bottom:16px;">üì∑</div>
            <h3 style="color:var(--brand);margin-bottom:12px;">QR Code Scanner</h3>
            <p style="color:var(--muted);font-size:14px;">QR Code attendance scanning feature coming soon...</p>
          </div>
        </div>

        <!-- Student Information -->
        <div id="subSectionStudentInfo" class="hidden">
          <div class="toolbar">
            <div>
              <span class="label-text">üîç Search Student</span>
              <div class="autocomplete-container">
                <input type="text" id="singleStudentSearch" placeholder="Enter UID, Name, Father Name or Enrollment..." />
                <div id="studentSearchDropdown" class="autocomplete-dropdown"></div>
              </div>
            </div>
          </div>
          <div id="studentDetailResult"></div>
        </div>
      </div>

      <!-- REPORTS SECTION -->
      <div id="sectionReports" class="hidden">
        <div class="card">
          <h3 style="color:var(--brand);margin-bottom:16px;font-size:18px;">üìÑ Download Reports (CSV Format)</h3>
          <p style="color:var(--muted);margin-bottom:20px;font-size:14px;">Download attendance and student data files in CSV format</p>
          
          <a href="https://docs.google.com/spreadsheets/d/1woOwa-1ydra43sLalpjGB4x-1ZjeE_rWSy9LDvGBpJA/export?format=csv&gid=493301113" 
             class="btn-primary" style="display:block;text-align:center;padding:14px;text-decoration:none;margin-bottom:10px;" target="_blank" download="Student_Data.csv">
            üìä Download Student Data File (CSV)
          </a>
          
          <a href="https://docs.google.com/spreadsheets/d/1woOwa-1ydra43sLalpjGB4x-1ZjeE_rWSy9LDvGBpJA/export?format=csv&gid=0" 
             class="btn-primary" style="display:block;text-align:center;padding:14px;text-decoration:none;margin-bottom:10px;" target="_blank" download="Attendance_Data.csv">
            üìù Download Attendance File (CSV)
          </a>
        </div>
      </div>

      <!-- ROZNAMCHA SECTION -->
      <div id="sectionRoznamcha" class="hidden">
        <div id="roznamchaContent">
          <div class="roznamcha-loading">
            <div class="loading-spinner"></div>
            <p style="margin-top:16px;color:var(--muted);font-weight:600;">Loading Roznamcha data...</p>
          </div>
        </div>
      </div>

      <!-- SYSTEM INFO SECTION -->
      <div id="sectionSystemInfo" class="hidden">
        <div id="systemInfoContent"></div>
      </div>
    </section>
  </div>

  <!-- Copy Toast Notification -->
  <div id="copyToast" class="copy-toast">‚úÖ Copied to clipboard!</div>

  <script>
    // ===== CONFIGURATION =====
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbybmrRsGDW-hzLajZ08f4GL4cv4QzmTZbX3IsQnrZFB2jAO87Wak---V0gW9NTTJ2VR6w/exec";
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTYhSsnnY8WKnRs-d-oeFjLT1ZhlE8RAb8EyUOUj8NfWzEI2bCha5SdcVWBfcD8z2cUm1DiiLpemKXf/pub?gid=493301113&single=true&output=csv";
    const SHEET_ID = "1woOwa-1ydra43sLalpjGB4x-1ZjeE_rWSy9LDvGBpJA";
    const SHEET_LINK = "https://docs.google.com/spreadsheets/d/1woOwa-1ydra43sLalpjGB4x-1ZjeE_rWSy9LDvGBpJA/edit?gid=1613514927#gid=1613514927";
    const DEPLOYMENT_LINK = "https://script.google.com/macros/s/AKfycbzrNDIwQ8tQtYG_D36FTJRxgRbiz-4LF7CoytLbkoWIvLPxtismV7AKDrgu6o2uKtiz0g/exec";
    const PIN = "39310242";
    const WIFI_SSID = "Mirza Gee 2";
    const IP_ADDRESS = "192.168.10.43";
    const MAC_ADDRESS = "EC:E3:34:21:06:C0";
    const SCANNER_MODEL = "MFRC522";
    const FIRMWARE_VERSION = "v2.10";
    const SCRIPT_VERSION = "v8.3 TABLE ROZNAMCHA";
    const MAX_RETRY_ATTEMPTS = 5;
    const RETRY_DELAY = 3000;
    const ROZNAMCHA_REFRESH_INTERVAL = 5 * 60 * 1000; // 5 minutes
    
    // ===== GLOBAL STATE =====
    let g_students = [];
    let g_filteredStudents = [];
    let g_selectedUIDs = new Set();
    let g_todayAttendance = {};
    let g_allAttendance = {};
    let g_sessionStats = {
      totalUploaded: 0,
      totalDuplicate: 0,
      totalFailed: 0,
      totalScanned: 0,
      queueSize: 0
    };
    let g_autoSyncInterval = null;
    let g_pendingUploads = [];
    let g_dataLoadStatus = 'loading';
    let g_retryCount = 0;
    let g_roznamchaInterval = null;
    let g_roznamchaData = null;

    // Class name mappings
    const CLASS_NAMES_URDU = {
      'Kachi': 'ÿßŸàŸÑ ÿßÿ®ÿ™ÿØÿßÿ¶€å',
      'KG': 'ÿßŸàŸÑ ÿßÿ®ÿ™ÿØÿßÿ¶€å',
      'Nursery': 'ÿßŸàŸÑ ÿßÿ®ÿ™ÿØÿßÿ¶€å',
      '1': 'ÿßŸàŸÑ ÿßÿµŸÑ€å',
      'One': 'ÿßŸàŸÑ ÿßÿµŸÑ€å',
      '2': 'ÿØŸàÿ¶ŸÖ',
      'Two': 'ÿØŸàÿ¶ŸÖ',
      '3': 'ÿ≥Ÿàÿ¶ŸÖ',
      'Three': 'ÿ≥Ÿàÿ¶ŸÖ',
      '4': '⁄Ü€Åÿßÿ±ŸÖ',
      'Four': '⁄Ü€Åÿßÿ±ŸÖ',
      '5': 'ŸæŸÜÿ¨ŸÖ',
      'Five': 'ŸæŸÜÿ¨ŸÖ',
      '6': 'ÿ¥ÿ¥ŸÖ',
      'Six': 'ÿ¥ÿ¥ŸÖ',
      '7': '€ÅŸÅÿ™ŸÖ',
      'Seven': '€ÅŸÅÿ™ŸÖ',
      '8': '€Åÿ¥ÿ™ŸÖ',
      'Eight': '€Åÿ¥ÿ™ŸÖ'
    };

    // ===== CSV LOADING =====
    async function loadAllStudentsFast(retryAttempt = 0) {
      try {
        console.log(`üì• Loading students from CSV (Attempt ${retryAttempt + 1}/${MAX_RETRY_ATTEMPTS})...`);
        
        showLoadingStatus(`Loading student data... (Attempt ${retryAttempt + 1}/${MAX_RETRY_ATTEMPTS})`);
        
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 15000);
        
        const response = await fetch(CSV_URL, {
          method: 'GET',
          cache: 'no-cache',
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const csvText = await response.text();
        
        if (!csvText || csvText.trim().length === 0) {
          throw new Error('Empty CSV file received');
        }
        
        const lines = csvText.split('\n');
        
        if (lines.length < 2) {
          throw new Error('CSV file has no data rows');
        }
        
        g_students = [];
        
        for (let i = 1; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;
          
          const cols = parseCSVLine(line);
          if (cols.length < 11) continue;
          
          const student = {
            uid: cols[0] || '',
            srNo: cols[1] || '',
            enrollment: cols[2] || '',
            name: cols[3] || '',
            gender: cols[4] || '',
            dob: cols[5] || '',
            age: cols[6] || '',
            admission: cols[7] || '',
            father: cols[8] || '',
            bform: cols[9] || '',
            class: cols[10] || '',
            mobile: cols[11] || '',
            identifier: cols[2] || cols[3]
          };
          
          g_students.push(student);
        }
        
        if (g_students.length === 0) {
          throw new Error('No students parsed from CSV');
        }
        
        console.log(`‚úÖ Successfully loaded ${g_students.length} students from CSV`);
        g_dataLoadStatus = 'success';
        g_retryCount = 0;
        
        showSuccessStatus(`‚úÖ Real-time data loaded: ${g_students.length} students`);
        
        populateClassDropdown();
        filterAndRender();
        updateSystemInfo();
        
      } catch (error) {
        console.error(`‚ùå CSV loading failed (Attempt ${retryAttempt + 1}):`, error);
        
        g_retryCount = retryAttempt + 1;
        
        if (retryAttempt < MAX_RETRY_ATTEMPTS - 1) {
          showErrorStatus(`‚ö†Ô∏è Connection failed. Retrying in ${RETRY_DELAY/1000} seconds... (${retryAttempt + 1}/${MAX_RETRY_ATTEMPTS})`);
          
          setTimeout(() => {
            loadAllStudentsFast(retryAttempt + 1);
          }, RETRY_DELAY);
        } else {
          g_dataLoadStatus = 'error';
          showCriticalError(error);
        }
      }
    }

    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      
      result.push(current.trim());
      return result;
    }

    function showLoadingStatus(message) {
      const container = document.getElementById('dataLoadStatus');
      if (!container) return;
      
      container.innerHTML = `
        <div class="card" style="background:linear-gradient(135deg, #667eea15 0%, #764ba215 100%);border:2px solid var(--brand);">
          <div style="display:flex;align-items:center;gap:12px;">
            <div class="loading-spinner" style="margin:0;"></div>
            <div style="flex:1;">
              <div style="font-weight:700;font-size:14px;color:var(--brand);margin-bottom:4px;">Loading Data...</div>
              <div style="font-size:12px;color:var(--muted);">${message}</div>
            </div>
          </div>
        </div>
      `;
    }

    function showSuccessStatus(message) {
      const container = document.getElementById('dataLoadStatus');
      if (!container) return;
      
      container.innerHTML = `
        <div class="success-banner">
          <div style="display:flex;align-items:center;gap:12px;">
            <div style="font-size:32px;">‚úÖ</div>
            <div style="flex:1;">
              <div style="font-weight:800;font-size:16px;margin-bottom:4px;">System Online - Ready for Bulk Upload!</div>
              <div style="font-size:13px;opacity:0.95;">${message}</div>
            </div>
          </div>
        </div>
      `;
      
      setTimeout(() => {
        if (container) container.innerHTML = '';
      }, 5000);
    }

    function showErrorStatus(message) {
      const container = document.getElementById('dataLoadStatus');
      if (!container) return;
      
      container.innerHTML = `
        <div class="card" style="background:linear-gradient(135deg, #fef3c7 0%, #fed7aa 100%);border:2px solid #f59e0b;">
          <div style="display:flex;align-items:center;gap:12px;">
            <div style="font-size:32px;">‚ö†Ô∏è</div>
            <div style="flex:1;">
              <div style="font-weight:700;font-size:14px;color:#d97706;margin-bottom:4px;">Connection Issue</div>
              <div style="font-size:12px;color:#92400e;">${message}</div>
            </div>
          </div>
        </div>
      `;
    }

    function showCriticalError(error) {
      const container = document.getElementById('dataLoadStatus');
      if (!container) return;
      
      const errorDetails = error.message || 'Unknown error';
      
      container.innerHTML = `
        <div class="error-banner">
          <div style="display:flex;align-items:flex-start;gap:12px;">
            <div style="font-size:40px;">‚ùå</div>
            <div style="flex:1;">
              <div style="font-weight:800;font-size:18px;margin-bottom:8px;">Unable to Load Real-Time Data</div>
              <div style="font-size:13px;opacity:0.95;margin-bottom:12px;">
                Failed to connect to Google Sheets after ${MAX_RETRY_ATTEMPTS} attempts.
              </div>
              <div style="background:rgba(255,255,255,0.2);padding:10px;border-radius:8px;margin-bottom:12px;font-family:monospace;font-size:11px;">
                Error: ${errorDetails}
              </div>
              <button onclick="location.reload()" class="btn-primary" style="background:white;color:#dc2626;padding:12px 24px;font-size:14px;">
                üîÑ Retry Connection
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('classSelect').disabled = true;
      document.getElementById('searchInput').disabled = true;
      document.getElementById('selectAllCheckbox').disabled = true;
      document.getElementById('submitBtn').disabled = true;
    }

    function populateClassDropdown() {
      const select = document.getElementById('classSelect');
      if (!select) return;
      
      const classSet = new Set();
      g_students.forEach(s => {
        if (s.class && s.class.trim()) {
          classSet.add(s.class.trim());
        }
      });
      
      const classes = Array.from(classSet).sort((a, b) => {
        if (a.toLowerCase() === 'nursery' || a.toLowerCase() === 'kachi') return -1;
        if (b.toLowerCase() === 'nursery' || b.toLowerCase() === 'kachi') return 1;
        const aNum = parseInt(a);
        const bNum = parseInt(b);
        if (!isNaN(aNum) && !isNaN(bNum)) return aNum - bNum;
        return a.localeCompare(b);
      });
      
      select.innerHTML = '<option value="">All Classes</option>';
      classes.forEach(cls => {
        const opt = document.createElement('option');
        opt.value = cls;
        opt.textContent = cls;
        select.appendChild(opt);
      });
    }

    function filterAndRender() {
      if (g_dataLoadStatus !== 'success') return;
      
      const classFilter = document.getElementById('classSelect')?.value || '';
      const searchText = document.getElementById('searchInput')?.value?.toLowerCase() || '';
      
      g_filteredStudents = g_students.filter(s => {
        const matchClass = !classFilter || s.class.trim() === classFilter.trim();
        const matchSearch = !searchText || 
          s.name.toLowerCase().includes(searchText) ||
          s.father.toLowerCase().includes(searchText) ||
          s.enrollment.toLowerCase().includes(searchText) ||
          (s.uid && s.uid.toLowerCase().includes(searchText));
        
        return matchClass && matchSearch;
      });
      
      const filteredIdentifiers = new Set(g_filteredStudents.map(s => s.identifier));
      g_selectedUIDs = new Set([...g_selectedUIDs].filter(id => filteredIdentifiers.has(id)));
      
      const badgeEl = document.getElementById('classTotalBadge');
      if (badgeEl) {
        if (classFilter) {
          badgeEl.innerHTML = `<div class="class-total-badge">üìö ${classFilter}: ${g_filteredStudents.length} Students</div>`;
        } else {
          badgeEl.innerHTML = '';
        }
      }
      
      renderStudentList();
      updateSelectAllCheckbox();
    }

    function renderStudentList() {
      const container = document.getElementById('studentList');
      if (!container) return;
      
      if (g_dataLoadStatus !== 'success') {
        container.innerHTML = '<div style="padding:40px;text-align:center;color:var(--muted);">Loading students...</div>';
        return;
      }
      
      container.innerHTML = '';
      
      if (g_filteredStudents.length === 0) {
        container.innerHTML = '<div style="padding:40px;text-align:center;color:var(--muted);">No students found</div>';
        return;
      }
      
      g_filteredStudents.forEach(student => {
        const identifier = student.identifier;
        const isMarked = g_todayAttendance[identifier] !== undefined;
        const status = g_todayAttendance[identifier];
        
        const div = document.createElement('div');
        div.className = 'row-item';
        
        if (isMarked) {
          div.style.background = status === 'present' ? '#d1fae5' : '#fee2e2';
        } else if (g_selectedUIDs.has(identifier)) {
          div.classList.add('selected');
        }
        
        div.innerHTML = `
          <div class="student-info">
            <div class="name">${student.name} ${isMarked ? (status === 'present' ? '‚úÖ' : '‚ùå') : ''}</div>
            <div class="meta">
              üë®‚Äçüëß ${student.father} | 
              üéì ${student.class} | 
              üÜî ${student.enrollment || student.uid || 'N/A'}
            </div>
          </div>
          ${isMarked ? 
            `<button class="btn-primary btn-${status === 'present' ? 'danger' : 'success'}" style="padding:8px 16px;font-size:12px;" onclick="editAttendance('${identifier}')">
              ${status === 'present' ? 'Mark Absent' : 'Mark Present'}
            </button>` :
            `<input type="checkbox" 
                   class="student-checkbox" 
                   data-identifier="${identifier}"
                   ${g_selectedUIDs.has(identifier) ? 'checked' : ''}>`
          }
        `;
        
        container.appendChild(div);
      });
      
      document.querySelectorAll('.student-checkbox').forEach(cb => {
        cb.addEventListener('change', handleCheckboxChange);
      });
      
      updateSelectedCount();
    }

    function editAttendance(identifier) {
      const currentStatus = g_todayAttendance[identifier];
      const newStatus = currentStatus === 'present' ? 'absent' : 'present';
      
      if (confirm(`Change attendance from ${currentStatus} to ${newStatus}?`)) {
        g_todayAttendance[identifier] = newStatus;
        saveToLocalStorage();
        renderStudentList();
        
        const student = g_students.find(s => s.identifier === identifier);
        if (student) {
          uploadSingleAttendance(student, newStatus);
        }
        
        // Refresh Roznamcha if loaded
        if (g_roznamchaData) {
          loadRoznamchaData();
        }
      }
    }

    function handleCheckboxChange(e) {
      const cb = e.target;
      const identifier = cb.dataset.identifier;
      
      if (cb.checked) {
        g_selectedUIDs.add(identifier);
        cb.closest('.row-item').classList.add('selected');
      } else {
        g_selectedUIDs.delete(identifier);
        cb.closest('.row-item').classList.remove('selected');
      }
      
      updateSelectedCount();
      updateSelectAllCheckbox();
      saveToLocalStorage();
    }

    document.getElementById('selectAllCheckbox')?.addEventListener('change', (e) => {
      const checked = e.target.checked;
      
      g_filteredStudents.forEach(s => {
        const id = s.identifier;
        if (!g_todayAttendance[id]) {
          if (checked) {
            g_selectedUIDs.add(id);
          } else {
            g_selectedUIDs.delete(id);
          }
        }
      });
      
      renderStudentList();
      saveToLocalStorage();
    });

    function updateSelectAllCheckbox() {
      const checkbox = document.getElementById('selectAllCheckbox');
      if (!checkbox) return;
      
      const unmarkedStudents = g_filteredStudents.filter(s => !g_todayAttendance[s.identifier]);
      const allSelected = unmarkedStudents.length > 0 && 
        unmarkedStudents.every(s => g_selectedUIDs.has(s.identifier));
      
      checkbox.checked = allSelected;
    }

    function updateSelectedCount() {
      const count = g_filteredStudents.filter(s => g_selectedUIDs.has(s.identifier)).length;
      document.getElementById('selectedCount').textContent = `${count} Selected`;
    }

    document.getElementById('submitBtn')?.addEventListener('click', submitAttendance);

    async function submitAttendance() {
      if (g_dataLoadStatus !== 'success') {
        alert('‚ùå Cannot submit: Student data not loaded!');
        return;
      }

      if (g_selectedUIDs.size === 0) {
        alert('‚ùå Please select at least one student!');
        return;
      }

      const selectedStudents = g_filteredStudents.filter(s => 
        g_selectedUIDs.has(s.identifier) && !g_todayAttendance[s.identifier]
      );

      if (selectedStudents.length === 0) {
        alert('‚ùå All selected students have already been marked!');
        return;
      }

      if (selectedStudents.length > 20) {
        const estimatedTime = Math.ceil(selectedStudents.length * 0.4);
        if (!confirm(`‚ö†Ô∏è You are about to mark ${selectedStudents.length} students present.\n\nThis will take about ${estimatedTime} seconds.\n\nContinue?`)) {
          return;
        }
      }

      g_pendingUploads.push(...selectedStudents);
      saveToLocalStorage();

      const total = selectedStudents.length;
      let success = 0, duplicate = 0, failed = 0;
      let processed = 0;

      const btn = document.getElementById('submitBtn');
      btn.disabled = true;
      btn.textContent = `Starting upload...`;

      showUploadToast(0, total);

      const BATCH_SIZE = 5;
      
      for (let i = 0; i < selectedStudents.length; i += BATCH_SIZE) {
        const batch = selectedStudents.slice(i, i + BATCH_SIZE);
        
        const batchPromises = batch.map(async (student) => {
          try {
            const result = await uploadSingleAttendance(student, 'present');
            
            if (result.success) {
              success++;
              g_sessionStats.totalUploaded++;
              g_sessionStats.totalScanned++;
              g_todayAttendance[student.identifier] = 'present';
              g_allAttendance[student.identifier] = g_allAttendance[student.identifier] || [];
              g_allAttendance[student.identifier].push({date: new Date().toLocaleDateString(), status: 'present'});
              g_selectedUIDs.delete(student.identifier);
              g_pendingUploads = g_pendingUploads.filter(s => s.identifier !== student.identifier);
              return 'success';
            } else if (result.alreadyMarked) {
              duplicate++;
              g_sessionStats.totalDuplicate++;
              g_todayAttendance[student.identifier] = 'present';
              g_selectedUIDs.delete(student.identifier);
              g_pendingUploads = g_pendingUploads.filter(s => s.identifier !== student.identifier);
              return 'duplicate';
            } else {
              failed++;
              g_sessionStats.totalFailed++;
              return 'failed';
            }
          } catch (error) {
            console.error('‚ùå Upload error:', error);
            failed++;
            g_sessionStats.totalFailed++;
            return 'error';
          }
        });
        
        await Promise.all(batchPromises);
        
        processed = Math.min(i + BATCH_SIZE, total);
        btn.textContent = `Uploading ${processed}/${total}...`;
        updateUploadToast(processed, total, success, duplicate, failed);
        
        if (i + BATCH_SIZE < selectedStudents.length) {
          await new Promise(r => setTimeout(r, 300));
        }
      }

      g_sessionStats.queueSize = g_pendingUploads.length;

      btn.disabled = false;
      btn.textContent = '‚úì Submit Attendance';
      hideUploadToast();

      saveToLocalStorage();
      renderStudentList();
      updateSystemInfo();
      
      // Refresh Roznamcha if it's loaded
      if (g_roznamchaData) {
        loadRoznamchaData();
      }

      const message = `üìä Upload Complete!\n\n‚úÖ Success: ${success}\n‚ö†Ô∏è Duplicate: ${duplicate}\n‚ùå Failed: ${failed}\n\nTotal Processed: ${processed}/${total}`;
      alert(message);
    }

    async function uploadSingleAttendance(student, status) {
      let url = `${SCRIPT_URL}?action=insert&status=${status}`;
      
      if (student.enrollment) {
        url += `&enrollment=${encodeURIComponent(student.enrollment)}`;
      }
      
      url += `&name=${encodeURIComponent(student.name)}`;
      url += `&father=${encodeURIComponent(student.father)}`;
      
      if (student.uid) {
        url += `&uid=${encodeURIComponent(student.uid)}`;
      }
      
      console.log(`üì§ Uploading: ${student.name} - ${status}`);
      
      const response = await fetch(url, { method: 'GET' });
      const result = await response.json();
      
      console.log(`üì• Response:`, result);
      return result;
    }

    async function processPendingUploads() {
      if (g_pendingUploads.length === 0) return;
      
      console.log(`üîÑ Processing ${g_pendingUploads.length} pending uploads...`);
      
      const uploads = [...g_pendingUploads];
      
      for (const student of uploads) {
        try {
          const result = await uploadSingleAttendance(student, 'present');
          if (result.success || result.alreadyMarked) {
            g_pendingUploads = g_pendingUploads.filter(s => s.identifier !== student.identifier);
            g_todayAttendance[student.identifier] = 'present';
          }
        } catch (error) {
          console.error('Background upload failed:', error);
        }
      }
      
      g_sessionStats.queueSize = g_pendingUploads.length;
      saveToLocalStorage();
      console.log(`‚úÖ Background uploads complete. ${g_pendingUploads.length} remaining.`);
    }

    document.getElementById('searchInput')?.addEventListener('input', (e) => {
      filterAndRender();
    });

    // ===== STUDENT INFO SEARCH =====
    const studentSearchInput = document.getElementById('singleStudentSearch');
    const studentSearchDropdown = document.getElementById('studentSearchDropdown');
    
    studentSearchInput?.addEventListener('input', (e) => {
      const searchText = e.target.value.trim().toLowerCase();
      
      if (!searchText || searchText.length < 2) {
        studentSearchDropdown.classList.remove('show');
        return;
      }
      
      if (g_dataLoadStatus !== 'success' || g_students.length === 0) {
        studentSearchDropdown.innerHTML = '<div class="autocomplete-empty">No student data loaded</div>';
        studentSearchDropdown.classList.add('show');
        return;
      }
      
      const matchedStudents = g_students.filter(s => {
        return s.name.toLowerCase().includes(searchText) ||
               s.father.toLowerCase().includes(searchText) ||
               s.enrollment.toLowerCase().includes(searchText) ||
               (s.uid && s.uid.toLowerCase().includes(searchText));
      }).slice(0, 10);
      
      if (matchedStudents.length === 0) {
        studentSearchDropdown.innerHTML = '<div class="autocomplete-empty">No students found</div>';
        studentSearchDropdown.classList.add('show');
        return;
      }
      
      studentSearchDropdown.innerHTML = matchedStudents.map(s => `
        <div class="autocomplete-item" onclick="showStudentDetails('${s.identifier}')">
          <div class="autocomplete-item-avatar ${s.gender.toLowerCase() === 'm' ? 'male' : 'female'}">
            ${s.gender === 'M' ? 'üë®‚Äçüéì' : 'üë©‚Äçüéì'}
          </div>
          <div class="autocomplete-item-info">
            <div class="autocomplete-item-name">${s.name}</div>
            <div class="autocomplete-item-meta">
              <span>üë®‚Äçüëß ${s.father}</span>
              <span class="autocomplete-item-badge">üéì ${s.class}</span>
              <span class="autocomplete-item-badge">üÜî ${s.enrollment || s.uid || 'N/A'}</span>
            </div>
          </div>
        </div>
      `).join('');
      
      studentSearchDropdown.classList.add('show');
    });
    
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.autocomplete-container')) {
        studentSearchDropdown?.classList.remove('show');
      }
    });
    
    function showStudentDetails(identifier) {
      const student = g_students.find(s => s.identifier === identifier);
      if (!student) return;
      
      studentSearchDropdown.classList.remove('show');
      studentSearchInput.value = student.name;
      
      const detailResult = document.getElementById('studentDetailResult');
      if (!detailResult) return;
      
      const attendanceStatus = g_todayAttendance[identifier];
      const currentDateTime = new Date().toLocaleString('en-GB', { 
        timeZone: 'Asia/Karachi',
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
      }).replace(',', ' -');
      
      detailResult.innerHTML = `
        <div class="student-detail-card">
          <div class="student-detail-row">
            <span class="student-detail-label">UID NO:</span>
            <span class="student-detail-value">${student.uid || 'N/A'}</span>
          </div>
          <div class="student-detail-row">
            <span class="student-detail-label">${student.gender === 'M' ? 'üë®‚Äçüéì' : 'üë©‚Äçüéì'} Student Name:</span>
            <span class="student-detail-value">>>> ${student.name.toUpperCase()} <<<</span>
          </div>
          <div class="student-detail-row">
            <span class="student-detail-label">üë®‚Äçüëß Father Name:</span>
            <span class="student-detail-value">(F) ${student.father.toUpperCase()}</span>
          </div>
          <div class="student-detail-row">
            <span class="student-detail-label">üöª Gender:</span>
            <span class="student-detail-value">${student.gender}</span>
          </div>
          <div class="student-detail-row">
            <span class="student-detail-label">üî¢ Sr No:</span>
            <span class="student-detail-value">${student.srNo || 'N/A'}</span>
          </div>
          <div class="student-detail-row">
            <span class="student-detail-label">üÜî Enrolment No:</span>
            <span class="student-detail-value">${student.enrollment || 'N/A'}</span>
          </div>
          <div class="student-detail-row">
            <span class="student-detail-label">üìÑ B-Form:</span>
            <span class="student-detail-value">${student.bform || 'N/A'}</span>
          </div>
          <div class="student-detail-row">
            <span class="student-detail-label">üéì Class:</span>
            <span class="student-detail-value">${student.class}</span>
          </div>
          <div class="student-detail-row">
            <span class="student-detail-label">üìû Mobile No:</span>
            <div class="mobile-edit-container" id="mobileContainer_${identifier}">
              <span class="student-detail-value" id="mobileDisplay_${identifier}">${student.mobile || 'Not provided'}</span>
              <button class="btn-small btn-edit" onclick="editMobileNumber('${identifier}')">Edit</button>
            </div>
          </div>
          <div class="student-detail-row">
            <span class="student-detail-label">üë∂ Age:</span>
            <span class="student-detail-value">${student.age || 'N/A'}</span>
          </div>
          <div class="student-detail-row">
            <span class="student-detail-label">üéÇ DOB:</span>
            <span class="student-detail-value">${student.dob || 'N/A'}</span>
          </div>
          <div class="student-detail-row">
            <span class="student-detail-label">üìÖ Date of Admission:</span>
            <span class="student-detail-value">${student.admission || 'N/A'}</span>
          </div>
          <div class="student-detail-row">
            <span class="student-detail-label">üìä Status:</span>
            <span class="student-detail-value">${attendanceStatus === 'present' ? '‚úÖ Present Today' : attendanceStatus === 'absent' ? '‚ùå Absent Today' : '‚è≥ Not Marked'}</span>
          </div>
          <div class="student-detail-row">
            <span class="student-detail-label">üïí Date & Time:</span>
            <span class="student-detail-value">${currentDateTime}</span>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:16px;">
            <button onclick="markStudentAttendance('${identifier}', 'present')" 
                    class="btn-primary btn-success" style="padding:12px;">
              ‚úÖ Mark Present
            </button>
            <button onclick="markStudentAttendance('${identifier}', 'absent')" 
                    class="btn-primary btn-danger" style="padding:12px;">
              ‚ùå Mark Absent
            </button>
          </div>
        </div>
      `;
    }
    
    function editMobileNumber(identifier) {
      const student = g_students.find(s => s.identifier === identifier);
      if (!student) return;
      
      const container = document.getElementById(`mobileContainer_${identifier}`);
      if (!container) return;
      
      const currentMobile = student.mobile || '';
      
      container.innerHTML = `
        <input type="tel" 
               class="mobile-edit-input" 
               id="mobileInput_${identifier}" 
               value="${currentMobile}" 
               placeholder="Enter mobile number" 
               maxlength="15" />
        <button class="btn-small btn-save" onclick="saveMobileNumber('${identifier}')">Save</button>
        <button class="btn-small btn-cancel" onclick="showStudentDetails('${identifier}')">Cancel</button>
      `;
      
      document.getElementById(`mobileInput_${identifier}`).focus();
    }
    
    async function saveMobileNumber(identifier) {
      const student = g_students.find(s => s.identifier === identifier);
      if (!student) return;
      
      const input = document.getElementById(`mobileInput_${identifier}`);
      if (!input) return;
      
      const newMobile = input.value.trim();
      
      if (!newMobile) {
        alert('‚ùå Please enter a mobile number!');
        return;
      }
      
      if (!/^\d{10,15}$/.test(newMobile)) {
        alert('‚ùå Please enter a valid mobile number (10-15 digits)!');
        return;
      }
      
      try {
        const saveBtn = input.nextElementSibling;
        if (saveBtn) {
          saveBtn.disabled = true;
          saveBtn.textContent = 'Saving...';
        }
        
        const url = `${SCRIPT_URL}?action=updateMobile&enrollment=${encodeURIComponent(student.enrollment)}&name=${encodeURIComponent(student.name)}&father=${encodeURIComponent(student.father)}&mobile=${encodeURIComponent(newMobile)}`;
        
        console.log(`üì§ Updating mobile number for ${student.name}...`);
        
        const response = await fetch(url, { method: 'GET' });
        const result = await response.json();
        
        console.log(`üì• Update response:`, result);
        
        if (result.success) {
          student.mobile = newMobile;
          
          const studentIndex = g_students.findIndex(s => s.identifier === identifier);
          if (studentIndex !== -1) {
            g_students[studentIndex].mobile = newMobile;
          }
          
          alert('‚úÖ Mobile number updated successfully!');
          showStudentDetails(identifier);
        } else {
          alert('‚ùå Failed to update mobile number. Please try again.');
          if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save';
          }
        }
      } catch (error) {
        console.error('‚ùå Error updating mobile number:', error);
        alert('‚ùå Error updating mobile number. Please check your connection and try again.');
        const saveBtn = input.nextElementSibling;
        if (saveBtn) {
          saveBtn.disabled = false;
          saveBtn.textContent = 'Save';
        }
      }
    }
    
    function markStudentAttendance(identifier, status) {
      const student = g_students.find(s => s.identifier === identifier);
      if (!student) return;
      
      if (confirm(`Mark ${student.name} as ${status}?`)) {
        g_todayAttendance[identifier] = status;
        saveToLocalStorage();
        
        showStudentDetails(identifier);
        uploadSingleAttendance(student, status);
        
        // Refresh Roznamcha if loaded
        if (g_roznamchaData) {
          loadRoznamchaData();
        }
        
        alert(`‚úÖ ${student.name} marked as ${status}!`);
      }
    }
    
    window.showStudentDetails = showStudentDetails;
    window.markStudentAttendance = markStudentAttendance;
    window.editAttendance = editAttendance;
    window.editMobileNumber = editMobileNumber;
    window.saveMobileNumber = saveMobileNumber;

    function showUploadToast(current, total) {
      const existing = document.getElementById('uploadToast');
      if (existing) existing.remove();

      const toast = document.createElement('div');
      toast.id = 'uploadToast';
      toast.className = 'upload-toast';
      toast.innerHTML = `
        <div style="font-weight:700;margin-bottom:8px;">üì§ Uploading Attendance...</div>
        <div class="upload-progress-bar">
          <div class="upload-progress-fill" style="width:0%"></div>
        </div>
        <div id="uploadStats" style="font-size:12px;color:var(--muted);margin-top:6px;">
          0 / ${total} uploaded
        </div>
      `;
      document.body.appendChild(toast);
    }

    function updateUploadToast(current, total, success, duplicate, failed) {
      const progress = (current / total) * 100;
      const fill = document.querySelector('.upload-progress-fill');
      const stats = document.getElementById('uploadStats');
      
      if (fill) fill.style.width = `${progress}%`;
      if (stats) {
        stats.innerHTML = `${current} / ${total} | ‚úÖ ${success} | ‚ö†Ô∏è ${duplicate} | ‚ùå ${failed}`;
      }
    }

    function hideUploadToast() {
      setTimeout(() => {
        const toast = document.getElementById('uploadToast');
        if (toast) toast.remove();
      }, 2000);
    }

    // ===== ROZNAMCHA FUNCTIONS =====
    async function loadRoznamchaData() {
      try {
        console.log('üìä Fetching REAL Roznamcha data from Google Sheets...');
        
        if (g_dataLoadStatus !== 'success' || g_students.length === 0) {
          showRoznamchaError('Student data not loaded yet. Please wait...');
          return;
        }
        
        // Call Google Apps Script API to get REAL attendance data
        const url = `${SCRIPT_URL}?action=roznamcha`;
        const response = await fetch(url, { method: 'GET' });
        const apiData = await response.json();
        
        if (!apiData.success) {
          throw new Error(apiData.error || 'Failed to fetch real-time data');
        }
        
        // Get current day name
        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const today = days[new Date().getDay()];
        const date = new Date().toLocaleDateString('en-GB').replace(/\//g, '-');
        
        const data = {
          success: true,
          day: today,
          date: date,
          timestamp: apiData.timestamp,
          classBreakdown: apiData.classBreakdown
        };
        
        g_roznamchaData = data;
        renderRoznamcha(data);
        console.log('‚úÖ REAL Roznamcha data loaded from Google Sheets successfully');
        
      } catch (error) {
        console.error('‚ùå Error loading REAL Roznamcha data:', error);
        showRoznamchaError('Failed to load real-time data from Google Sheets. Error: ' + error.message);
      }
    }

    function renderRoznamcha(data) {
      const container = document.getElementById('roznamchaContent');
      if (!container) return;
      
      const { day, date, classBreakdown } = data;
      
      // Sort classes
      const sortedClasses = Object.keys(classBreakdown).sort((a, b) => {
        if (a.toLowerCase() === 'nursery' || a.toLowerCase() === 'kachi' || a.toLowerCase() === 'kg') return -1;
        if (b.toLowerCase() === 'nursery' || b.toLowerCase() === 'kachi' || b.toLowerCase() === 'kg') return 1;
        const aNum = parseInt(a);
        const bNum = parseInt(b);
        if (!isNaN(aNum) && !isNaN(bNum)) return aNum - bNum;
        return a.localeCompare(b);
      });
      
      // Calculate totals
      let grandTotalBoys = 0, grandTotalGirls = 0, grandTotal = 0;
      let grandAbsentBoys = 0, grandAbsentGirls = 0, grandAbsent = 0;
      let grandPresentBoys = 0, grandPresentGirls = 0, grandPresent = 0;
      
      sortedClasses.forEach(className => {
        const c = classBreakdown[className];
        grandTotalBoys += c.totalBoys;
        grandTotalGirls += c.totalGirls;
        grandTotal += c.total;
        grandAbsentBoys += c.absentBoys;
        grandAbsentGirls += c.absentGirls;
        grandAbsent += c.absent;
        grandPresentBoys += c.presentBoys;
        grandPresentGirls += c.presentGirls;
        grandPresent += c.present;
      });
      
      const presentPercentage = grandTotal > 0 ? Math.round((grandPresent / grandTotal) * 100) : 0;
      
      let html = `
        <div class="roznamcha-wrapper">
          <div class="roznamcha-title-bar">
            ÿ±Ÿàÿ≤ÿßŸÜ€Å ÿ≠ÿßÿ∂ÿ±€å ⁄©Ÿà ŸÖÿ¥ÿ™ŸÖŸÑ ÿ®ÿ±ÿß€Å ÿ±ÿßÿ≥ÿ™ ÿ≥⁄©ŸàŸÑ ÿ¥€åŸÜŸàÿßŸÑ ŸÖÿ±⁄©ÿ≤ ÿ¥ŸÖÿ≥ ⁄©€í
          </div>
          
          <div class="roznamcha-refresh-info">
            <div class="refresh-indicator"></div>
            <span>Auto-refreshes every 5 minutes | Last updated: ${new Date().toLocaleTimeString('en-GB')}</span>
          </div>
          
          <table class="roznamcha-table">
            <tr>
              <th class="day-header" rowspan="2">${day}</th>
              <th class="section-header" colspan="3">⁄©ŸÑ ÿ™ÿπÿØÿßÿØ ÿ∑ŸÑÿ®ÿßÿ°</th>
              <th class="section-header" colspan="3">ÿ∫€åÿ± ÿ≠ÿßÿ∂ÿ± ÿ∑ŸÑÿ®ÿßÿ°</th>
              <th class="section-header" colspan="3">ÿ≠ÿßÿ∂ÿ± ÿ∑ŸÑÿ®ÿßÿ°</th>
            </tr>
            <tr>
              <th class="sub-header">Boys</th>
              <th class="sub-header">Girls</th>
              <th class="sub-header">Total</th>
              <th class="sub-header">Boys</th>
              <th class="sub-header">Girls</th>
              <th class="sub-header">Total</th>
              <th class="sub-header">Boys</th>
              <th class="sub-header">Girls</th>
              <th class="sub-header">Total</th>
            </tr>
      `;
      
      sortedClasses.forEach(className => {
        const c = classBreakdown[className];
        const urduName = CLASS_NAMES_URDU[className] || className;
        
        html += `
          <tr>
            <td class="class-name-cell">
              ${className}
              <span class="class-name-urdu">${urduName}</span>
            </td>
            <td class="data-cell">${c.totalBoys}</td>
            <td class="data-cell">${c.totalGirls}</td>
            <td class="data-cell">${c.total}</td>
            <td class="data-cell">${c.absentBoys}</td>
            <td class="data-cell">${c.absentGirls}</td>
            <td class="data-cell">${c.absent}</td>
            <td class="data-cell">${c.presentBoys}</td>
            <td class="data-cell">${c.presentGirls}</td>
            <td class="data-cell">${c.present}</td>
          </tr>
        `;
      });
      
      html += `
            <tr class="total-row">
              <td>Total</td>
              <td>${grandTotalBoys}</td>
              <td>${grandTotalGirls}</td>
              <td>${grandTotal}</td>
              <td>${grandAbsentBoys}</td>
              <td>${grandAbsentGirls}</td>
              <td>${grandAbsent}</td>
              <td>${grandPresentBoys}</td>
              <td>${grandPresentGirls}</td>
              <td>${grandPresent}</td>
            </tr>
          </table>
          
          <div class="roznamcha-footer">
            <div class="roznamcha-footer-cell roznamcha-footer-date">
              <strong>Date:</strong> ${date}
            </div>
            <div class="roznamcha-footer-cell roznamcha-footer-percent">
              ${presentPercentage}%
            </div>
            <div class="roznamcha-footer-cell roznamcha-footer-label">
              ŸÖÿ¨ŸÖŸàÿπ€å ÿ≠ÿßÿ∂ÿ±€å
            </div>
          </div>
        </div>
      `;
      
      container.innerHTML = html;
    }

    function showRoznamchaError(message) {
      const container = document.getElementById('roznamchaContent');
      if (!container) return;
      
      container.innerHTML = `
        <div class="roznamcha-error">
          <h3>‚ùå Unable to Load Roznamcha</h3>
          <p style="margin-top:8px;">${message}</p>
          <button onclick="loadRoznamchaData()" class="btn-primary" style="margin-top:16px;padding:12px 24px;">
            üîÑ Retry
          </button>
        </div>
      `;
    }

    function startRoznamchaAutoRefresh() {
      if (g_roznamchaInterval) {
        clearInterval(g_roznamchaInterval);
      }
      
      g_roznamchaInterval = setInterval(() => {
        console.log('üîÑ Auto-refreshing Roznamcha data...');
        loadRoznamchaData();
      }, ROZNAMCHA_REFRESH_INTERVAL);
      
      console.log(`‚úÖ Roznamcha auto-refresh started (every ${ROZNAMCHA_REFRESH_INTERVAL/1000/60} minutes)`);
    }

    function stopRoznamchaAutoRefresh() {
      if (g_roznamchaInterval) {
        clearInterval(g_roznamchaInterval);
        g_roznamchaInterval = null;
        console.log('‚èπÔ∏è Roznamcha auto-refresh stopped');
      }
    }

    // ===== COPY TO CLIPBOARD FUNCTION =====
    function copyToClipboard(text, buttonId) {
      navigator.clipboard.writeText(text).then(() => {
        const btn = document.getElementById(buttonId);
        const originalHTML = btn.innerHTML;
        
        btn.innerHTML = '‚úÖ Copied!';
        btn.classList.add('copied');
        
        const toast = document.getElementById('copyToast');
        toast.classList.add('show');
        
        setTimeout(() => {
          btn.innerHTML = originalHTML;
          btn.classList.remove('copied');
          toast.classList.remove('show');
        }, 2000);
      }).catch(err => {
        alert('‚ùå Failed to copy to clipboard');
        console.error('Copy failed:', err);
      });
    }

    window.copyToClipboard = copyToClipboard;

    // ===== MODERN SYSTEM INFO =====
    function updateSystemInfo() {
      const content = document.getElementById('systemInfoContent');
      if (!content) return;
      
      const totalStudents = g_students.length;
      const currentDateTime = new Date().toLocaleString('en-GB', { 
        timeZone: 'Asia/Karachi',
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
      });
      
      const dataStatus = g_dataLoadStatus === 'success';
      const memoryAvailable = 'N/A KB';
      
      content.innerHTML = `
        <!-- System Connectivity Section -->
        <div class="system-section-card">
          <div class="system-section-header">
            <div class="system-section-icon">üåê</div>
            <div class="system-section-title">
              <h3>System Connectivity</h3>
              <p>Hardware and network connection status</p>
            </div>
          </div>
          <div class="system-info-grid">
            <div class="system-info-item">
              <div class="system-info-item-icon">‚úÖ</div>
              <div class="system-info-item-content">
                <div class="system-info-item-label">SPIFFS Mount</div>
                <div class="system-info-item-value">
                  <span class="system-status-badge">OK</span>
                </div>
              </div>
            </div>
            <div class="system-info-item">
              <div class="system-info-item-icon">‚úÖ</div>
              <div class="system-info-item-content">
                <div class="system-info-item-label">RC522 Scanner</div>
                <div class="system-info-item-value">
                  <span class="system-status-badge">Ready</span>
                </div>
              </div>
            </div>
            <div class="system-info-item">
              <div class="system-info-item-icon">üì∂</div>
              <div class="system-info-item-content">
                <div class="system-info-item-label">WiFi Connection</div>
                <div class="system-info-item-value">
                  <span class="system-status-badge">Connected</span>
                </div>
              </div>
            </div>
            <div class="system-info-item">
              <div class="system-info-item-icon">‚è≥</div>
              <div class="system-info-item-content">
                <div class="system-info-item-label">NTP Time Sync</div>
                <div class="system-info-item-value">
                  <span class="system-status-badge">OK</span>
                </div>
              </div>
            </div>
            <div class="system-info-item">
              <div class="system-info-item-icon">${dataStatus ? '‚úÖ' : '‚ùå'}</div>
              <div class="system-info-item-content">
                <div class="system-info-item-label">Students Data Download</div>
                <div class="system-info-item-value">
                  <span class="system-status-badge ${dataStatus ? '' : 'error'}">${dataStatus ? 'OK' : 'Failed'}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- System Information Section -->
        <div class="system-section-card">
          <div class="system-section-header">
            <div class="system-section-icon">‚öôÔ∏è</div>
            <div class="system-section-title">
              <h3>System Information</h3>
              <p>Device details and configuration</p>
            </div>
          </div>
          <div class="system-info-grid">
            <div class="system-info-item">
              <div class="system-info-item-icon">üåê</div>
              <div class="system-info-item-content">
                <div class="system-info-item-label">IP Address</div>
                <div class="system-info-item-value">${IP_ADDRESS}</div>
              </div>
            </div>
            <div class="system-info-item">
              <div class="system-info-item-icon">üîó</div>
              <div class="system-info-item-content">
                <div class="system-info-item-label">MAC Address</div>
                <div class="system-info-item-value">${MAC_ADDRESS}</div>
              </div>
            </div>
            <div class="system-info-item">
              <div class="system-info-item-icon">üì°</div>
              <div class="system-info-item-content">
                <div class="system-info-item-label">RF Scanner Model</div>
                <div class="system-info-item-value">${SCANNER_MODEL}</div>
              </div>
            </div>
            <div class="system-info-item">
              <div class="system-info-item-icon">üì∂</div>
              <div class="system-info-item-content">
                <div class="system-info-item-label">WiFi Network</div>
                <div class="system-info-item-value">${WIFI_SSID}</div>
              </div>
            </div>
            <div class="system-info-item">
              <div class="system-info-item-icon">üë•</div>
              <div class="system-info-item-content">
                <div class="system-info-item-label">Total Students Loaded</div>
                <div class="system-info-item-value">${totalStudents} students</div>
              </div>
            </div>
            <div class="system-info-item">
              <div class="system-info-item-icon">üíæ</div>
              <div class="system-info-item-content">
                <div class="system-info-item-label">ESP-32 Memory Available</div>
                <div class="system-info-item-value">${memoryAvailable}</div>
              </div>
            </div>
            <div class="system-info-item">
              <div class="system-info-item-icon">üîß</div>
              <div class="system-info-item-content">
                <div class="system-info-item-label">Firmware Version</div>
                <div class="system-info-item-value">${FIRMWARE_VERSION}</div>
              </div>
            </div>
            <div class="system-info-item">
              <div class="system-info-item-icon">üì±</div>
              <div class="system-info-item-content">
                <div class="system-info-item-label">Script Version</div>
                <div class="system-info-item-value">${SCRIPT_VERSION}</div>
              </div>
            </div>
            <div class="system-info-item" style="grid-column: 1 / -1;">
              <div class="system-info-item-icon">üïí</div>
              <div class="system-info-item-content">
                <div class="system-info-item-label">Current Date & Time</div>
                <div class="system-info-item-value">${currentDateTime}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Software Information Section -->
        <div class="system-section-card">
          <div class="system-section-header">
            <div class="system-section-icon">üíª</div>
            <div class="system-section-title">
              <h3>Software Information</h3>
              <p>Application links and configuration IDs</p>
            </div>
          </div>
          <div style="display:grid;gap:16px;">
            <div class="software-link-item">
              <div class="software-link-icon">üìä</div>
              <div class="software-link-content">
                <div class="software-link-label">Google Sheet Link</div>
                <div class="software-link-value">${SHEET_LINK}</div>
              </div>
              <button class="btn-copy" id="btnCopySheetLink" onclick="copyToClipboard('${SHEET_LINK}', 'btnCopySheetLink')">
                üìã Copy
              </button>
            </div>
            <div class="software-link-item">
              <div class="software-link-icon">üìÑ</div>
              <div class="software-link-content">
                <div class="software-link-label">CSV Data Link</div>
                <div class="software-link-value">${CSV_URL}</div>
              </div>
              <button class="btn-copy" id="btnCopyCsvLink" onclick="copyToClipboard('${CSV_URL}', 'btnCopyCsvLink')">
                üìã Copy
              </button>
            </div>
            <div class="software-link-item">
              <div class="software-link-icon">üöÄ</div>
              <div class="software-link-content">
                <div class="software-link-label">Deployment Link</div>
                <div class="software-link-value">${DEPLOYMENT_LINK}</div>
              </div>
              <button class="btn-copy" id="btnCopyDeployLink" onclick="copyToClipboard('${DEPLOYMENT_LINK}', 'btnCopyDeployLink')">
                üìã Copy
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function saveToLocalStorage() {
      const today = new Date().toLocaleDateString('en-GB');
      localStorage.setItem('attendanceDate', today);
      localStorage.setItem('todayAttendance', JSON.stringify(g_todayAttendance));
      localStorage.setItem('allAttendance', JSON.stringify(g_allAttendance));
      localStorage.setItem('selectedUIDs', JSON.stringify([...g_selectedUIDs]));
      localStorage.setItem('sessionStats', JSON.stringify(g_sessionStats));
      localStorage.setItem('pendingUploads', JSON.stringify(g_pendingUploads));
    }

    function loadFromLocalStorage() {
      const today = new Date().toLocaleDateString('en-GB');
      const storedDate = localStorage.getItem('attendanceDate');
      
      if (storedDate === today) {
        const attendance = localStorage.getItem('todayAttendance');
        const allAttendance = localStorage.getItem('allAttendance');
        const selected = localStorage.getItem('selectedUIDs');
        const stats = localStorage.getItem('sessionStats');
        const pending = localStorage.getItem('pendingUploads');
        
        if (attendance) g_todayAttendance = JSON.parse(attendance);
        if (allAttendance) g_allAttendance = JSON.parse(allAttendance);
        if (selected) g_selectedUIDs = new Set(JSON.parse(selected));
        if (stats) g_sessionStats = JSON.parse(stats);
        if (pending) g_pendingUploads = JSON.parse(pending);
        
        console.log('‚úÖ Loaded from localStorage');
        
        if (g_pendingUploads.length > 0) {
          console.log(`üîÑ Found ${g_pendingUploads.length} pending uploads`);
          setTimeout(processPendingUploads, 2000);
        }
      } else {
        localStorage.removeItem('todayAttendance');
        localStorage.removeItem('selectedUIDs');
        g_todayAttendance = {};
        g_selectedUIDs = new Set();
      }
    }

    document.getElementById('loginBtn')?.addEventListener('click', handleLogin);
    document.getElementById('pinInput')?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') handleLogin();
    });

    function handleLogin() {
      const pin = document.getElementById('pinInput').value.trim();
      const errorEl = document.getElementById('loginError');
      
      if (pin === PIN) {
        errorEl.textContent = '';
        document.getElementById('viewLogin').classList.add('hidden');
        document.getElementById('viewMain').classList.remove('hidden');
        initializeApp();
      } else {
        errorEl.textContent = '‚ùå Invalid Password!';
        setTimeout(() => errorEl.textContent = '', 3000);
      }
    }

    setInterval(() => {
      const now = new Date();
      const dateStr = now.toLocaleDateString('en-GB');
      const timeStr = now.toLocaleTimeString('en-GB');
      const el = document.getElementById('loginDateTime');
      if (el) el.textContent = `${dateStr} ${timeStr}`;
    }, 1000);

    function initializeApp() {
      console.log('üöÄ Initializing GPS Sheinwal App v8.3 TABLE ROZNAMCHA...');
      loadFromLocalStorage();
      loadAllStudentsFast();
      startAutoSync();
    }

    function startAutoSync() {
      g_autoSyncInterval = setInterval(() => {
        console.log('üîÑ Auto-sync triggered...');
        saveToLocalStorage();
        if (g_pendingUploads.length > 0) {
          processPendingUploads();
        }
      }, 5 * 60 * 1000);
    }

    document.querySelectorAll('.main-tabs button').forEach(btn => {
      btn.addEventListener('click', (e) => {
        document.querySelectorAll('.main-tabs button').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        
        const sections = ['sectionAttendance', 'sectionReports', 'sectionRoznamcha', 'sectionSystemInfo'];
        sections.forEach(s => {
          const el = document.getElementById(s);
          if (el) el.classList.add('hidden');
        });
        
        if (e.target.id === 'tabAttendance') {
          document.getElementById('sectionAttendance')?.classList.remove('hidden');
          stopRoznamchaAutoRefresh();
        }
        if (e.target.id === 'tabReports') {
          document.getElementById('sectionReports')?.classList.remove('hidden');
          stopRoznamchaAutoRefresh();
        }
        if (e.target.id === 'tabRoznamcha') {
          document.getElementById('sectionRoznamcha')?.classList.remove('hidden');
          loadRoznamchaData(); // Load immediately
          startRoznamchaAutoRefresh(); // Start auto-refresh
        }
        if (e.target.id === 'tabSystemInfo') {
          document.getElementById('sectionSystemInfo')?.classList.remove('hidden');
          updateSystemInfo();
          stopRoznamchaAutoRefresh();
        }
      });
    });

    document.querySelectorAll('.sub-tabs button').forEach(btn => {
      btn.addEventListener('click', (e) => {
        document.querySelectorAll('.sub-tabs button').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        
        const sections = ['subSectionManual', 'subSectionQR', 'subSectionStudentInfo'];
        sections.forEach(s => {
          const el = document.getElementById(s);
          if (el) el.classList.add('hidden');
        });
        
        if (e.target.id === 'subTabManual') document.getElementById('subSectionManual')?.classList.remove('hidden');
        if (e.target.id === 'subTabQR') document.getElementById('subSectionQR')?.classList.remove('hidden');
        if (e.target.id === 'subTabStudentInfo') document.getElementById('subSectionStudentInfo')?.classList.remove('hidden');
      });
    });

    document.getElementById('classSelect')?.addEventListener('change', filterAndRender);

    console.log('üì± GPS Sheinwal v8.3 TABLE ROZNAMCHA loaded successfully!');

    window.addEventListener('beforeunload', () => {
      saveToLocalStorage();
      stopRoznamchaAutoRefresh();
    });
  </script>
</body>
</html>
