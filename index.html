<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GPS Sheinwal - RF Attendance v8.1 REAL-TIME (FIXED)</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;500;600;700&display=swap');
    
    :root{
      --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --bg:#f8fafc; 
      --card:#ffffff; 
      --text:#1e293b; 
      --muted:#64748b;
      --brand:#6366f1; 
      --brand-hover:#4f46e5;
      --brand-light:#eef2ff;
      --ok:#10b981; 
      --warn:#f59e0b; 
      --bad:#ef4444;
      --border:#e2e8f0; 
      --shadow:0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
      --shadow-lg:0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
    }
    
    * { box-sizing: border-box; margin:0; padding:0; }
    
    html,body{
      min-height:100%;
      background:var(--bg);
      color:var(--text);
      font-family:'Inter',system-ui,-apple-system,sans-serif;
      line-height:1.6;
    }

    header{
      position:sticky;
      top:0;
      z-index:50;
      background:var(--bg-gradient);
      color:#fff;
      text-align:center;
      padding:16px;
      box-shadow:var(--shadow-lg);
    }
    
    .school-name{
      font-size:clamp(18px, 4vw, 24px);
      font-weight:800;
      margin-bottom:4px;
      text-shadow:0 2px 4px rgba(0,0,0,0.1);
      letter-spacing:-0.5px;
    }
    
    .bar h1{
      font-size:clamp(14px, 3.5vw, 18px);
      margin:0;
      font-weight:600;
      letter-spacing:0.5px;
      opacity:0.95;
    }

    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:12px;
    }

    .card{
      background:var(--card);
      border-radius:16px;
      box-shadow:var(--shadow-lg);
      padding:20px;
      border:1px solid var(--border);
      margin-bottom:16px;
    }

    .main-tabs{
      display:grid;
      grid-template-columns:repeat(2, 1fr);
      gap:10px;
      margin-bottom:16px;
    }
    
    .main-tabs button{
      padding:14px 10px;
      border-radius:12px;
      border:2px solid transparent;
      background:var(--card);
      cursor:pointer;
      font-weight:700;
      font-size:14px;
      transition:all 0.3s;
      box-shadow:var(--shadow);
      color:var(--text);
    }
    
    .main-tabs button:hover{
      transform:translateY(-2px);
      box-shadow:0 8px 16px -4px rgba(99,102,241,0.3);
    }
    
    .main-tabs button.active{
      background:var(--bg-gradient);
      color:#fff;
      box-shadow:0 8px 16px -4px rgba(99,102,241,0.5);
    }

    .sub-tabs{
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:8px;
      margin-bottom:16px;
      background:var(--brand-light);
      padding:8px;
      border-radius:12px;
    }

    .sub-tabs button{
      padding:10px 8px;
      border-radius:8px;
      border:none;
      background:white;
      cursor:pointer;
      font-weight:600;
      font-size:12px;
      transition:all 0.3s;
      color:var(--text);
    }

    .sub-tabs button.active{
      background:var(--brand);
      color:white;
      box-shadow:0 4px 8px rgba(99,102,241,0.3);
    }

    .toolbar{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
      margin-bottom:16px;
    }
    
    .label-text{
      font-weight:600;
      font-size:12px;
      color:var(--text);
      margin-bottom:6px;
      display:block;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    
    input[type="text"],input[type="password"],input[type="number"],select{
      padding:12px 14px;
      border-radius:10px;
      border:2px solid var(--border);
      font-size:14px;
      width:100%;
      transition:all 0.2s;
      background:var(--card);
      font-family:inherit;
    }
    
    input:focus,select:focus{
      outline:none;
      border-color:var(--brand);
      box-shadow:0 0 0 3px var(--brand-light);
    }

    .select-all-bar{
      background:var(--brand-light);
      border:2px solid var(--brand);
      border-radius:10px;
      padding:14px 16px;
      margin-bottom:12px;
      display:flex;
      align-items:center;
      gap:10px;
    }

    .select-all-bar input[type="checkbox"]{
      width:20px;
      height:20px;
      cursor:pointer;
    }

    .select-all-bar label{
      font-weight:700;
      font-size:14px;
      color:var(--brand);
      cursor:pointer;
      flex:1;
    }

    .selected-count{
      background:var(--brand);
      color:white;
      padding:4px 12px;
      border-radius:16px;
      font-weight:700;
      font-size:12px;
    }

    .class-total-badge{
      background:var(--ok);
      color:white;
      padding:6px 14px;
      border-radius:20px;
      font-weight:700;
      font-size:13px;
      margin-bottom:12px;
      display:inline-block;
    }

    .list{
      background:var(--card);
      border:2px solid var(--border);
      border-radius:12px;
      overflow:hidden;
      margin-bottom:80px;
      box-shadow:var(--shadow);
      max-height: 60vh;
      overflow-y: auto;
    }
    
    .row-item{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 14px;
      border-top:1px solid var(--border);
      transition:all 0.2s;
      gap:10px;
    }
    
    .row-item:first-child{border-top:none}
    
    .row-item:hover{
      background:var(--brand-light);
    }

    .row-item.selected{
      background:#d1fae5;
    }
    
    .student-info{
      flex:1;
      min-width:0;
    }

    .name{
      font-weight:700;
      font-size:14px;
      color:var(--text);
      margin-bottom:2px;
    }
    
    .meta{
      font-size:11px;
      color:var(--muted);
      font-weight:500;
    }

    .student-checkbox{
      width:20px;
      height:20px;
      cursor:pointer;
      flex-shrink:0;
    }

    .fab{
      position:fixed;
      bottom:16px;
      left:50%;
      transform:translateX(-50%);
      z-index:100;
      width:calc(100% - 24px);
      max-width:400px;
    }
    
    .fab button{
      width:100%;
      padding:14px 24px;
      border-radius:50px;
      font-size:15px;
      font-weight:700;
      background:var(--bg-gradient);
      color:#fff;
      border:none;
      box-shadow:0 10px 25px -5px rgba(99,102,241,0.5);
      cursor:pointer;
      transition:all 0.3s;
    }
    
    .fab button:hover{
      transform:translateY(-3px);
      box-shadow:0 15px 30px -5px rgba(99,102,241,0.6);
    }

    .fab button:disabled{
      opacity:0.6;
      cursor:not-allowed;
    }

    .upload-toast{
      position:fixed;
      top:80px;
      right:12px;
      background:white;
      border:2px solid var(--brand);
      border-radius:12px;
      padding:16px;
      box-shadow:var(--shadow-lg);
      z-index:90;
      min-width:280px;
      animation:slideIn 0.3s ease;
    }

    .error-banner{
      background:linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color:white;
      padding:20px;
      border-radius:12px;
      margin:16px 0;
      box-shadow:0 8px 16px rgba(239,68,68,0.3);
    }

    .success-banner{
      background:linear-gradient(135deg, #10b981 0%, #059669 100%);
      color:white;
      padding:20px;
      border-radius:12px;
      margin:16px 0;
      box-shadow:0 8px 16px rgba(16,185,129,0.3);
    }

    @keyframes slideIn{
      from{transform:translateX(400px);opacity:0;}
      to{transform:translateX(0);opacity:1;}
    }

    @keyframes pulse {
      0%, 100% { 
        background: var(--brand-light);
        transform: scale(1);
      }
      50% { 
        background: var(--brand);
        transform: scale(1.02);
      }
    }

    .upload-progress-bar{
      width:100%;
      height:8px;
      background:var(--border);
      border-radius:4px;
      overflow:hidden;
      margin:10px 0;
    }

    .upload-progress-fill{
      height:100%;
      background:var(--brand);
      transition:width 0.3s;
    }

    .hidden{display:none!important}

    .login-container {
      text-align:center;
      max-width:400px;
      margin:40px auto;
    }
    
    .login-icon {
      width:70px;
      height:70px;
      margin:0 auto 16px;
      background:var(--bg-gradient);
      border-radius:16px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:36px;
      box-shadow:var(--shadow-lg);
    }

    .btn-primary{
      padding:10px 20px;
      border-radius:8px;
      border:none;
      background:var(--brand);
      color:white;
      font-weight:700;
      font-size:13px;
      cursor:pointer;
      transition:all 0.3s;
    }

    .btn-primary:hover{
      background:var(--brand-hover);
      transform:translateY(-2px);
    }

    .btn-success{
      background:var(--ok);
    }

    .btn-danger{
      background:var(--bad);
    }

    .loading-spinner {
      border: 4px solid var(--border);
      border-top: 4px solid var(--brand);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
    }

    .status-badge.success {
      background: #d1fae5;
      color: #059669;
    }

    .status-badge.warning {
      background: #fef3c7;
      color: #d97706;
    }

    .status-badge.error {
      background: #fee2e2;
      color: #dc2626;
    }

    .system-ready-banner {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      margin: 16px 0;
      box-shadow: 0 8px 16px rgba(16,185,129,0.3);
    }

    .autocomplete-container {
      position: relative;
    }

    .autocomplete-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 3px solid var(--brand);
      border-top: none;
      border-radius: 0 0 16px 16px;
      max-height: 400px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 15px 35px -5px rgba(99,102,241,0.4);
      display: none;
    }

    .autocomplete-dropdown.show {
      display: block;
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .autocomplete-item {
      padding: 16px 16px;
      cursor: pointer;
      border-bottom: 2px solid #f1f5f9;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 14px;
      background: white;
    }

    .autocomplete-item:last-child {
      border-bottom: none;
      border-radius: 0 0 14px 14px;
    }

    .autocomplete-item:hover {
      background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
      transform: translateX(5px);
      box-shadow: inset 4px 0 0 var(--brand);
    }

    .autocomplete-item-avatar {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      flex-shrink: 0;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .autocomplete-item-avatar.male {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }

    .autocomplete-item-avatar.female {
      background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
    }

    .autocomplete-item-info {
      flex: 1;
      min-width: 0;
    }

    .autocomplete-item-name {
      font-weight: 700;
      font-size: 15px;
      color: var(--text);
      margin-bottom: 6px;
      line-height: 1.2;
    }

    .autocomplete-item-meta {
      font-size: 12px;
      color: var(--muted);
      font-weight: 600;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .autocomplete-item-badge {
      background: var(--brand-light);
      color: var(--brand);
      padding: 3px 8px;
      border-radius: 6px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .autocomplete-empty {
      padding: 30px 20px;
      text-align: center;
      color: var(--muted);
      font-size: 14px;
      font-weight: 600;
    }

    .autocomplete-empty::before {
      content: "üîç";
      display: block;
      font-size: 40px;
      margin-bottom: 10px;
      opacity: 0.5;
    }

    @media (min-width: 768px) {
      .wrap { padding:20px; }
      .toolbar { grid-template-columns:1fr 1fr; }
      .main-tabs { grid-template-columns:repeat(4, 1fr); }
    }

    @media (max-width: 767px) {
      .upload-toast { right:12px; left:12px; min-width:unset; }
    }
  </style>
</head>
<body>
  <header>
    <div class="school-name">üéì GPS Sheinwal (Shamaskay)</div>
    <div class="bar"><h1>RFID Attendance Management System v8.1 FIXED</h1></div>
  </header>
  
  <div class="wrap">
    <!-- LOGIN VIEW -->
    <section id="viewLogin" class="card login-container">
      <div class="login-icon">üîê</div>
      <div style="font-size:24px;font-weight:800;margin-bottom:6px;color:var(--text);">Secure Login</div>
      <div style="color:var(--muted);margin-bottom:20px;font-size:14px;">Enter your password to continue</div>
      <div id="loginDateTime" style="color:var(--muted);margin-bottom:16px;font-size:12px;"></div>
      <input id="pinInput" type="password" inputmode="numeric" maxlength="20" placeholder="Enter Password" 
        style="width:90%;padding:12px 18px;text-align:center;letter-spacing:3px;margin-bottom:16px;font-size:16px;" />
      <button id="loginBtn" style="padding:12px 36px;border:none;border-radius:10px;background:var(--bg-gradient);
        color:white;font-size:15px;font-weight:700;cursor:pointer;box-shadow:0 4px 12px rgba(99,102,241,0.4);transition:all 0.3s;">
        Login ‚Üí
      </button>
      <div id="loginError" style="margin-top:14px;color:var(--bad);font-weight:600;font-size:13px;"></div>
    </section>

    <!-- MAIN VIEW -->
    <section id="viewMain" class="hidden">
      <!-- Data Load Status -->
      <div id="dataLoadStatus"></div>

      <!-- Main Tabs -->
      <div class="main-tabs">
        <button id="tabAttendance" class="active">üìã Attendance</button>
        <button id="tabReports">üìÑ Reports</button>
        <button id="tabRoznamcha">üìä Roznamcha</button>
        <button id="tabSystemInfo">üîß System</button>
      </div>

      <!-- ATTENDANCE SECTION -->
      <div id="sectionAttendance">
        <!-- Sub Tabs -->
        <div class="sub-tabs">
          <button id="subTabManual" class="active">‚úçÔ∏è Manual</button>
          <button id="subTabQR">üì∑ QR Scan</button>
          <button id="subTabStudentInfo">üë§ Student Info</button>
        </div>

        <!-- Manual Attendance -->
        <div id="subSectionManual">
          <div class="toolbar">
            <div>
              <span class="label-text">üìö Select Class</span>
              <select id="classSelect">
                <option value="">All Classes</option>
              </select>
            </div>
            <div>
              <span class="label-text">üîç Search Student</span>
              <input type="text" id="searchInput" placeholder="Search by name, father name or enrollment..." />
            </div>
          </div>

          <div id="classTotalBadge"></div>

          <div class="select-all-bar">
            <input type="checkbox" id="selectAllCheckbox" />
            <label for="selectAllCheckbox">Select All (Present)</label>
            <span class="selected-count" id="selectedCount">0 Selected</span>
          </div>

          <div id="studentList" class="list"></div>
          
          <div class="fab" id="submitFab">
            <button id="submitBtn">‚úì Submit Attendance</button>
          </div>
        </div>

        <!-- QR Scan -->
        <div id="subSectionQR" class="hidden">
          <div class="card" style="text-align:center;padding:60px 20px;">
            <div style="font-size:48px;margin-bottom:16px;">üì∑</div>
            <h3 style="color:var(--brand);margin-bottom:12px;">QR Code Scanner</h3>
            <p style="color:var(--muted);font-size:14px;">QR Code attendance scanning feature coming soon...</p>
          </div>
        </div>

        <!-- Student Information -->
        <div id="subSectionStudentInfo" class="hidden">
          <div class="toolbar">
            <div>
              <span class="label-text">üîç Search Student</span>
              <div class="autocomplete-container">
                <input type="text" id="singleStudentSearch" placeholder="Enter UID, Name, Father Name or Enrollment..." />
                <div id="studentSearchDropdown" class="autocomplete-dropdown"></div>
              </div>
            </div>
          </div>
          <div id="studentDetailResult"></div>
        </div>
      </div>

      <!-- REPORTS SECTION -->
      <div id="sectionReports" class="hidden">
        <div class="card">
          <h3 style="color:var(--brand);margin-bottom:16px;font-size:18px;">üìÑ Download Reports (CSV Format)</h3>
          <p style="color:var(--muted);margin-bottom:20px;font-size:14px;">Download attendance and student data files in CSV format</p>
          
          <a href="https://docs.google.com/spreadsheets/d/1woOwa-1ydra43sLalpjGB4x-1ZjeE_rWSy9LDvGBpJA/export?format=csv&gid=493301113" 
             class="btn-primary" style="display:block;text-align:center;padding:14px;text-decoration:none;margin-bottom:10px;" target="_blank" download="Student_Data.csv">
            üìä Download Student Data File (CSV)
          </a>
          
          <a href="https://docs.google.com/spreadsheets/d/1woOwa-1ydra43sLalpjGB4x-1ZjeE_rWSy9LDvGBpJA/export?format=csv&gid=0" 
             class="btn-primary" style="display:block;text-align:center;padding:14px;text-decoration:none;margin-bottom:10px;" target="_blank" download="Attendance_Data.csv">
            üìù Download Attendance File (CSV)
          </a>
        </div>
      </div>

      <!-- ROZNAMCHA SECTION -->
      <div id="sectionRoznamcha" class="hidden">
        <div class="card" style="text-align:center;padding:40px;">
          <div style="font-size:48px;margin-bottom:16px;">üìä</div>
          <h3 style="color:var(--brand);margin-bottom:12px;">Roznamcha (Daily Report)</h3>
          <p style="color:var(--muted);font-size:14px;">Roznamcha feature coming soon...</p>
        </div>
      </div>

      <!-- SYSTEM INFO SECTION -->
      <div id="sectionSystemInfo" class="hidden">
        <div id="systemInfoContent"></div>
      </div>
    </section>
  </div>

  <script>
    // ===== CONFIGURATION =====
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwd7O21lM9ynCqR0-MLW-lfL25EHFLKnTNOurjSghAzJuLFT_0TLTXjUaGqirc1e161Qw/exec";
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTYhSsnnY8WKnRs-d-oeFjLT1ZhlE8RAb8EyUOUj8NfWzEI2bCha5SdcVWBfcD8z2cUm1DiiLpemKXf/pub?gid=493301113&single=true&output=csv";
    const SHEET_ID = "1woOwa-1ydra43sLalpjGB4x-1ZjeE_rWSy9LDvGBpJA";
    const PIN = "39310242";
    const WIFI_SSID = "Mirza Gee 2";
    const IP_ADDRESS = "192.168.10.43";
    const MAC_ADDRESS = "EC:E3:34:21:06:C0";
    const SCANNER_MODEL = "MFRC522";
    const FIRMWARE_VERSION = "v2.10";
    const SCRIPT_VERSION = "v8.1 FIXED";
    const MAX_RETRY_ATTEMPTS = 5;
    const RETRY_DELAY = 3000;
    
    // ===== GLOBAL STATE =====
    let g_students = [];
    let g_filteredStudents = [];
    let g_selectedUIDs = new Set();
    let g_todayAttendance = {};
    let g_allAttendance = {};
    let g_sessionStats = {
      totalUploaded: 0,
      totalDuplicate: 0,
      totalFailed: 0,
      totalScanned: 0,
      queueSize: 0
    };
    let g_autoSyncInterval = null;
    let g_pendingUploads = [];
    let g_dataLoadStatus = 'loading';
    let g_retryCount = 0;

    // ===== CSV LOADING =====
    async function loadAllStudentsFast(retryAttempt = 0) {
      try {
        console.log(`üì• Loading students from CSV (Attempt ${retryAttempt + 1}/${MAX_RETRY_ATTEMPTS})...`);
        
        showLoadingStatus(`Loading student data... (Attempt ${retryAttempt + 1}/${MAX_RETRY_ATTEMPTS})`);
        
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 15000);
        
        const response = await fetch(CSV_URL, {
          method: 'GET',
          cache: 'no-cache',
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const csvText = await response.text();
        
        if (!csvText || csvText.trim().length === 0) {
          throw new Error('Empty CSV file received');
        }
        
        const lines = csvText.split('\n');
        
        if (lines.length < 2) {
          throw new Error('CSV file has no data rows');
        }
        
        g_students = [];
        
        for (let i = 1; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;
          
          const cols = parseCSVLine(line);
          if (cols.length < 11) continue;
          
          const student = {
            uid: cols[0] || '',
            srNo: cols[1] || '',
            enrollment: cols[2] || '',
            name: cols[3] || '',
            gender: cols[4] || '',
            dob: cols[5] || '',
            bform: cols[6] || '',
            admission: cols[7] || '',
            father: cols[8] || '',
            cnic: cols[9] || '',
            class: cols[10] || '',
            mobile: cols[11] || '',
            identifier: cols[2] || cols[3]
          };
          
          g_students.push(student);
        }
        
        if (g_students.length === 0) {
          throw new Error('No students parsed from CSV');
        }
        
        console.log(`‚úÖ Successfully loaded ${g_students.length} students from CSV`);
        g_dataLoadStatus = 'success';
        g_retryCount = 0;
        
        showSuccessStatus(`‚úÖ Real-time data loaded: ${g_students.length} students`);
        
        populateClassDropdown();
        filterAndRender();
        updateSystemInfo();
        
      } catch (error) {
        console.error(`‚ùå CSV loading failed (Attempt ${retryAttempt + 1}):`, error);
        
        g_retryCount = retryAttempt + 1;
        
        if (retryAttempt < MAX_RETRY_ATTEMPTS - 1) {
          showErrorStatus(`‚ö†Ô∏è Connection failed. Retrying in ${RETRY_DELAY/1000} seconds... (${retryAttempt + 1}/${MAX_RETRY_ATTEMPTS})`);
          
          setTimeout(() => {
            loadAllStudentsFast(retryAttempt + 1);
          }, RETRY_DELAY);
        } else {
          g_dataLoadStatus = 'error';
          showCriticalError(error);
        }
      }
    }

    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      
      result.push(current.trim());
      return result;
    }

    function showLoadingStatus(message) {
      const container = document.getElementById('dataLoadStatus');
      if (!container) return;
      
      container.innerHTML = `
        <div class="card" style="background:linear-gradient(135deg, #667eea15 0%, #764ba215 100%);border:2px solid var(--brand);">
          <div style="display:flex;align-items:center;gap:12px;">
            <div class="loading-spinner" style="margin:0;"></div>
            <div style="flex:1;">
              <div style="font-weight:700;font-size:14px;color:var(--brand);margin-bottom:4px;">Loading Data...</div>
              <div style="font-size:12px;color:var(--muted);">${message}</div>
            </div>
          </div>
        </div>
      `;
    }

    function showSuccessStatus(message) {
      const container = document.getElementById('dataLoadStatus');
      if (!container) return;
      
      container.innerHTML = `
        <div class="success-banner">
          <div style="display:flex;align-items:center;gap:12px;">
            <div style="font-size:32px;">‚úÖ</div>
            <div style="flex:1;">
              <div style="font-weight:800;font-size:16px;margin-bottom:4px;">System Online - Ready for Bulk Upload!</div>
              <div style="font-size:13px;opacity:0.95;">${message}</div>
            </div>
          </div>
        </div>
      `;
      
      setTimeout(() => {
        if (container) container.innerHTML = '';
      }, 5000);
    }

    function showErrorStatus(message) {
      const container = document.getElementById('dataLoadStatus');
      if (!container) return;
      
      container.innerHTML = `
        <div class="card" style="background:linear-gradient(135deg, #fef3c7 0%, #fed7aa 100%);border:2px solid #f59e0b;">
          <div style="display:flex;align-items:center;gap:12px;">
            <div style="font-size:32px;">‚ö†Ô∏è</div>
            <div style="flex:1;">
              <div style="font-weight:700;font-size:14px;color:#d97706;margin-bottom:4px;">Connection Issue</div>
              <div style="font-size:12px;color:#92400e;">${message}</div>
            </div>
          </div>
        </div>
      `;
    }

    function showCriticalError(error) {
      const container = document.getElementById('dataLoadStatus');
      if (!container) return;
      
      const errorDetails = error.message || 'Unknown error';
      
      container.innerHTML = `
        <div class="error-banner">
          <div style="display:flex;align-items:flex-start;gap:12px;">
            <div style="font-size:40px;">‚ùå</div>
            <div style="flex:1;">
              <div style="font-weight:800;font-size:18px;margin-bottom:8px;">Unable to Load Real-Time Data</div>
              <div style="font-size:13px;opacity:0.95;margin-bottom:12px;">
                Failed to connect to Google Sheets after ${MAX_RETRY_ATTEMPTS} attempts.
              </div>
              <div style="background:rgba(255,255,255,0.2);padding:10px;border-radius:8px;margin-bottom:12px;font-family:monospace;font-size:11px;">
                Error: ${errorDetails}
              </div>
              <button onclick="location.reload()" class="btn-primary" style="background:white;color:#dc2626;padding:12px 24px;font-size:14px;">
                üîÑ Retry Connection
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('classSelect').disabled = true;
      document.getElementById('searchInput').disabled = true;
      document.getElementById('selectAllCheckbox').disabled = true;
      document.getElementById('submitBtn').disabled = true;
    }

    function populateClassDropdown() {
      const select = document.getElementById('classSelect');
      if (!select) return;
      
      const classSet = new Set();
      g_students.forEach(s => {
        if (s.class && s.class.trim()) {
          classSet.add(s.class.trim());
        }
      });
      
      const classes = Array.from(classSet).sort((a, b) => {
        if (a.toLowerCase() === 'nursery') return -1;
        if (b.toLowerCase() === 'nursery') return 1;
        const aNum = parseInt(a);
        const bNum = parseInt(b);
        if (!isNaN(aNum) && !isNaN(bNum)) return aNum - bNum;
        return a.localeCompare(b);
      });
      
      select.innerHTML = '<option value="">All Classes</option>';
      classes.forEach(cls => {
        const opt = document.createElement('option');
        opt.value = cls;
        opt.textContent = cls;
        select.appendChild(opt);
      });
    }

    function filterAndRender() {
      if (g_dataLoadStatus !== 'success') return;
      
      const classFilter = document.getElementById('classSelect')?.value || '';
      const searchText = document.getElementById('searchInput')?.value?.toLowerCase() || '';
      
      g_filteredStudents = g_students.filter(s => {
        const matchClass = !classFilter || s.class.trim() === classFilter.trim();
        const matchSearch = !searchText || 
          s.name.toLowerCase().includes(searchText) ||
          s.father.toLowerCase().includes(searchText) ||
          s.enrollment.toLowerCase().includes(searchText) ||
          (s.uid && s.uid.toLowerCase().includes(searchText));
        
        return matchClass && matchSearch;
      });
      
      // Clear selections from students not in current filter
      const filteredIdentifiers = new Set(g_filteredStudents.map(s => s.identifier));
      g_selectedUIDs = new Set([...g_selectedUIDs].filter(id => filteredIdentifiers.has(id)));
      
      const badgeEl = document.getElementById('classTotalBadge');
      if (badgeEl) {
        if (classFilter) {
          badgeEl.innerHTML = `<div class="class-total-badge">üìö ${classFilter}: ${g_filteredStudents.length} Students</div>`;
        } else {
          badgeEl.innerHTML = '';
        }
      }
      
      renderStudentList();
      updateSelectAllCheckbox();
    }

    function renderStudentList() {
      const container = document.getElementById('studentList');
      if (!container) return;
      
      if (g_dataLoadStatus !== 'success') {
        container.innerHTML = '<div style="padding:40px;text-align:center;color:var(--muted);">Loading students...</div>';
        return;
      }
      
      container.innerHTML = '';
      
      if (g_filteredStudents.length === 0) {
        container.innerHTML = '<div style="padding:40px;text-align:center;color:var(--muted);">No students found</div>';
        return;
      }
      
      g_filteredStudents.forEach(student => {
        const identifier = student.identifier;
        const isMarked = g_todayAttendance[identifier] !== undefined;
        const status = g_todayAttendance[identifier];
        
        const div = document.createElement('div');
        div.className = 'row-item';
        
        if (isMarked) {
          div.style.background = status === 'present' ? '#d1fae5' : '#fee2e2';
        } else if (g_selectedUIDs.has(identifier)) {
          div.classList.add('selected');
        }
        
        div.innerHTML = `
          <div class="student-info">
            <div class="name">${student.name} ${isMarked ? (status === 'present' ? '‚úÖ' : '‚ùå') : ''}</div>
            <div class="meta">
              üë®‚Äçüëß ${student.father} | 
              üéì ${student.class} | 
              üÜî ${student.enrollment || student.uid || 'N/A'}
            </div>
          </div>
          ${isMarked ? 
            `<button class="btn-primary btn-${status === 'present' ? 'danger' : 'success'}" style="padding:8px 16px;font-size:12px;" onclick="editAttendance('${identifier}')">
              ${status === 'present' ? 'Mark Absent' : 'Mark Present'}
            </button>` :
            `<input type="checkbox" 
                   class="student-checkbox" 
                   data-identifier="${identifier}"
                   ${g_selectedUIDs.has(identifier) ? 'checked' : ''}>`
          }
        `;
        
        container.appendChild(div);
      });
      
      document.querySelectorAll('.student-checkbox').forEach(cb => {
        cb.addEventListener('change', handleCheckboxChange);
      });
      
      updateSelectedCount();
    }

    function editAttendance(identifier) {
      const currentStatus = g_todayAttendance[identifier];
      const newStatus = currentStatus === 'present' ? 'absent' : 'present';
      
      if (confirm(`Change attendance from ${currentStatus} to ${newStatus}?`)) {
        g_todayAttendance[identifier] = newStatus;
        saveToLocalStorage();
        renderStudentList();
        
        const student = g_students.find(s => s.identifier === identifier);
        if (student) {
          uploadSingleAttendance(student, newStatus);
        }
      }
    }

    function handleCheckboxChange(e) {
      const cb = e.target;
      const identifier = cb.dataset.identifier;
      
      if (cb.checked) {
        g_selectedUIDs.add(identifier);
        cb.closest('.row-item').classList.add('selected');
      } else {
        g_selectedUIDs.delete(identifier);
        cb.closest('.row-item').classList.remove('selected');
      }
      
      updateSelectedCount();
      updateSelectAllCheckbox();
      saveToLocalStorage();
    }

    document.getElementById('selectAllCheckbox')?.addEventListener('change', (e) => {
      const checked = e.target.checked;
      
      g_filteredStudents.forEach(s => {
        const id = s.identifier;
        if (!g_todayAttendance[id]) {
          if (checked) {
            g_selectedUIDs.add(id);
          } else {
            g_selectedUIDs.delete(id);
          }
        }
      });
      
      renderStudentList();
      saveToLocalStorage();
    });

    function updateSelectAllCheckbox() {
      const checkbox = document.getElementById('selectAllCheckbox');
      if (!checkbox) return;
      
      const unmarkedStudents = g_filteredStudents.filter(s => !g_todayAttendance[s.identifier]);
      const allSelected = unmarkedStudents.length > 0 && 
        unmarkedStudents.every(s => g_selectedUIDs.has(s.identifier));
      
      checkbox.checked = allSelected;
    }

    function updateSelectedCount() {
      // Count only selected students that are in the current filtered list
      const count = g_filteredStudents.filter(s => g_selectedUIDs.has(s.identifier)).length;
      document.getElementById('selectedCount').textContent = `${count} Selected`;
    }

    // ===== FIXED BULK ATTENDANCE SUBMISSION =====
    document.getElementById('submitBtn')?.addEventListener('click', submitAttendance);

    async function submitAttendance() {
      if (g_dataLoadStatus !== 'success') {
        alert('‚ùå Cannot submit: Student data not loaded!');
        return;
      }

      if (g_selectedUIDs.size === 0) {
        alert('‚ùå Please select at least one student!');
        return;
      }

      // IMPORTANT: Filter from g_filteredStudents (current class), not g_students (all classes)
      const selectedStudents = g_filteredStudents.filter(s => 
        g_selectedUIDs.has(s.identifier) && !g_todayAttendance[s.identifier]
      );

      if (selectedStudents.length === 0) {
        alert('‚ùå All selected students have already been marked!');
        return;
      }

      // Confirm for large batches
      if (selectedStudents.length > 20) {
        const estimatedTime = Math.ceil(selectedStudents.length * 0.4); // ~0.4 seconds per student in batches
        if (!confirm(`‚ö†Ô∏è You are about to mark ${selectedStudents.length} students present.\n\nThis will take about ${estimatedTime} seconds.\n\nContinue?`)) {
          return;
        }
      }

      g_pendingUploads.push(...selectedStudents);
      saveToLocalStorage();

      const total = selectedStudents.length;
      let success = 0, duplicate = 0, failed = 0;
      let processed = 0;

      const btn = document.getElementById('submitBtn');
      btn.disabled = true;
      btn.textContent = `Starting upload...`;

      showUploadToast(0, total);

      // ===== BATCH PROCESSING FOR SPEED =====
      // Process 5 students at a time in parallel
      const BATCH_SIZE = 5;
      
      for (let i = 0; i < selectedStudents.length; i += BATCH_SIZE) {
        const batch = selectedStudents.slice(i, i + BATCH_SIZE);
        
        // Process batch in parallel
        const batchPromises = batch.map(async (student) => {
          try {
            const result = await uploadSingleAttendance(student, 'present');
            
            if (result.success) {
              success++;
              g_sessionStats.totalUploaded++;
              g_sessionStats.totalScanned++;
              g_todayAttendance[student.identifier] = 'present';
              g_allAttendance[student.identifier] = g_allAttendance[student.identifier] || [];
              g_allAttendance[student.identifier].push({date: new Date().toLocaleDateString(), status: 'present'});
              g_selectedUIDs.delete(student.identifier);
              g_pendingUploads = g_pendingUploads.filter(s => s.identifier !== student.identifier);
              return 'success';
            } else if (result.alreadyMarked) {
              duplicate++;
              g_sessionStats.totalDuplicate++;
              g_todayAttendance[student.identifier] = 'present';
              g_selectedUIDs.delete(student.identifier);
              g_pendingUploads = g_pendingUploads.filter(s => s.identifier !== student.identifier);
              return 'duplicate';
            } else {
              failed++;
              g_sessionStats.totalFailed++;
              return 'failed';
            }
          } catch (error) {
            console.error('‚ùå Upload error:', error);
            failed++;
            g_sessionStats.totalFailed++;
            return 'error';
          }
        });
        
        // Wait for batch to complete
        await Promise.all(batchPromises);
        
        processed = Math.min(i + BATCH_SIZE, total);
        btn.textContent = `Uploading ${processed}/${total}...`;
        updateUploadToast(processed, total, success, duplicate, failed);
        
        // Small delay between batches (300ms instead of 800ms per student)
        if (i + BATCH_SIZE < selectedStudents.length) {
          await new Promise(r => setTimeout(r, 300));
        }
      }

      g_sessionStats.queueSize = g_pendingUploads.length;

      btn.disabled = false;
      btn.textContent = '‚úì Submit Attendance';
      hideUploadToast();

      saveToLocalStorage();
      renderStudentList();
      updateSystemInfo();

      const message = `üìä Upload Complete!\n\n‚úÖ Success: ${success}\n‚ö†Ô∏è Duplicate: ${duplicate}\n‚ùå Failed: ${failed}\n\nTotal Processed: ${processed}/${total}`;
      alert(message);
    }

    async function uploadSingleAttendance(student, status) {
      let url = `${SCRIPT_URL}?action=insert&status=${status}`;
      
      if (student.enrollment) {
        url += `&enrollment=${encodeURIComponent(student.enrollment)}`;
      }
      
      url += `&name=${encodeURIComponent(student.name)}`;
      url += `&father=${encodeURIComponent(student.father)}`;
      
      if (student.uid) {
        url += `&uid=${encodeURIComponent(student.uid)}`;
      }
      
      console.log(`üì§ Uploading: ${student.name} - ${status}`);
      
      const response = await fetch(url, { method: 'GET' });
      const result = await response.json();
      
      console.log(`üì• Response:`, result);
      return result;
    }

    async function processPendingUploads() {
      if (g_pendingUploads.length === 0) return;
      
      console.log(`üîÑ Processing ${g_pendingUploads.length} pending uploads...`);
      
      const uploads = [...g_pendingUploads];
      
      for (const student of uploads) {
        try {
          const result = await uploadSingleAttendance(student, 'present');
          if (result.success || result.alreadyMarked) {
            g_pendingUploads = g_pendingUploads.filter(s => s.identifier !== student.identifier);
            g_todayAttendance[student.identifier] = 'present';
          }
        } catch (error) {
          console.error('Background upload failed:', error);
        }
      }
      
      g_sessionStats.queueSize = g_pendingUploads.length;
      saveToLocalStorage();
      console.log(`‚úÖ Background uploads complete. ${g_pendingUploads.length} remaining.`);
    }

    document.getElementById('searchInput')?.addEventListener('input', (e) => {
      filterAndRender();
    });

    // ===== STUDENT INFO SEARCH =====
    const studentSearchInput = document.getElementById('singleStudentSearch');
    const studentSearchDropdown = document.getElementById('studentSearchDropdown');
    
    studentSearchInput?.addEventListener('input', (e) => {
      const searchText = e.target.value.trim().toLowerCase();
      
      if (!searchText || searchText.length < 2) {
        studentSearchDropdown.classList.remove('show');
        return;
      }
      
      if (g_dataLoadStatus !== 'success' || g_students.length === 0) {
        studentSearchDropdown.innerHTML = '<div class="autocomplete-empty">No student data loaded</div>';
        studentSearchDropdown.classList.add('show');
        return;
      }
      
      const matchedStudents = g_students.filter(s => {
        return s.name.toLowerCase().includes(searchText) ||
               s.father.toLowerCase().includes(searchText) ||
               s.enrollment.toLowerCase().includes(searchText) ||
               (s.uid && s.uid.toLowerCase().includes(searchText));
      }).slice(0, 10);
      
      if (matchedStudents.length === 0) {
        studentSearchDropdown.innerHTML = '<div class="autocomplete-empty">No students found</div>';
        studentSearchDropdown.classList.add('show');
        return;
      }
      
      studentSearchDropdown.innerHTML = matchedStudents.map(s => `
        <div class="autocomplete-item" onclick="showStudentDetails('${s.identifier}')">
          <div class="autocomplete-item-avatar ${s.gender.toLowerCase() === 'm' ? 'male' : 'female'}">
            ${s.gender === 'M' ? 'üë®‚Äçüéì' : 'üë©‚Äçüéì'}
          </div>
          <div class="autocomplete-item-info">
            <div class="autocomplete-item-name">${s.name}</div>
            <div class="autocomplete-item-meta">
              <span>üë®‚Äçüëß ${s.father}</span>
              <span class="autocomplete-item-badge">üéì ${s.class}</span>
              <span class="autocomplete-item-badge">üÜî ${s.enrollment || s.uid || 'N/A'}</span>
            </div>
          </div>
        </div>
      `).join('');
      
      studentSearchDropdown.classList.add('show');
    });
    
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.autocomplete-container')) {
        studentSearchDropdown?.classList.remove('show');
      }
    });
    
    function showStudentDetails(identifier) {
      const student = g_students.find(s => s.identifier === identifier);
      if (!student) return;
      
      studentSearchDropdown.classList.remove('show');
      studentSearchInput.value = student.name;
      
      const detailResult = document.getElementById('studentDetailResult');
      if (!detailResult) return;
      
      const attendanceStatus = g_todayAttendance[identifier];
      const attendanceBadge = attendanceStatus === 'present' ? 
        '<div style="display:inline-block;background:#10b981;color:white;padding:10px 22px;border-radius:30px;font-weight:700;">‚úÖ Present Today</div>' :
        attendanceStatus === 'absent' ?
        '<div style="display:inline-block;background:#ef4444;color:white;padding:10px 22px;border-radius:30px;font-weight:700;">‚ùå Absent Today</div>' :
        '<div style="display:inline-block;background:#f59e0b;color:white;padding:10px 22px;border-radius:30px;font-weight:700;">‚è≥ Not Marked</div>';
      
      detailResult.innerHTML = `
        <div class="card" style="margin-top:16px;">
          <div style="text-align:center;margin-bottom:20px;">
            <div style="font-size:60px;margin-bottom:10px;">${student.gender === 'M' ? 'üë®‚Äçüéì' : 'üë©‚Äçüéì'}</div>
            <div style="font-size:24px;font-weight:700;margin-bottom:10px;">${student.name}</div>
            <div style="font-size:15px;color:var(--muted);margin-bottom:16px;">S/O: ${student.father}</div>
            ${attendanceBadge}
          </div>
          <div style="display:grid;gap:12px;">
            <div style="padding:12px;background:var(--brand-light);border-radius:8px;">
              <strong>Class:</strong> ${student.class}
            </div>
            <div style="padding:12px;background:var(--brand-light);border-radius:8px;">
              <strong>Enrollment:</strong> ${student.enrollment || 'N/A'}
            </div>
            ${student.uid ? `<div style="padding:12px;background:var(--brand-light);border-radius:8px;">
              <strong>RFID:</strong> ${student.uid}
            </div>` : ''}
            ${student.mobile ? `<div style="padding:12px;background:var(--brand-light);border-radius:8px;">
              <strong>Mobile:</strong> <a href="tel:${student.mobile}">${student.mobile}</a>
            </div>` : ''}
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:16px;">
            <button onclick="markStudentAttendance('${identifier}', 'present')" 
                    class="btn-primary btn-success" style="padding:14px;">
              ‚úÖ Mark Present
            </button>
            <button onclick="markStudentAttendance('${identifier}', 'absent')" 
                    class="btn-primary btn-danger" style="padding:14px;">
              ‚ùå Mark Absent
            </button>
          </div>
        </div>
      `;
    }
    
    function markStudentAttendance(identifier, status) {
      const student = g_students.find(s => s.identifier === identifier);
      if (!student) return;
      
      if (confirm(`Mark ${student.name} as ${status}?`)) {
        g_todayAttendance[identifier] = status;
        saveToLocalStorage();
        
        showStudentDetails(identifier);
        uploadSingleAttendance(student, status);
        
        alert(`‚úÖ ${student.name} marked as ${status}!`);
      }
    }
    
    window.showStudentDetails = showStudentDetails;
    window.markStudentAttendance = markStudentAttendance;
    window.editAttendance = editAttendance;

    function showUploadToast(current, total) {
      const existing = document.getElementById('uploadToast');
      if (existing) existing.remove();

      const toast = document.createElement('div');
      toast.id = 'uploadToast';
      toast.className = 'upload-toast';
      toast.innerHTML = `
        <div style="font-weight:700;margin-bottom:8px;">üì§ Uploading Attendance...</div>
        <div class="upload-progress-bar">
          <div class="upload-progress-fill" style="width:0%"></div>
        </div>
        <div id="uploadStats" style="font-size:12px;color:var(--muted);margin-top:6px;">
          0 / ${total} uploaded
        </div>
      `;
      document.body.appendChild(toast);
    }

    function updateUploadToast(current, total, success, duplicate, failed) {
      const progress = (current / total) * 100;
      const fill = document.querySelector('.upload-progress-fill');
      const stats = document.getElementById('uploadStats');
      
      if (fill) fill.style.width = `${progress}%`;
      if (stats) {
        stats.innerHTML = `${current} / ${total} | ‚úÖ ${success} | ‚ö†Ô∏è ${duplicate} | ‚ùå ${failed}`;
      }
    }

    function hideUploadToast() {
      setTimeout(() => {
        const toast = document.getElementById('uploadToast');
        if (toast) toast.remove();
      }, 2000);
    }

    function updateSystemInfo() {
      const content = document.getElementById('systemInfoContent');
      if (!content) return;
      
      const totalStudents = g_students.length;
      const currentTime = new Date().toLocaleString('en-GB', { timeZone: 'Asia/Karachi' });
      const dataStatus = g_dataLoadStatus === 'success' ? 'success' : 
                        g_dataLoadStatus === 'loading' ? 'warning' : 'error';
      const dataStatusText = g_dataLoadStatus === 'success' ? '‚úÖ Loaded' : 
                            g_dataLoadStatus === 'loading' ? '‚è≥ Loading' : '‚ùå Error';
      
      content.innerHTML = `
        ${g_dataLoadStatus === 'success' ? `
        <div class="system-ready-banner">
          <div style="font-size:36px;margin-bottom:10px;">üì°</div>
          <div style="font-size:20px;font-weight:800;margin-bottom:6px;">System Ready - Bulk Upload Fixed!</div>
          <div style="font-size:13px;opacity:0.9;margin-top:8px;">‚úÖ ${totalStudents} students | Fast batch processing enabled</div>
        </div>
        ` : ''}

        <div class="card">
          <h3 style="color:var(--brand);margin-bottom:16px;">üìä System Status</h3>
          <div style="display:grid;gap:10px;">
            <div style="display:flex;justify-content:space-between;padding:12px;background:var(--brand-light);border-radius:8px;">
              <span style="font-weight:600;">Data Status</span>
              <span class="status-badge ${dataStatus}">${dataStatusText}</span>
            </div>
            <div style="display:flex;justify-content:space-between;padding:12px;background:var(--brand-light);border-radius:8px;">
              <span style="font-weight:600;">Total Students</span>
              <span style="font-weight:700;">${totalStudents}</span>
            </div>
            <div style="display:flex;justify-content:space-between;padding:12px;background:var(--brand-light);border-radius:8px;">
              <span style="font-weight:600;">System Time</span>
              <span style="font-weight:700;">${currentTime}</span>
            </div>
            <div style="display:flex;justify-content:space-between;padding:12px;background:var(--brand-light);border-radius:8px;">
              <span style="font-weight:600;">Script Version</span>
              <span style="font-weight:700;">${SCRIPT_VERSION}</span>
            </div>
          </div>
        </div>
      `;
    }

    function saveToLocalStorage() {
      const today = new Date().toLocaleDateString('en-GB');
      localStorage.setItem('attendanceDate', today);
      localStorage.setItem('todayAttendance', JSON.stringify(g_todayAttendance));
      localStorage.setItem('allAttendance', JSON.stringify(g_allAttendance));
      localStorage.setItem('selectedUIDs', JSON.stringify([...g_selectedUIDs]));
      localStorage.setItem('sessionStats', JSON.stringify(g_sessionStats));
      localStorage.setItem('pendingUploads', JSON.stringify(g_pendingUploads));
    }

    function loadFromLocalStorage() {
      const today = new Date().toLocaleDateString('en-GB');
      const storedDate = localStorage.getItem('attendanceDate');
      
      if (storedDate === today) {
        const attendance = localStorage.getItem('todayAttendance');
        const allAttendance = localStorage.getItem('allAttendance');
        const selected = localStorage.getItem('selectedUIDs');
        const stats = localStorage.getItem('sessionStats');
        const pending = localStorage.getItem('pendingUploads');
        
        if (attendance) g_todayAttendance = JSON.parse(attendance);
        if (allAttendance) g_allAttendance = JSON.parse(allAttendance);
        if (selected) g_selectedUIDs = new Set(JSON.parse(selected));
        if (stats) g_sessionStats = JSON.parse(stats);
        if (pending) g_pendingUploads = JSON.parse(pending);
        
        console.log('‚úÖ Loaded from localStorage');
        
        if (g_pendingUploads.length > 0) {
          console.log(`üîÑ Found ${g_pendingUploads.length} pending uploads`);
          setTimeout(processPendingUploads, 2000);
        }
      } else {
        localStorage.removeItem('todayAttendance');
        localStorage.removeItem('selectedUIDs');
        g_todayAttendance = {};
        g_selectedUIDs = new Set();
      }
    }

    document.getElementById('loginBtn')?.addEventListener('click', handleLogin);
    document.getElementById('pinInput')?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') handleLogin();
    });

    function handleLogin() {
      const pin = document.getElementById('pinInput').value.trim();
      const errorEl = document.getElementById('loginError');
      
      if (pin === PIN) {
        errorEl.textContent = '';
        document.getElementById('viewLogin').classList.add('hidden');
        document.getElementById('viewMain').classList.remove('hidden');
        initializeApp();
      } else {
        errorEl.textContent = '‚ùå Invalid Password!';
        setTimeout(() => errorEl.textContent = '', 3000);
      }
    }

    setInterval(() => {
      const now = new Date();
      const dateStr = now.toLocaleDateString('en-GB');
      const timeStr = now.toLocaleTimeString('en-GB');
      const el = document.getElementById('loginDateTime');
      if (el) el.textContent = `${dateStr} ${timeStr}`;
    }, 1000);

    function initializeApp() {
      console.log('üöÄ Initializing GPS Sheinwal App v8.1 FIXED...');
      loadFromLocalStorage();
      loadAllStudentsFast();
      startAutoSync();
    }

    function startAutoSync() {
      g_autoSyncInterval = setInterval(() => {
        console.log('üîÑ Auto-sync triggered...');
        saveToLocalStorage();
        if (g_pendingUploads.length > 0) {
          processPendingUploads();
        }
      }, 5 * 60 * 1000);
    }

    document.querySelectorAll('.main-tabs button').forEach(btn => {
      btn.addEventListener('click', (e) => {
        document.querySelectorAll('.main-tabs button').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        
        const sections = ['sectionAttendance', 'sectionReports', 'sectionRoznamcha', 'sectionSystemInfo'];
        sections.forEach(s => {
          const el = document.getElementById(s);
          if (el) el.classList.add('hidden');
        });
        
        if (e.target.id === 'tabAttendance') document.getElementById('sectionAttendance')?.classList.remove('hidden');
        if (e.target.id === 'tabReports') document.getElementById('sectionReports')?.classList.remove('hidden');
        if (e.target.id === 'tabRoznamcha') document.getElementById('sectionRoznamcha')?.classList.remove('hidden');
        if (e.target.id === 'tabSystemInfo') {
          document.getElementById('sectionSystemInfo')?.classList.remove('hidden');
          updateSystemInfo();
        }
      });
    });

    document.querySelectorAll('.sub-tabs button').forEach(btn => {
      btn.addEventListener('click', (e) => {
        document.querySelectorAll('.sub-tabs button').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        
        const sections = ['subSectionManual', 'subSectionQR', 'subSectionStudentInfo'];
        sections.forEach(s => {
          const el = document.getElementById(s);
          if (el) el.classList.add('hidden');
        });
        
        if (e.target.id === 'subTabManual') document.getElementById('subSectionManual')?.classList.remove('hidden');
        if (e.target.id === 'subTabQR') document.getElementById('subSectionQR')?.classList.remove('hidden');
        if (e.target.id === 'subTabStudentInfo') document.getElementById('subSectionStudentInfo')?.classList.remove('hidden');
      });
    });

    document.getElementById('classSelect')?.addEventListener('change', filterAndRender);

    console.log('üì± GPS Sheinwal v8.1 FIXED loaded - Bulk attendance now working!');

    window.addEventListener('beforeunload', () => {
      saveToLocalStorage();
    });
  </script>
</body>
</html>
