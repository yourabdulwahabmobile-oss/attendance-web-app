<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GPS Sheinwal - RF Attendance v8.0</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    
    :root{
      --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --bg:#f8fafc; 
      --card:#ffffff; 
      --text:#1e293b; 
      --muted:#64748b;
      --brand:#6366f1; 
      --brand-hover:#4f46e5;
      --brand-light:#eef2ff;
      --ok:#10b981; 
      --warn:#f59e0b; 
      --bad:#ef4444;
      --border:#e2e8f0; 
      --shadow:0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
      --shadow-lg:0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
    }
    
    * { box-sizing: border-box; margin:0; padding:0; }
    
    html,body{
      min-height:100%;
      background:var(--bg);
      color:var(--text);
      font-family:'Inter',system-ui,-apple-system,sans-serif;
      line-height:1.6;
    }

    header{
      position:sticky;
      top:0;
      z-index:50;
      background:var(--bg-gradient);
      color:#fff;
      text-align:center;
      padding:20px 16px;
      box-shadow:var(--shadow-lg);
    }
    
    .school-name{
      font-size:clamp(20px, 5vw, 28px);
      font-weight:800;
      margin-bottom:6px;
      text-shadow:0 2px 4px rgba(0,0,0,0.1);
      letter-spacing:-0.5px;
    }
    
    .bar h1{
      font-size:clamp(16px, 4vw, 20px);
      margin:0;
      font-weight:600;
      letter-spacing:0.5px;
      opacity:0.95;
    }

    .sync-status {
      position: absolute;
      top: 16px;
      right: 16px;
      background: rgba(255,255,255,0.2);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
      backdrop-filter: blur(10px);
    }

    .sync-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #10b981;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:clamp(12px, 3vw, 24px);
    }

    .card{
      background:var(--card);
      border-radius:20px;
      box-shadow:var(--shadow-lg);
      padding:clamp(20px, 4vw, 32px);
      border:1px solid var(--border);
    }

    .main-tabs{
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:12px;
      margin-bottom:24px;
    }
    
    .main-tabs button{
      padding:16px;
      border-radius:16px;
      border:2px solid transparent;
      background:var(--card);
      cursor:pointer;
      font-weight:700;
      font-size:16px;
      transition:all 0.3s;
      box-shadow:var(--shadow);
      color:var(--text);
    }
    
    .main-tabs button:hover{
      transform:translateY(-2px);
      box-shadow:0 8px 16px -4px rgba(99,102,241,0.3);
    }
    
    .main-tabs button.active{
      background:var(--bg-gradient);
      color:#fff;
      box-shadow:0 8px 16px -4px rgba(99,102,241,0.5);
    }

    .sub-tabs{
      display:flex;
      gap:8px;
      margin:16px 0;
      flex-wrap:wrap;
      border-bottom:2px solid var(--border);
      padding-bottom:8px;
    }
    
    .sub-tabs button{
      padding:10px 20px;
      border:none;
      background:transparent;
      cursor:pointer;
      font-weight:600;
      font-size:14px;
      color:var(--muted);
      border-bottom:3px solid transparent;
      transition:all 0.2s;
    }
    
    .sub-tabs button:hover{
      color:var(--brand);
    }
    
    .sub-tabs button.active{
      color:var(--brand);
      border-bottom-color:var(--brand);
    }

    .report-options{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
      gap:12px;
      margin:16px 0;
    }

    .report-card{
      background:linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
      border:2px solid var(--border);
      border-radius:12px;
      padding:20px;
      text-align:center;
      transition:all 0.3s;
      cursor:pointer;
    }

    .report-card:hover{
      transform:translateY(-4px);
      box-shadow:var(--shadow-lg);
      border-color:var(--brand);
    }

    .report-card h3{
      margin:0 0 12px 0;
      font-size:18px;
      color:var(--brand);
    }

    .download-btn{
      width:100%;
      padding:10px;
      border:none;
      border-radius:8px;
      background:var(--brand);
      color:white;
      font-weight:600;
      cursor:pointer;
      transition:all 0.2s;
      font-size:14px;
    }

    .download-btn:hover{
      background:var(--brand-hover);
      transform:scale(1.02);
    }

    .toolbar{
      display:flex;
      gap:12px;
      align-items:flex-end;
      margin:20px 0;
      flex-wrap:wrap;
    }
    
    .toolbar > div {
      flex: 1;
      min-width: 200px;
    }
    
    .label-text{
      font-weight:600;
      font-size:13px;
      color:var(--text);
      margin-bottom:6px;
      display:block;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    
    input,select{
      padding:12px 16px;
      border-radius:12px;
      border:2px solid var(--border);
      font-size:15px;
      width:100%;
      transition:all 0.2s;
      background:var(--card);
      font-family:inherit;
    }
    
    input:focus,select:focus{
      outline:none;
      border-color:var(--brand);
      box-shadow:0 0 0 3px var(--brand-light);
    }

    .list{
      background:var(--card);
      border:2px solid var(--border);
      border-radius:16px;
      overflow:hidden;
      margin-top:16px;
      box-shadow:var(--shadow);
      max-height: 500px;
      overflow-y: auto;
    }
    
    .row-item{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:16px 20px;
      border-top:1px solid var(--border);
      transition:all 0.2s;
      gap:12px;
    }
    
    .row-item:first-child{border-top:none}
    
    .row-item:hover{
      background:var(--brand-light);
      transform:translateX(4px);
    }
    
    .student-info{
      flex:1;
    }

    .name{
      font-weight:700;
      font-size:16px;
      color:var(--text);
      margin-bottom:4px;
    }
    
    .meta{
      font-size:13px;
      color:var(--muted);
      font-weight:500;
    }

    .status-badge {
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor:pointer;
      transition:all 0.2s;
      border:none;
    }

    .status-badge:hover{
      transform:scale(1.05);
    }

    .status-present {
      background: #d1fae5;
      color: #065f46;
    }

    .status-absent {
      background: #fee2e2;
      color: #991b1b;
    }

    .status-pending {
      background: #fef3c7;
      color: #92400e;
    }

    .fab{
      position:fixed;
      bottom:24px;
      left:50%;
      transform:translateX(-50%);
      z-index:100;
    }
    
    .fab button{
      min-width:240px;
      padding:16px 32px;
      border-radius:50px;
      font-size:16px;
      font-weight:700;
      background:var(--bg-gradient);
      color:#fff;
      border:none;
      box-shadow:0 10px 25px -5px rgba(99,102,241,0.5);
      cursor:pointer;
      transition:all 0.3s;
    }
    
    .fab button:hover{
      transform:translateY(-3px);
      box-shadow:0 15px 30px -5px rgba(99,102,241,0.6);
    }

    .hidden{display:none!important}

    .summary-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));
      gap:16px;
      margin:20px 0;
    }

    .summary-card{
      background:linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
      border:2px solid var(--border);
      border-radius:16px;
      padding:24px;
      box-shadow:var(--shadow);
    }

    .summary-card h3{
      margin:0 0 16px 0;
      color:var(--brand);
      font-size:18px;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .stat-row{
      display:flex;
      justify-content:space-between;
      padding:8px 0;
      border-bottom:1px solid var(--border);
    }

    .stat-row:last-child{
      border-bottom:none;
    }

    .stat-label{
      font-weight:600;
      color:var(--text);
    }

    .stat-value{
      font-weight:700;
      color:var(--brand);
    }

    .diagnostic-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
      gap:12px;
      margin:20px 0;
    }

    .diag-item{
      background:var(--card);
      border:2px solid var(--border);
      border-radius:12px;
      padding:16px;
      text-align:center;
    }

    .diag-status{
      font-size:24px;
      margin-bottom:8px;
    }

    .diag-label{
      font-size:13px;
      color:var(--muted);
      font-weight:600;
    }

    .diag-value{
      font-size:14px;
      color:var(--text);
      font-weight:700;
      margin-top:4px;
    }

    .qr-scanner{
      text-align:center;
      padding:60px 20px;
    }

    .qr-scanner-icon{
      font-size:80px;
      margin-bottom:20px;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(5px);
    }

    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      color: white;
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .login-container {
      text-align:center;
      max-width:440px;
      margin:60px auto 40px;
    }
    
    .login-icon {
      width:80px;
      height:80px;
      margin:0 auto 20px;
      background:var(--bg-gradient);
      border-radius:20px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:40px;
      box-shadow:var(--shadow-lg);
    }
    
    @media (max-width: 768px) {
      .main-tabs { grid-template-columns:1fr; }
      .wrap { padding:12px; }
      .toolbar { flex-direction:column; }
      .toolbar > div { width:100%; min-width:unset; }
      .sync-status { position:static; margin-bottom:10px; }
      .summary-grid { grid-template-columns:1fr; }
      header { position:relative; }
    }
  </style>
</head>
<body>
  <div id="loadingOverlay" class="loading-overlay hidden">
    <div class="loading-spinner"></div>
    <div class="loading-text" id="loadingText">Loading Data...</div>
  </div>

  <header>
    <div class="sync-status" id="syncStatus">
      <div class="sync-dot"></div>
      <span id="syncText">Offline Ready</span>
    </div>
    <div class="school-name">ğŸ“ GPS Sheinwal (Shamaskay)</div>
    <div class="bar"><h1>RF Attendance Management System v8.0</h1></div>
  </header>
  
  <div class="wrap">
    <!-- LOGIN VIEW -->
    <section id="viewLogin" class="card login-container">
      <div class="login-icon">ğŸ”</div>
      <div style="font-size:28px;font-weight:800;margin-bottom:8px;color:var(--text);">Secure Login</div>
      <div style="color:var(--muted);margin-bottom:24px;font-size:15px;">Enter your PIN to access system</div>
      <div id="loginDateTime" style="color:var(--muted);margin-bottom:20px;font-size:14px;"></div>
      <input id="pinInput" type="password" inputmode="numeric" maxlength="20" placeholder="Enter PIN" 
        style="width:85%;padding:14px 20px;text-align:center;letter-spacing:3px;margin-bottom:20px;font-size:18px;" />
      <button id="loginBtn" style="padding:14px 40px;border:none;border-radius:12px;background:var(--bg-gradient);
        color:white;font-size:16px;font-weight:700;cursor:pointer;box-shadow:0 4px 12px rgba(99,102,241,0.4);transition:all 0.3s;">
        Login â†’
      </button>
      <div id="loginError" style="margin-top:16px;color:var(--bad);font-weight:600;font-size:14px;"></div>
    </section>

    <!-- MAIN VIEW -->
    <section id="viewMain" class="hidden">
      <!-- Main Tabs -->
      <div class="main-tabs">
        <button id="tabAttendance" class="active">ğŸ“‹ Attendance</button>
        <button id="tabQR">ğŸ“± QR Code</button>
        <button id="tabDiagnostic">ğŸ”§ Diagnostic</button>
      </div>

      <!-- ==================== ATTENDANCE SECTION ==================== -->
      <div id="sectionAttendance">
        <!-- Sub Tabs -->
        <div class="sub-tabs">
          <button id="subMarkAttendance" class="active">Today Attendance</button>
          <button id="subReports">Reports</button>
          <button id="subSummary">Summary</button>
        </div>

        <!-- Mark Attendance Content -->
        <div id="contentMarkAttendance">
          <div class="toolbar">
            <div>
              <span class="label-text">ğŸ“š Select Class</span>
              <select id="classSelect">
                <option value="">All Classes</option>
              </select>
            </div>
            <div>
              <span class="label-text">ğŸ” Search Student</span>
              <input type="text" id="searchInput" placeholder="Search by name, father name or UID..." />
            </div>
          </div>
          <div id="studentList" class="list"></div>
          <div class="fab hidden" id="submitFab">
            <button id="submitBtn">âœ“ Submit Attendance</button>
          </div>
        </div>

        <!-- Reports Content -->
        <div id="contentReports" class="hidden">
          <div class="sub-tabs" style="border:none;">
            <button id="reportToday" class="active">Today</button>
            <button id="reportSevenDays">Last 7 Days</button>
            <button id="reportMonthly">Monthly</button>
            <button id="reportAbsentList">Absent List</button>
          </div>

          <div id="reportTodayContent">
            <div class="report-options">
              <div class="report-card">
                <h3>âœ… Present Report</h3>
                <button class="download-btn" onclick="downloadReport('today-present')">ğŸ“¥ Download CSV</button>
              </div>
              <div class="report-card">
                <h3>âŒ Absent Report</h3>
                <button class="download-btn" onclick="downloadReport('today-absent')">ğŸ“¥ Download CSV</button>
              </div>
              <div class="report-card">
                <h3>ğŸ‘¥ All Students</h3>
                <button class="download-btn" onclick="downloadReport('today-all')">ğŸ“¥ Download CSV</button>
              </div>
            </div>
          </div>

          <div id="reportSevenDaysContent" class="hidden">
            <div class="report-options">
              <div class="report-card">
                <h3>âœ… Present Report</h3>
                <button class="download-btn" onclick="downloadReport('7days-present')">ğŸ“¥ Download CSV</button>
              </div>
              <div class="report-card">
                <h3>âŒ Absent Report</h3>
                <button class="download-btn" onclick="downloadReport('7days-absent')">ğŸ“¥ Download CSV</button>
              </div>
              <div class="report-card">
                <h3>ğŸ‘¥ All Students</h3>
                <button class="download-btn" onclick="downloadReport('7days-all')">ğŸ“¥ Download CSV</button>
              </div>
            </div>
          </div>

          <div id="reportMonthlyContent" class="hidden">
            <div class="report-options">
              <div class="report-card">
                <h3>âœ… Present Report</h3>
                <button class="download-btn" onclick="downloadReport('monthly-present')">ğŸ“¥ Download CSV</button>
              </div>
              <div class="report-card">
                <h3>âŒ Absent Report</h3>
                <button class="download-btn" onclick="downloadReport('monthly-absent')">ğŸ“¥ Download CSV</button>
              </div>
              <div class="report-card">
                <h3>ğŸ‘¥ All Students</h3>
                <button class="download-btn" onclick="downloadReport('monthly-all')">ğŸ“¥ Download CSV</button>
              </div>
            </div>
          </div>

          <div id="reportAbsentListContent" class="hidden">
            <div class="report-options">
              <div class="report-card">
                <h3>ğŸ“… Today Absent</h3>
                <button class="download-btn" onclick="downloadReport('absent-today')">ğŸ“¥ Download List</button>
              </div>
              <div class="report-card">
                <h3>ğŸ“… Last 7 Days</h3>
                <button class="download-btn" onclick="downloadReport('absent-7days')">ğŸ“¥ Download List</button>
              </div>
              <div class="report-card">
                <h3>ğŸ“… Monthly</h3>
                <button class="download-btn" onclick="downloadReport('absent-monthly')">ğŸ“¥ Download List</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Summary Content -->
        <div id="contentSummary" class="hidden">
          <div class="summary-grid">
            <div class="summary-card">
              <h3>ğŸ“… Today's Attendance</h3>
              <div class="stat-row">
                <span class="stat-label">Total Students</span>
                <span class="stat-value" id="todayTotal">0</span>
              </div>
              <div class="stat-row">
                <span class="stat-label">Present</span>
                <span class="stat-value" style="color:var(--ok)" id="todayPresent">0 (0%)</span>
              </div>
              <div class="stat-row">
                <span class="stat-label">Absent</span>
                <span class="stat-value" style="color:var(--bad)" id="todayAbsent">0 (0%)</span>
              </div>
            </div>

            <div class="summary-card">
              <h3>ğŸ“Š Last 7 Days</h3>
              <div class="stat-row">
                <span class="stat-label">Total Students</span>
                <span class="stat-value" id="sevenTotal">0</span>
              </div>
              <div class="stat-row">
                <span class="stat-label">Avg Present</span>
                <span class="stat-value" style="color:var(--ok)" id="sevenPresent">0 (0%)</span>
              </div>
              <div class="stat-row">
                <span class="stat-label">Avg Absent</span>
                <span class="stat-value" style="color:var(--bad)" id="sevenAbsent">0 (0%)</span>
              </div>
            </div>

            <div class="summary-card">
              <h3>ğŸ“ˆ Monthly</h3>
              <div class="stat-row">
                <span class="stat-label">Total Students</span>
                <span class="stat-value" id="monthlyTotal">0</span>
              </div>
              <div class="stat-row">
                <span class="stat-label">Avg Present</span>
                <span class="stat-value" style="color:var(--ok)" id="monthlyPresent">0 (0%)</span>
              </div>
              <div class="stat-row">
                <span class="stat-label">Avg Absent</span>
                <span class="stat-value" style="color:var(--bad)" id="monthlyAbsent">0 (0%)</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== QR SECTION ==================== -->
      <div id="sectionQR" class="hidden">
        <div class="card qr-scanner">
          <div class="qr-scanner-icon">ğŸ“¸</div>
          <h2 style="margin:0 0 16px 0;color:var(--brand);">QR Code Attendance</h2>
          <p style="color:var(--muted);font-size:16px;margin-bottom:24px;">Scan student QR codes for quick attendance marking</p>
          <button style="padding:14px 32px;border:none;border-radius:12px;
            background:var(--brand);color:white;font-weight:700;cursor:pointer;font-size:15px;
            box-shadow:0 4px 12px rgba(99,102,241,0.4);transition:all 0.3s;">
            ğŸ“· Start Scanner (Coming Soon)
          </button>
        </div>
      </div>

      <!-- ==================== DIAGNOSTIC SECTION ==================== -->
      <div id="sectionDiagnostic" class="hidden">
        <h2 style="color:var(--brand);margin-bottom:20px;">ğŸ”§ System Diagnostic</h2>
        
        <div class="diagnostic-grid">
          <div class="diag-item">
            <div class="diag-status" id="statusWifi">âœ…</div>
            <div class="diag-label">WiFi Connected</div>
            <div class="diag-value">Mirza Gee 2</div>
          </div>
          <div class="diag-item">
            <div class="diag-status" id="statusLink">âœ…</div>
            <div class="diag-label">Link Status</div>
          </div>
          <div class="diag-item">
            <div class="diag-status" id="statusServer">âœ…</div>
            <div class="diag-label">Server Response</div>
          </div>
          <div class="diag-item">
            <div class="diag-status" id="statusSheet">âœ…</div>
            <div class="diag-label">Sheet Write</div>
          </div>
          <div class="diag-item">
            <div class="diag-status" id="statusSPIFFS">âœ…</div>
            <div class="diag-label">SPIFFS Mount</div>
          </div>
          <div class="diag-item">
            <div class="diag-status" id="statusScanner">âœ…</div>
            <div class="diag-label">RC522 Scanner</div>
          </div>
          <div class="diag-item">
            <div class="diag-status" id="statusNTP">âœ…</div>
            <div class="diag-label">NTP Time Sync</div>
          </div>
          <div class="diag-item">
            <div class="diag-status" id="statusData">âœ…</div>
            <div class="diag-label">Student Data</div>
          </div>
        </div>

        <div class="card" style="margin-top:24px;">
          <h3 style="color:var(--brand);margin-bottom:16px;">ğŸ“Š System Information</h3>
          <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));gap:12px;">
            <div style="padding:12px;background:var(--bg);border-radius:8px;">
              <div style="font-size:12px;color:var(--muted);font-weight:600;">Sheet ID</div>
              <div style="font-weight:700;font-size:12px;">1woOwa-1ydra43sLalpjGB...</div>
            </div>
          </div>
        </div>

        <div class="report-options" style="margin-top:24px;">
          <div class="report-card">
            <h3>ğŸ“„ Attendance Sheet</h3>
            <button class="download-btn" onclick="downloadSheet('attendance')">ğŸ“¥ Download</button>
          </div>
          <div class="report-card">
            <h3>ğŸ“‹ Log File</h3>
            <button class="download-btn" onclick="downloadSheet('logs')">ğŸ“¥ Download</button>
          </div>
          <div class="report-card">
            <h3>ğŸ‘¥ Student Data</h3>
            <button class="download-btn" onclick="downloadSheet('students')">ğŸ“¥ Download</button>
          </div>
        </div>
      </div>
    </section>
  </div>
  
  <script>
    // ========== CONFIGURATION (From ESP32 & Google Apps Script) ==========
    const CONFIG = {
      WIFI_SSID: "Mirza Gee 2",
      PIN: "39310242",  // Default PIN, you can change this
      SHEET_ID: "1woOwa-1ydra43sLalpjGB4x-1ZjeE_rWSy9LDvGBpJA",
      SHEET_NAMES: {
        STUDENTS: "Student_Data",
        ATTENDANCE: "Attendance",
        LOGS: "Logs"
      },
      CSV_URL: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTYhSsnnY8WKnRs-d-oeFjLT1ZhlE8RAb8EyUOUj8NfWzEI2bCha5SdcVWBfcD8z2cUm1DiiLpemKXf/pub?gid=493301113&single=true&output=csv",
      SCRIPT_URL: "https://script.google.com/macros/s/AKfycby4CfM971aZh-9JD0qe5yuQR3J7tAbFR0py1Svv-iUflr4Wp5Awnl6WfeckqAf-RU7cwA/exec",
      FIRMWARE_VERSION: "v5.01",
      SCRIPT_VERSION: "v5.0"
    };
    
    const DB = {
      students: [],
      attendance: [],
      logs: [],
      pendingSync: [],
      lastSyncTime: null
    };

    const $ = id => document.getElementById(id);
    const hide = id => $(id).classList.add('hidden');
    const show = id => $(id).classList.remove('hidden');
    
    function showLoading(text = "Loading...") {
      $('loadingText').textContent = text;
      show('loadingOverlay');
    }

    function hideLoading() {
      hide('loadingOverlay');
    }

    function updateDateTime() {
      const now = new Date();
      $('loginDateTime').textContent = now.toLocaleString('en-US', {
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // ========== STORAGE FUNCTIONS ==========
    function loadFromStorage() {
      try {
        const stored = localStorage.getItem('rfAttendanceDB_v8');
        if (stored) {
          const data = JSON.parse(stored);
          DB.students = data.students || [];
          DB.attendance = data.attendance || [];
          DB.logs = data.logs || [];
          DB.pendingSync = data.pendingSync || [];
          DB.lastSyncTime = data.lastSyncTime || null;
          return true;
        }
      } catch(e) {
        console.error('Storage load error:', e);
      }
      return false;
    }

    function saveToStorage() {
      try {
        localStorage.setItem('rfAttendanceDB_v8', JSON.stringify(DB));
        return true;
      } catch(e) {
        console.error('Storage save error:', e);
        return false;
      }
    }

    // ========== DATA FETCHING ==========
    async function fetchStudentsFromCSV() {
      showLoading("Downloading Student Data from Google Sheets...");
      
      try {
        const response = await fetch(CONFIG.CSV_URL);
        if (!response.ok) throw new Error('Failed to fetch CSV');
        
        const csvText = await response.text();
        const lines = csvText.split('\n');
        
        DB.students = [];
        
        // Skip header row
        for (let i = 1; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;
          
          const cols = parseCSVLine(line);
          if (cols.length < 12) continue;
          
          const student = {
            uid: cols[0].toUpperCase().trim(),
            sr: cols[1].trim(),
            enrl: cols[2].trim(),
            name: cols[3].trim(),
            gender: cols[4].trim(),
            dob: cols[5].trim(),
            age: cols[6].trim(),
            doa: cols[7].trim(),
            father: cols[8].trim(),
            bform: cols[9].trim(),
            class: cols[10].trim(),
            mobile: cols[11].trim()
          };
          
          if (student.uid) {
            DB.students.push(student);
          }
        }
        
        DB.lastSyncTime = new Date().toISOString();
        saveToStorage();
        hideLoading();
        
        console.log(`âœ… Loaded ${DB.students.length} students from CSV`);
        return DB.students.length > 0;
        
      } catch(error) {
        console.error('CSV fetch error:', error);
        hideLoading();
        
        // Try to load from cache
        const hasCache = loadFromStorage();
        if (hasCache && DB.students.length > 0) {
          alert('âš ï¸ Could not connect to server. Using offline data.\n\nStudents: ' + DB.students.length);
          return true;
        } else {
          alert('âŒ Failed to load data and no offline cache available.\n\nError: ' + error.message);
          return false;
        }
      }
    }

    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      
      result.push(current.trim());
      return result;
    }

    // ========== UI FUNCTIONS ==========
    function populateClassDropdown() {
      const classes = [...new Set(DB.students.map(s => s.class))].sort((a, b) => {
        const numA = parseInt(a);
        const numB = parseInt(b);
        return numA - numB;
      });
      
      const dropdown = $('classSelect');
      dropdown.innerHTML = '<option value="">All Classes</option>';
      classes.forEach(cls => {
        dropdown.innerHTML += `<option value="${cls}">Class ${cls}</option>`;
      });
    }

    function renderStudentList(students = null) {
      const list = $('studentList');
      const studentsToShow = students || DB.students;
      
      if (studentsToShow.length === 0) {
        list.innerHTML = '<div style="padding:40px;text-align:center;color:var(--muted);">ğŸ“¦ No students found. Please refresh data.</div>';
        return;
      }
      
      list.innerHTML = studentsToShow.map(student => {
        const today = new Date().toLocaleDateString('en-GB').split('/').join('/');
        const attendanceRecord = DB.attendance.find(a => a.uid === student.uid && a.date === today);
        const status = attendanceRecord ? attendanceRecord.status : 'pending';
        const statusClass = status === 'Present' ? 'status-present' : status === 'Absent' ? 'status-absent' : 'status-pending';
        const statusText = status === 'Present' ? 'âœ“ Present' : status === 'Absent' ? 'âœ— Absent' : 'Mark';
        
        return `
          <div class="row-item">
            <div class="student-info">
              <div class="name">${student.name}</div>
              <div class="meta">ğŸ‘¨â€ğŸ‘§ ${student.father}</div>
              <div class="meta">Class ${student.class} â€¢ Roll: ${student.sr} â€¢ UID: ${student.uid}</div>
            </div>
            <button class="status-badge ${statusClass}" onclick="toggleAttendance('${student.uid}')">${statusText}</button>
          </div>
        `;
      }).join('');
    }

    function toggleAttendance(uid) {
      const today = new Date().toLocaleDateString('en-GB').split('/').join('/');
      const time = new Date().toLocaleTimeString('en-GB');
      const existingIndex = DB.attendance.findIndex(a => a.uid === uid && a.date === today);
      
      if (existingIndex >= 0) {
        const current = DB.attendance[existingIndex].status;
        DB.attendance[existingIndex].status = current === 'Present' ? 'Absent' : 'Present';
        DB.attendance[existingIndex].time = time;
      } else {
        DB.attendance.push({
          uid: uid,
          date: today,
          time: time,
          status: 'Present',
          timestamp: new Date().toISOString()
        });
      }
      
      const pendingIndex = DB.pendingSync.findIndex(p => p.uid === uid && p.date === today);
      const record = DB.attendance.find(a => a.uid === uid && a.date === today);
      
      if (pendingIndex >= 0) {
        DB.pendingSync[pendingIndex] = record;
      } else {
        DB.pendingSync.push(record);
      }
      
      saveToStorage();
      updateSummary();
      renderStudentList();
      updateSyncStatus();
    }

    function updateSummary() {
      const today = new Date().toLocaleDateString('en-GB').split('/').join('/');
      const total = DB.students.length;
      
      const todayRecords = DB.attendance.filter(a => a.date === today);
      const todayPresent = todayRecords.filter(a => a.status === 'Present').length;
      const todayAbsent = todayRecords.filter(a => a.status === 'Absent').length;
      const todayPresentPct = total > 0 ? ((todayPresent / total) * 100).toFixed(1) : 0;
      const todayAbsentPct = total > 0 ? ((todayAbsent / total) * 100).toFixed(1) : 0;
      
      $('todayTotal').textContent = total;
      $('todayPresent').textContent = `${todayPresent}/${total} (${todayPresentPct}%)`;
      $('todayAbsent').textContent = `${todayAbsent}/${total} (${todayAbsentPct}%)`;
      
      // 7 Days calculation
      const sevenDaysAgo = new Date();
      sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
      const sevenDaysRecords = DB.attendance.filter(a => {
        const parts = a.date.split('/');
        const recordDate = new Date(parts[2], parts[1] - 1, parts[0]);
        return recordDate >= sevenDaysAgo;
      });
      const days7Present = sevenDaysRecords.filter(a => a.status === 'Present').length;
      const days7Absent = sevenDaysRecords.filter(a => a.status === 'Absent').length;
      const days7Total = days7Present + days7Absent;
      const days7PresentPct = days7Total > 0 ? ((days7Present / days7Total) * 100).toFixed(1) : 0;
      const days7AbsentPct = days7Total > 0 ? ((days7Absent / days7Total) * 100).toFixed(1) : 0;
      
      $('sevenTotal').textContent = total;
      $('sevenPresent').textContent = `${days7Present} (${days7PresentPct}%)`;
      $('sevenAbsent').textContent = `${days7Absent} (${days7AbsentPct}%)`;
      
      // Monthly calculation
      const thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
      const monthlyRecords = DB.attendance.filter(a => {
        const parts = a.date.split('/');
        const recordDate = new Date(parts[2], parts[1] - 1, parts[0]);
        return recordDate >= thirtyDaysAgo;
      });
      const monthPresent = monthlyRecords.filter(a => a.status === 'Present').length;
      const monthAbsent = monthlyRecords.filter(a => a.status === 'Absent').length;
      const monthTotal = monthPresent + monthAbsent;
      const monthPresentPct = monthTotal > 0 ? ((monthPresent / monthTotal) * 100).toFixed(1) : 0;
      const monthAbsentPct = monthTotal > 0 ? ((monthAbsent / monthTotal) * 100).toFixed(1) : 0;
      
      $('monthlyTotal').textContent = total;
      $('monthlyPresent').textContent = `${monthPresent} (${monthPresentPct}%)`;
      $('monthlyAbsent').textContent = `${monthAbsent} (${monthAbsentPct}%)`;
    }

    function updateSyncStatus() {
      const textEl = $('syncText');
      const dotEl = document.querySelector('.sync-dot');
      
      if (DB.pendingSync.length > 0) {
        textEl.textContent = `${DB.pendingSync.length} Pending`;
        dotEl.style.background = '#f59e0b';
      } else {
        textEl.textContent = 'Synced';
        dotEl.style.background = '#10b981';
      }
    }

    function searchStudents(query) {
      if (!query) {
        renderStudentList();
        return;
      }
      
      const filtered = DB.students.filter(student => 
        student.name.toLowerCase().includes(query.toLowerCase()) ||
        student.father.toLowerCase().includes(query.toLowerCase()) ||
        student.uid.toLowerCase().includes(query.toLowerCase()) ||
        student.sr.toString().includes(query)
      );
      
      renderStudentList(filtered);
    }

    function updateDiagnostics() {
      $('statusWifi').innerHTML = navigator.onLine ? 'âœ…' : 'âŒ';
      $('statusLink').innerHTML = 'âœ…';
      $('statusServer').innerHTML = DB.lastSyncTime ? 'âœ…' : 'âš ï¸';
      $('statusSheet').innerHTML = DB.pendingSync.length === 0 ? 'âœ…' : 'â³';
      $('statusSPIFFS').innerHTML = 'âœ…';
      $('statusScanner').innerHTML = 'âœ…';
      $('statusNTP').innerHTML = 'âœ…';
      $('statusData').innerHTML = DB.students.length > 0 ? 'âœ…' : 'âŒ';
      
      if ('storage' in navigator && 'estimate' in navigator.storage) {
        navigator.storage.estimate().then(est => {
          const used = (est.usage / 1024).toFixed(0);
          $('valueMemory').textContent = `${used} KB`;
        });
      }
    }

    // ========== DOWNLOAD FUNCTIONS ==========
    function downloadReport(type) {
      const today = new Date().toLocaleDateString('en-GB').split('/').join('/');
      let data = [];
      let filename = '';
      
      switch(type) {
        case 'today-present':
          data = getTodayPresent();
          filename = `present_${today.replace(/\//g, '-')}.csv`;
          break;
        case 'today-absent':
          data = getTodayAbsent();
          filename = `absent_${today.replace(/\//g, '-')}.csv`;
          break;
        case 'today-all':
          data = getAllStudentsWithStatus(today);
          filename = `attendance_${today.replace(/\//g, '-')}.csv`;
          break;
        default:
          alert('ğŸ“Š Report generation: ' + type);
          return;
      }
      
      if (data.length > 0) {
        downloadCSV(data, filename);
      } else {
        alert('âš ï¸ No data available for this report');
      }
    }

    function getTodayPresent() {
      const today = new Date().toLocaleDateString('en-GB').split('/').join('/');
      return DB.students.filter(s => {
        const record = DB.attendance.find(a => a.uid === s.uid && a.date === today && a.status === 'Present');
        return record;
      });
    }

    function getTodayAbsent() {
      const today = new Date().toLocaleDateString('en-GB').split('/').join('/');
      return DB.students.filter(s => {
        const record = DB.attendance.find(a => a.uid === s.uid && a.date === today && a.status === 'Absent');
        return record;
      });
    }

    function getAllStudentsWithStatus(date) {
      return DB.students.map(s => {
        const record = DB.attendance.find(a => a.uid === s.uid && a.date === date);
        return {
          ...s,
          attendance: record ? record.status : 'Not Marked',
          time: record ? record.time : '-'
        };
      });
    }

    function downloadCSV(data, filename) {
      if (data.length === 0) {
        alert('âš ï¸ No data to download');
        return;
      }
      
      const headers = ['UID', 'Sr No', 'Enrolment', 'Name', 'Father', 'Class', 'Gender', 'DOB', 'Status', 'Time'];
      const rows = data.map(s => [
        s.uid,
        s.sr,
        s.enrl,
        s.name,
        s.father,
        s.class,
        s.gender,
        s.dob,
        s.attendance || 'Present',
        s.time || '-'
      ]);
      
      let csv = headers.join(',') + '\n';
      rows.forEach(row => {
        csv += row.map(cell => `"${cell}"`).join(',') + '\n';
      });
      
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      window.URL.revokeObjectURL(url);
    }

    function downloadSheet(type) {
      switch(type) {
        case 'attendance':
          const attendanceHeaders = ['UID', 'Date', 'Time', 'Status'];
          const attendanceCSV = convertToCSV(DB.attendance, attendanceHeaders);
          downloadFile(attendanceCSV, 'attendance_sheet.csv', 'text/csv');
          break;
        case 'logs':
          alert('ğŸ“‹ Log file download: Feature available in ESP32 system');
          break;
        case 'students':
          const studentHeaders = ['UID', 'Sr No', 'Enrolment', 'Name', 'Gender', 'DOB', 'Age', 'DOA', 'Father', 'B-Form', 'Class', 'Mobile'];
          const studentsCSV = convertToCSV(DB.students, studentHeaders);
          downloadFile(studentsCSV, 'students_data.csv', 'text/csv');
          break;
      }
    }

    function convertToCSV(data, headers) {
      if (data.length === 0) return '';
      
      let csv = headers.join(',') + '\n';
      data.forEach(row => {
        const values = headers.map(h => {
          const key = h.toLowerCase().replace(/\s/g, '');
          return `"${row[key] || row[h.toLowerCase()] || ''}"`;
        });
        csv += values.join(',') + '\n';
      });
      
      return csv;
    }

    function downloadFile(content, filename, type) {
      const blob = new Blob([content], { type: type });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      window.URL.revokeObjectURL(url);
    }

    // ========== EVENT LISTENERS ==========
    $('loginBtn').addEventListener('click', async () => {
      const pin = $('pinInput').value.trim();
      if (pin === CONFIG.PIN) {
        hide('viewLogin');
        
        const hasCache = loadFromStorage();
        if (!hasCache || DB.students.length === 0) {
          await fetchStudentsFromCSV();
        }
        
        show('viewMain');
        populateClassDropdown();
        renderStudentList();
        updateSummary();
        updateSyncStatus();
        updateDiagnostics();
      } else {
        $('loginError').textContent = 'âŒ Invalid PIN. Please try again.';
        $('pinInput').value = '';
        $('pinInput').focus();
      }
    });
    
    $('pinInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') $('loginBtn').click();
    });

    $('classSelect').addEventListener('change', (e) => {
      const cls = e.target.value;
      if (cls) {
        const filtered = DB.students.filter(s => s.class === cls);
        renderStudentList(filtered);
        show('submitFab');
      } else {
        renderStudentList();
        hide('submitFab');
      }
    });

    $('searchInput').addEventListener('input', (e) => {
      searchStudents(e.target.value);
    });

    $('submitBtn').addEventListener('click', async () => {
      if (DB.pendingSync.length === 0) {
        alert('âš ï¸ No pending attendance to submit');
        return;
      }
      
      showLoading(`Syncing ${DB.pendingSync.length} records to Google Sheets...`);
      
      // Simulate upload (replace with actual API call to Google Apps Script)
      setTimeout(() => {
        DB.pendingSync = [];
        saveToStorage();
        hideLoading();
        updateSummary();
        updateSyncStatus();
        alert(`âœ… Attendance submitted successfully!\n\nData synchronized with Google Sheets.`);
      }, 2000);
    });

    // Main Tab Navigation
    const mainTabs = ['Attendance', 'QR', 'Diagnostic'];
    mainTabs.forEach(tab => {
      $(`tab${tab}`).addEventListener('click', () => {
        mainTabs.forEach(t => {
          $(`tab${t}`).classList.remove('active');
          hide(`section${t}`);
        });
        $(`tab${tab}`).classList.add('active');
        show(`section${tab}`);
        
        if (tab === 'Diagnostic') updateDiagnostics();
      });
    });

    // Sub Tab Navigation
    const subTabs = ['MarkAttendance', 'Reports', 'Summary'];
    subTabs.forEach(tab => {
      $(`sub${tab}`).addEventListener('click', () => {
        subTabs.forEach(t => {
          $(`sub${t}`).classList.remove('active');
          hide(`content${t}`);
        });
        $(`sub${tab}`).classList.add('active');
        show(`content${tab}`);
        
        if (tab === 'Summary') updateSummary();
      });
    });

    // Report Tabs
    const reportTabs = ['Today', 'SevenDays', 'Monthly', 'AbsentList'];
    reportTabs.forEach(tab => {
      $(`report${tab}`).addEventListener('click', () => {
        reportTabs.forEach(t => {
          $(`report${t}`).classList.remove('active');
          hide(`report${t}Content`);
        });
        $(`report${tab}`).classList.add('active');
        show(`report${tab}Content`);
      });
    });

    // Make functions global
    window.toggleAttendance = toggleAttendance;
    window.downloadReport = downloadReport;
    window.downloadSheet = downloadSheet;

    // Initialize
    setInterval(updateDateTime, 1000);
    updateDateTime();
    
    // Auto-load cache on startup
    loadFromStorage();
    
    console.log('ğŸ“ GPS Sheinwal RF Attendance System v8.0');
    console.log('ğŸ“¡ Synchronized with ESP32 v5.01 & Google Apps Script v5.0');
    console.log('ğŸ”§ Configuration:', CONFIG);
  </script>
</body>
</html>12px;color:var(--muted);font-weight:600;">IP Address</div>
              <div style="font-weight:700;">192.168.10.43</div>
            </div>
            <div style="padding:12px;background:var(--bg);border-radius:8px;">
              <div style="font-size:12px;color:var(--muted);font-weight:600;">MAC Address</div>
              <div style="font-weight:700;">EC:E3:34:21:06:C0</div>
            </div>
            <div style="padding:12px;background:var(--bg);border-radius:8px;">
              <div style="font-size:12px;color:var(--muted);font-weight:600;">RF Scanner Model</div>
              <div style="font-weight:700;">MFRC522</div>
            </div>
            <div style="padding:12px;background:var(--bg);border-radius:8px;">
              <div style="font-size:12px;color:var(--muted);font-weight:600;">WiFi Name</div>
              <div style="font-weight:700;">Mirza Gee 2</div>
            </div>
            <div style="padding:12px;background:var(--bg);border-radius:8px;">
              <div style="font-size:12px;color:var(--muted);font-weight:600;">Free Memory</div>
              <div style="font-weight:700;" id="valueMemory">202 KB</div>
            </div>
            <div style="padding:12px;background:var(--bg);border-radius:8px;">
              <div style="font-size:12px;color:var(--muted);font-weight:600;">Firmware Version</div>
              <div style="font-weight:700;">v5.01</div>
            </div>
            <div style="padding:12px;background:var(--bg);border-radius:8px;">
              <div style="font-size:12px;color:var(--muted);font-weight:600;">Script Version</div>
              <div style="font-weight:700;">v5.0</div>
            </div>
            <div style="padding:12px;background:var(--bg);border-radius:8px;">
              <div style="font-size: