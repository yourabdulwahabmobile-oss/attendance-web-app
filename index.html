<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GPS Sheinwal - RF Attendance v8.1 REAL-TIME</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;500;600;700&display=swap');
    
    :root{
      --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --bg:#f8fafc; 
      --card:#ffffff; 
      --text:#1e293b; 
      --muted:#64748b;
      --brand:#6366f1; 
      --brand-hover:#4f46e5;
      --brand-light:#eef2ff;
      --ok:#10b981; 
      --warn:#f59e0b; 
      --bad:#ef4444;
      --border:#e2e8f0; 
      --shadow:0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
      --shadow-lg:0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
    }
    
    * { box-sizing: border-box; margin:0; padding:0; }
    
    html,body{
      min-height:100%;
      background:var(--bg);
      color:var(--text);
      font-family:'Inter',system-ui,-apple-system,sans-serif;
      line-height:1.6;
    }

    header{
      position:sticky;
      top:0;
      z-index:50;
      background:var(--bg-gradient);
      color:#fff;
      text-align:center;
      padding:16px;
      box-shadow:var(--shadow-lg);
    }
    
    .school-name{
      font-size:clamp(18px, 4vw, 24px);
      font-weight:800;
      margin-bottom:4px;
      text-shadow:0 2px 4px rgba(0,0,0,0.1);
      letter-spacing:-0.5px;
    }
    
    .bar h1{
      font-size:clamp(14px, 3.5vw, 18px);
      margin:0;
      font-weight:600;
      letter-spacing:0.5px;
      opacity:0.95;
    }

    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:12px;
    }

    .card{
      background:var(--card);
      border-radius:16px;
      box-shadow:var(--shadow-lg);
      padding:20px;
      border:1px solid var(--border);
      margin-bottom:16px;
    }

    .main-tabs{
      display:grid;
      grid-template-columns:repeat(2, 1fr);
      gap:10px;
      margin-bottom:16px;
    }
    
    .main-tabs button{
      padding:14px 10px;
      border-radius:12px;
      border:2px solid transparent;
      background:var(--card);
      cursor:pointer;
      font-weight:700;
      font-size:14px;
      transition:all 0.3s;
      box-shadow:var(--shadow);
      color:var(--text);
    }
    
    .main-tabs button:hover{
      transform:translateY(-2px);
      box-shadow:0 8px 16px -4px rgba(99,102,241,0.3);
    }
    
    .main-tabs button.active{
      background:var(--bg-gradient);
      color:#fff;
      box-shadow:0 8px 16px -4px rgba(99,102,241,0.5);
    }

    .sub-tabs{
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:8px;
      margin-bottom:16px;
      background:var(--brand-light);
      padding:8px;
      border-radius:12px;
    }

    .sub-tabs button{
      padding:10px 8px;
      border-radius:8px;
      border:none;
      background:white;
      cursor:pointer;
      font-weight:600;
      font-size:12px;
      transition:all 0.3s;
      color:var(--text);
    }

    .sub-tabs button.active{
      background:var(--brand);
      color:white;
      box-shadow:0 4px 8px rgba(99,102,241,0.3);
    }

    .toolbar{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
      margin-bottom:16px;
    }
    
    .label-text{
      font-weight:600;
      font-size:12px;
      color:var(--text);
      margin-bottom:6px;
      display:block;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    
    input[type="text"],input[type="password"],input[type="number"],select{
      padding:12px 14px;
      border-radius:10px;
      border:2px solid var(--border);
      font-size:14px;
      width:100%;
      transition:all 0.2s;
      background:var(--card);
      font-family:inherit;
    }
    
    input:focus,select:focus{
      outline:none;
      border-color:var(--brand);
      box-shadow:0 0 0 3px var(--brand-light);
    }

    .select-all-bar{
      background:var(--brand-light);
      border:2px solid var(--brand);
      border-radius:10px;
      padding:14px 16px;
      margin-bottom:12px;
      display:flex;
      align-items:center;
      gap:10px;
    }

    .select-all-bar input[type="checkbox"]{
      width:20px;
      height:20px;
      cursor:pointer;
    }

    .select-all-bar label{
      font-weight:700;
      font-size:14px;
      color:var(--brand);
      cursor:pointer;
      flex:1;
    }

    .selected-count{
      background:var(--brand);
      color:white;
      padding:4px 12px;
      border-radius:16px;
      font-weight:700;
      font-size:12px;
    }

    .class-total-badge{
      background:var(--ok);
      color:white;
      padding:6px 14px;
      border-radius:20px;
      font-weight:700;
      font-size:13px;
      margin-bottom:12px;
      display:inline-block;
    }

    .list{
      background:var(--card);
      border:2px solid var(--border);
      border-radius:12px;
      overflow:hidden;
      margin-bottom:80px;
      box-shadow:var(--shadow);
      max-height: 60vh;
      overflow-y: auto;
    }
    
    .row-item{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 14px;
      border-top:1px solid var(--border);
      transition:all 0.2s;
      gap:10px;
    }
    
    .row-item:first-child{border-top:none}
    
    .row-item:hover{
      background:var(--brand-light);
    }

    .row-item.selected{
      background:#d1fae5;
    }
    
    .student-info{
      flex:1;
      min-width:0;
    }

    .name{
      font-weight:700;
      font-size:14px;
      color:var(--text);
      margin-bottom:2px;
    }
    
    .meta{
      font-size:11px;
      color:var(--muted);
      font-weight:500;
    }

    .student-checkbox{
      width:20px;
      height:20px;
      cursor:pointer;
      flex-shrink:0;
    }

    .fab{
      position:fixed;
      bottom:16px;
      left:50%;
      transform:translateX(-50%);
      z-index:100;
      width:calc(100% - 24px);
      max-width:400px;
    }
    
    .fab button{
      width:100%;
      padding:14px 24px;
      border-radius:50px;
      font-size:15px;
      font-weight:700;
      background:var(--bg-gradient);
      color:#fff;
      border:none;
      box-shadow:0 10px 25px -5px rgba(99,102,241,0.5);
      cursor:pointer;
      transition:all 0.3s;
    }
    
    .fab button:hover{
      transform:translateY(-3px);
      box-shadow:0 15px 30px -5px rgba(99,102,241,0.6);
    }

    .fab button:disabled{
      opacity:0.6;
      cursor:not-allowed;
    }

    .upload-toast{
      position:fixed;
      top:80px;
      right:12px;
      background:white;
      border:2px solid var(--brand);
      border-radius:12px;
      padding:16px;
      box-shadow:var(--shadow-lg);
      z-index:90;
      min-width:280px;
      animation:slideIn 0.3s ease;
    }

    .error-banner{
      background:linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color:white;
      padding:20px;
      border-radius:12px;
      margin:16px 0;
      box-shadow:0 8px 16px rgba(239,68,68,0.3);
    }

    .success-banner{
      background:linear-gradient(135deg, #10b981 0%, #059669 100%);
      color:white;
      padding:20px;
      border-radius:12px;
      margin:16px 0;
      box-shadow:0 8px 16px rgba(16,185,129,0.3);
    }

    @keyframes slideIn{
      from{transform:translateX(400px);opacity:0;}
      to{transform:translateX(0);opacity:1;}
    }

    @keyframes pulse {
      0%, 100% { 
        background: var(--brand-light);
        transform: scale(1);
      }
      50% { 
        background: var(--brand);
        transform: scale(1.02);
      }
    }

    .upload-progress-bar{
      width:100%;
      height:8px;
      background:var(--border);
      border-radius:4px;
      overflow:hidden;
      margin:10px 0;
    }

    .upload-progress-fill{
      height:100%;
      background:var(--brand);
      transition:width 0.3s;
    }

    .hidden{display:none!important}

    .login-container {
      text-align:center;
      max-width:400px;
      margin:40px auto;
    }
    
    .login-icon {
      width:70px;
      height:70px;
      margin:0 auto 16px;
      background:var(--bg-gradient);
      border-radius:16px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:36px;
      box-shadow:var(--shadow-lg);
    }

    .btn-primary{
      padding:10px 20px;
      border-radius:8px;
      border:none;
      background:var(--brand);
      color:white;
      font-weight:700;
      font-size:13px;
      cursor:pointer;
      transition:all 0.3s;
    }

    .btn-primary:hover{
      background:var(--brand-hover);
      transform:translateY(-2px);
    }

    .btn-success{
      background:var(--ok);
    }

    .btn-danger{
      background:var(--bad);
    }

    .loading-spinner {
      border: 4px solid var(--border);
      border-top: 4px solid var(--brand);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
    }

    .status-badge.success {
      background: #d1fae5;
      color: #059669;
    }

    .status-badge.warning {
      background: #fef3c7;
      color: #d97706;
    }

    .status-badge.error {
      background: #fee2e2;
      color: #dc2626;
    }

    .system-ready-banner {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      margin: 16px 0;
      box-shadow: 0 8px 16px rgba(16,185,129,0.3);
    }

    /* ROZNAMCHA STYLES */
    .roznamcha-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    .roznamcha-table th {
      background: #64748b;
      color: white;
      padding: 10px 8px;
      font-size: 11px;
      font-weight: 700;
      text-align: center;
      border: 1px solid #94a3b8;
    }

    .roznamcha-table td {
      padding: 8px;
      font-size: 12px;
      font-weight: 600;
      text-align: center;
      border: 1px solid var(--border);
    }

    .roznamcha-table tbody tr:hover {
      background: var(--brand-light);
    }

    .class-name-cell {
      text-align: left !important;
      font-weight: 700;
      color: #ef4444;
      background: #fef2f2;
      padding-left: 12px !important;
    }

    .total-row {
      background: #64748b !important;
      color: white !important;
      font-weight: 800 !important;
    }

    .total-row td {
      border-color: #94a3b8 !important;
    }

    .urdu-text {
      font-family: 'Noto Nastaliq Urdu', serif;
      font-size: 14px;
    }

    .percentage-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-weight: 800;
      font-size: 16px;
    }

    .percentage-excellent {
      background: #d1fae5;
      color: #059669;
    }

    .percentage-good {
      background: #fef3c7;
      color: #d97706;
    }

    .percentage-warning {
      background: #fee2e2;
      color: #dc2626;
    }

    .roznamcha-header {
      background: black;
      color: white;
      padding: 12px;
      text-align: center;
      font-size: 15px;
      font-weight: 700;
      border-radius: 12px 12px 0 0;
      margin-bottom: -1px;
    }

    .date-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: var(--brand-light);
      border-radius: 0 0 12px 12px;
      margin-top: -1px;
      border: 2px solid var(--border);
      border-top: none;
    }

    .date-label {
      color: #ef4444;
      font-weight: 700;
      font-size: 14px;
    }

    .date-value {
      font-weight: 700;
      font-size: 13px;
      color: var(--text);
    }

    .download-link{
      display:block;
      padding:14px;
      background:white;
      border:2px solid var(--border);
      border-radius:10px;
      margin-bottom:10px;
      text-decoration:none;
      color:var(--text);
      font-weight:600;
      transition:all 0.3s;
    }

    .download-link:hover{
      border-color:var(--brand);
      background:var(--brand-light);
      transform:translateX(5px);
    }

    .autocomplete-container {
      position: relative;
    }

    .autocomplete-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 3px solid var(--brand);
      border-top: none;
      border-radius: 0 0 16px 16px;
      max-height: 400px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 15px 35px -5px rgba(99,102,241,0.4);
      display: none;
    }

    .autocomplete-dropdown.show {
      display: block;
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .autocomplete-item {
      padding: 16px 16px;
      cursor: pointer;
      border-bottom: 2px solid #f1f5f9;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 14px;
      background: white;
    }

    .autocomplete-item:last-child {
      border-bottom: none;
      border-radius: 0 0 14px 14px;
    }

    .autocomplete-item:hover {
      background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
      transform: translateX(5px);
      box-shadow: inset 4px 0 0 var(--brand);
    }

    .autocomplete-item-avatar {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      flex-shrink: 0;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .autocomplete-item-avatar.male {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }

    .autocomplete-item-avatar.female {
      background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
    }

    .autocomplete-item-info {
      flex: 1;
      min-width: 0;
    }

    .autocomplete-item-name {
      font-weight: 700;
      font-size: 15px;
      color: var(--text);
      margin-bottom: 6px;
      line-height: 1.2;
    }

    .autocomplete-item-meta {
      font-size: 12px;
      color: var(--muted);
      font-weight: 600;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .autocomplete-item-badge {
      background: var(--brand-light);
      color: var(--brand);
      padding: 3px 8px;
      border-radius: 6px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .autocomplete-empty {
      padding: 30px 20px;
      text-align: center;
      color: var(--muted);
      font-size: 14px;
      font-weight: 600;
    }

    .autocomplete-empty::before {
      content: "üîç";
      display: block;
      font-size: 40px;
      margin-bottom: 10px;
      opacity: 0.5;
    }

    .student-detail-section {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      border: 2px solid transparent;
      transition: all 0.3s;
    }

    .student-detail-section:hover {
      border-color: var(--brand-light);
      box-shadow: 0 8px 20px rgba(99,102,241,0.15);
    }

    .detail-icon-box {
      width: 60px;
      height: 60px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      flex-shrink: 0;
      box-shadow: 0 6px 12px rgba(0,0,0,0.12);
      margin-right: 16px;
    }

    .action-btn-present:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(16,185,129,0.5) !important;
    }

    .action-btn-absent:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(239,68,68,0.5) !important;
    }

    @media (min-width: 768px) {
      .wrap { padding:20px; }
      .toolbar { grid-template-columns:1fr 1fr; }
      .main-tabs { grid-template-columns:repeat(4, 1fr); }
      .roznamcha-table th,
      .roznamcha-table td {
        font-size: 13px;
        padding: 10px;
      }
      .detail-icon-box {
        width: 70px;
        height: 70px;
        font-size: 32px;
      }
    }

    @media (max-width: 767px) {
      .upload-toast { right:12px; left:12px; min-width:unset; }
      .roznamcha-table th,
      .roznamcha-table td {
        font-size: 10px;
        padding: 6px 4px;
      }
      .class-name-cell {
        font-size: 11px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="school-name">üéì GPS Sheinwal (Shamaskay)</div>
    <div class="bar"><h1>RFID Attendance Management System v8.1 REAL-TIME</h1></div>
  </header>
  
  <div class="wrap">
    <!-- LOGIN VIEW -->
    <section id="viewLogin" class="card login-container">
      <div class="login-icon">üîê</div>
      <div style="font-size:24px;font-weight:800;margin-bottom:6px;color:var(--text);">Secure Login</div>
      <div style="color:var(--muted);margin-bottom:20px;font-size:14px;">Enter your password to continue</div>
      <div id="loginDateTime" style="color:var(--muted);margin-bottom:16px;font-size:12px;"></div>
      <input id="pinInput" type="password" inputmode="numeric" maxlength="20" placeholder="Enter Password" 
        style="width:90%;padding:12px 18px;text-align:center;letter-spacing:3px;margin-bottom:16px;font-size:16px;" />
      <button id="loginBtn" style="padding:12px 36px;border:none;border-radius:10px;background:var(--bg-gradient);
        color:white;font-size:15px;font-weight:700;cursor:pointer;box-shadow:0 4px 12px rgba(99,102,241,0.4);transition:all 0.3s;">
        Login ‚Üí
      </button>
      <div id="loginError" style="margin-top:14px;color:var(--bad);font-weight:600;font-size:13px;"></div>
    </section>

    <!-- MAIN VIEW -->
    <section id="viewMain" class="hidden">
      <!-- Data Load Status -->
      <div id="dataLoadStatus"></div>

      <!-- Main Tabs -->
      <div class="main-tabs">
        <button id="tabAttendance" class="active">üìã Attendance</button>
        <button id="tabReports">üìÑ Reports</button>
        <button id="tabRoznamcha">üìä Roznamcha</button>
        <button id="tabSystemInfo">üîß System</button>
      </div>

      <!-- ATTENDANCE SECTION -->
      <div id="sectionAttendance">
        <!-- Sub Tabs -->
        <div class="sub-tabs">
          <button id="subTabManual" class="active">‚úçÔ∏è Manual</button>
          <button id="subTabQR">üì∑ QR Scan</button>
          <button id="subTabStudentInfo">üë§ Student Info</button>
        </div>

        <!-- Manual Attendance -->
        <div id="subSectionManual">
          <div class="toolbar">
            <div>
              <span class="label-text">üìö Select Class</span>
              <select id="classSelect">
                <option value="">All Classes</option>
              </select>
            </div>
            <div>
              <span class="label-text">üîç Search Student</span>
              <input type="text" id="searchInput" placeholder="Search by name, father name or enrollment..." />
            </div>
          </div>

          <div id="classTotalBadge"></div>

          <div class="select-all-bar">
            <input type="checkbox" id="selectAllCheckbox" />
            <label for="selectAllCheckbox">Select All (Present)</label>
            <span class="selected-count" id="selectedCount">0 Selected</span>
          </div>

          <div id="studentList" class="list"></div>
          
          <div class="fab" id="submitFab">
            <button id="submitBtn">‚úì Submit Attendance</button>
          </div>
        </div>

        <!-- QR Scan -->
        <div id="subSectionQR" class="hidden">
          <div class="card" style="text-align:center;padding:60px 20px;">
            <div style="font-size:48px;margin-bottom:16px;">üì∑</div>
            <h3 style="color:var(--brand);margin-bottom:12px;">QR Code Scanner</h3>
            <p style="color:var(--muted);font-size:14px;">QR Code attendance scanning feature coming soon...</p>
          </div>
        </div>

        <!-- Student Information -->
        <div id="subSectionStudentInfo" class="hidden">
          <div class="toolbar">
            <div>
              <span class="label-text">üîç Search Student</span>
              <div class="autocomplete-container">
                <input type="text" id="singleStudentSearch" placeholder="Enter UID, Name, Father Name or Enrollment..." />
                <div id="studentSearchDropdown" class="autocomplete-dropdown"></div>
              </div>
            </div>
          </div>
          <div id="studentDetailResult"></div>
        </div>
      </div>

      <!-- REPORTS SECTION -->
      <div id="sectionReports" class="hidden">
        <div class="card">
          <h3 style="color:var(--brand);margin-bottom:16px;font-size:18px;">üìÑ Download Reports (CSV Format)</h3>
          <p style="color:var(--muted);margin-bottom:20px;font-size:14px;">Download attendance and student data files in CSV format</p>
          
          <a href="https://docs.google.com/spreadsheets/d/1woOwa-1ydra43sLalpjGB4x-1ZjeE_rWSy9LDvGBpJA/export?format=csv&gid=493301113" 
             class="download-link" target="_blank" download="Student_Data.csv">
            üìä Download Student Data File (CSV)
          </a>
          
          <a href="https://docs.google.com/spreadsheets/d/1woOwa-1ydra43sLalpjGB4x-1ZjeE_rWSy9LDvGBpJA/export?format=csv&gid=0" 
             class="download-link" target="_blank" download="Attendance_Data.csv">
            üìù Download Attendance File (CSV)
          </a>
          
          <a href="https://docs.google.com/spreadsheets/d/1woOwa-1ydra43sLalpjGB4x-1ZjeE_rWSy9LDvGBpJA/export?format=csv&gid=1234567890" 
             class="download-link" target="_blank" download="Log_File.csv">
            üìã Download Log File (CSV)
          </a>

          <div style="margin-top:20px;padding:16px;background:var(--brand-light);border-radius:10px;">
            <p style="font-size:12px;color:var(--text);"><strong>Note:</strong> CSV files will download directly to your device. You can open them in Excel, Google Sheets, or any spreadsheet application.</p>
          </div>
        </div>
      </div>

      <!-- ROZNAMCHA SECTION -->
      <div id="sectionRoznamcha" class="hidden">
        <div id="roznamchaContent"></div>
      </div>

      <!-- SYSTEM INFO SECTION -->
      <div id="sectionSystemInfo" class="hidden">
        <div id="systemInfoContent"></div>
      </div>
    </section>
  </div>

  <script>
    // ===== CONFIGURATION =====
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwd7O21lM9ynCqR0-MLW-lfL25EHFLKnTNOurjSghAzJuLFT_0TLTXjUaGqirc1e161Qw/exec";
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTYhSsnnY8WKnRs-d-oeFjLT1ZhlE8RAb8EyUOUj8NfWzEI2bCha5SdcVWBfcD8z2cUm1DiiLpemKXf/pub?gid=493301113&single=true&output=csv";
    const ROZNAMCHA_CSV_URL = "https://docs.google.com/spreadsheets/d/1woOwa-1ydra43sLalpjGB4x-1ZjeE_rWSy9LDvGBpJA/export?format=csv&gid=0";
    const SHEET_ID = "1woOwa-1ydra43sLalpjGB4x-1ZjeE_rWSy9LDvGBpJA";
    const PIN = "39310242";
    const WIFI_SSID = "Mirza Gee 2";
    const WIFI_PASSWORD = "GPS@2024";
    const IP_ADDRESS = "192.168.10.43";
    const MAC_ADDRESS = "EC:E3:34:21:06:C0";
    const SCANNER_MODEL = "MFRC522";
    const FIRMWARE_VERSION = "v2.10";
    const SCRIPT_VERSION = "v8.1";
    const MAX_RETRY_ATTEMPTS = 5;
    const RETRY_DELAY = 3000; // 3 seconds
    
    // ===== GLOBAL STATE =====
    let g_students = [];
    let g_filteredStudents = [];
    let g_selectedUIDs = new Set();
    let g_todayAttendance = {};
    let g_allAttendance = {};
    let g_sessionStats = {
      totalUploaded: 0,
      totalDuplicate: 0,
      totalFailed: 0,
      totalScanned: 0,
      queueSize: 0
    };
    let g_autoSyncInterval = null;
    let g_pendingUploads = [];
    let g_dataLoadStatus = 'loading'; // 'loading', 'success', 'error'
    let g_retryCount = 0;
    let g_roznamchaData = null;
    let g_roznamchaRefreshInterval = null;

    // Class name mappings
    const CLASS_NAMES = {
      'Nursery': 'ÿßŸàŸÑ/ÿßÿØŸÜ€å - Kachi',
      '1': 'ÿßŸàŸÑ/ÿßÿπŸÑ€å - One',
      '2': 'ÿØŸàÿ¶ŸÖ - Two',
      '3': 'ÿ≥Ÿàÿ¶ŸÖ - Three',
      '4': '⁄Ü€Åÿßÿ±ŸÖ - Four',
      '5': 'ŸæŸÜÿ¨ŸÖ - Five'
    };

    // ===== IMPROVED CSV LOADING WITH RETRY =====
    async function loadAllStudentsFast(retryAttempt = 0) {
      try {
        console.log(`üì• Loading students from CSV (Attempt ${retryAttempt + 1}/${MAX_RETRY_ATTEMPTS})...`);
        
        showLoadingStatus(`Loading student data... (Attempt ${retryAttempt + 1}/${MAX_RETRY_ATTEMPTS})`);
        
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 second timeout
        
        const response = await fetch(CSV_URL, {
          method: 'GET',
          cache: 'no-cache',
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const csvText = await response.text();
        
        if (!csvText || csvText.trim().length === 0) {
          throw new Error('Empty CSV file received');
        }
        
        const lines = csvText.split('\n');
        
        if (lines.length < 2) {
          throw new Error('CSV file has no data rows');
        }
        
        g_students = [];
        
        for (let i = 1; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;
          
          const cols = parseCSVLine(line);
          if (cols.length < 11) continue;
          
          const student = {
            uid: cols[0] || '',
            srNo: cols[1] || '',
            enrollment: cols[2] || '',
            name: cols[3] || '',
            gender: cols[4] || '',
            dob: cols[5] || '',
            bform: cols[6] || '',
            admission: cols[7] || '',
            father: cols[8] || '',
            cnic: cols[9] || '',
            class: cols[10] || '',
            mobile: cols[11] || '',
            identifier: cols[2] || cols[3]
          };
          
          g_students.push(student);
        }
        
        if (g_students.length === 0) {
          throw new Error('No students parsed from CSV');
        }
        
        console.log(`‚úÖ Successfully loaded ${g_students.length} students from CSV`);
        g_dataLoadStatus = 'success';
        g_retryCount = 0;
        
        showSuccessStatus(`‚úÖ Real-time data loaded: ${g_students.length} students`);
        
        populateClassDropdown();
        filterAndRender();
        updateRoznamcha();
        updateSystemInfo();
        
      } catch (error) {
        console.error(`‚ùå CSV loading failed (Attempt ${retryAttempt + 1}):`, error);
        
        g_retryCount = retryAttempt + 1;
        
        if (retryAttempt < MAX_RETRY_ATTEMPTS - 1) {
          showErrorStatus(`‚ö†Ô∏è Connection failed. Retrying in ${RETRY_DELAY/1000} seconds... (${retryAttempt + 1}/${MAX_RETRY_ATTEMPTS})`);
          
          setTimeout(() => {
            loadAllStudentsFast(retryAttempt + 1);
          }, RETRY_DELAY);
        } else {
          g_dataLoadStatus = 'error';
          showCriticalError(error);
        }
      }
    }

    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      
      result.push(current.trim());
      return result;
    }

    function showLoadingStatus(message) {
      const container = document.getElementById('dataLoadStatus');
      if (!container) return;
      
      container.innerHTML = `
        <div class="card" style="background:linear-gradient(135deg, #667eea15 0%, #764ba215 100%);border:2px solid var(--brand);">
          <div style="display:flex;align-items:center;gap:12px;">
            <div class="loading-spinner" style="margin:0;"></div>
            <div style="flex:1;">
              <div style="font-weight:700;font-size:14px;color:var(--brand);margin-bottom:4px;">Loading Data...</div>
              <div style="font-size:12px;color:var(--muted);">${message}</div>
            </div>
          </div>
        </div>
      `;
    }

    function showSuccessStatus(message) {
      const container = document.getElementById('dataLoadStatus');
      if (!container) return;
      
      container.innerHTML = `
        <div class="success-banner">
          <div style="display:flex;align-items:center;gap:12px;">
            <div style="font-size:32px;">‚úÖ</div>
            <div style="flex:1;">
              <div style="font-weight:800;font-size:16px;margin-bottom:4px;">System Online - Real-Time Mode</div>
              <div style="font-size:13px;opacity:0.95;">${message}</div>
            </div>
          </div>
        </div>
      `;
      
      setTimeout(() => {
        if (container) container.innerHTML = '';
      }, 5000);
    }

    function showErrorStatus(message) {
      const container = document.getElementById('dataLoadStatus');
      if (!container) return;
      
      container.innerHTML = `
        <div class="card" style="background:linear-gradient(135deg, #fef3c7 0%, #fed7aa 100%);border:2px solid #f59e0b;">
          <div style="display:flex;align-items:center;gap:12px;">
            <div style="font-size:32px;">‚ö†Ô∏è</div>
            <div style="flex:1;">
              <div style="font-weight:700;font-size:14px;color:#d97706;margin-bottom:4px;">Connection Issue</div>
              <div style="font-size:12px;color:#92400e;">${message}</div>
            </div>
          </div>
        </div>
      `;
    }

    function showCriticalError(error) {
      const container = document.getElementById('dataLoadStatus');
      if (!container) return;
      
      const errorDetails = error.message || 'Unknown error';
      
      container.innerHTML = `
        <div class="error-banner">
          <div style="display:flex;align-items:flex-start;gap:12px;">
            <div style="font-size:40px;">‚ùå</div>
            <div style="flex:1;">
              <div style="font-weight:800;font-size:18px;margin-bottom:8px;">Unable to Load Real-Time Data</div>
              <div style="font-size:13px;opacity:0.95;margin-bottom:12px;">
                Failed to connect to Google Sheets after ${MAX_RETRY_ATTEMPTS} attempts.
              </div>
              <div style="background:rgba(255,255,255,0.2);padding:10px;border-radius:8px;margin-bottom:12px;font-family:monospace;font-size:11px;">
                Error: ${errorDetails}
              </div>
              <div style="font-size:12px;opacity:0.9;margin-bottom:16px;">
                <strong>Possible causes:</strong><br>
                ‚Ä¢ No internet connection<br>
                ‚Ä¢ Google Sheets is not publicly accessible<br>
                ‚Ä¢ Incorrect CSV URL<br>
                ‚Ä¢ Network firewall blocking request<br>
                ‚Ä¢ CORS policy restrictions
              </div>
              <button onclick="location.reload()" class="btn-primary" style="background:white;color:#dc2626;padding:12px 24px;font-size:14px;">
                üîÑ Retry Connection
              </button>
              <button onclick="showConnectionHelp()" class="btn-primary" style="background:rgba(255,255,255,0.3);color:white;padding:12px 24px;font-size:14px;margin-left:8px;">
                üìñ Connection Help
              </button>
            </div>
          </div>
        </div>
      `;
      
      // Disable all functionality
      document.getElementById('classSelect').disabled = true;
      document.getElementById('searchInput').disabled = true;
      document.getElementById('selectAllCheckbox').disabled = true;
      document.getElementById('submitBtn').disabled = true;
      
      document.getElementById('studentList').innerHTML = `
        <div style="padding:40px;text-align:center;color:var(--bad);">
          <div style="font-size:48px;margin-bottom:16px;">üö´</div>
          <div style="font-weight:700;font-size:16px;margin-bottom:8px;">No Student Data Available</div>
          <div style="font-size:13px;color:var(--muted);">Please fix the connection issue above to continue</div>
        </div>
      `;
    }

    function showConnectionHelp() {
      alert(`üîß CONNECTION TROUBLESHOOTING GUIDE

1. CHECK INTERNET CONNECTION
   ‚Ä¢ Ensure device is connected to WiFi/mobile data
   ‚Ä¢ Try opening other websites to verify connection

2. VERIFY GOOGLE SHEET SETTINGS
   ‚Ä¢ Sheet must be published to web
   ‚Ä¢ "Anyone with link can view" permission required
   ‚Ä¢ CSV URL must be correct

3. CHECK CSV URL
   Current URL: ${CSV_URL}
   ‚Ä¢ Must end with "&output=csv"
   ‚Ä¢ gid parameter should match sheet tab ID

4. BROWSER ISSUES
   ‚Ä¢ Clear browser cache
   ‚Ä¢ Try different browser
   ‚Ä¢ Disable browser extensions

5. NETWORK RESTRICTIONS
   ‚Ä¢ Corporate firewall may block Google Sheets
   ‚Ä¢ Try mobile hotspot as alternative

6. CONTACT SYSTEM ADMIN
   If issue persists, contact your IT administrator.`);
    }

    function populateClassDropdown() {
      const select = document.getElementById('classSelect');
      if (!select) return;
      
      const classSet = new Set();
      g_students.forEach(s => {
        if (s.class && s.class.trim()) {
          classSet.add(s.class.trim());
        }
      });
      
      const classes = Array.from(classSet).sort((a, b) => {
        if (a.toLowerCase() === 'nursery') return -1;
        if (b.toLowerCase() === 'nursery') return 1;
        const aNum = parseInt(a);
        const bNum = parseInt(b);
        if (!isNaN(aNum) && !isNaN(bNum)) return aNum - bNum;
        return a.localeCompare(b);
      });
      
      select.innerHTML = '<option value="">All Classes</option>';
      classes.forEach(cls => {
        const opt = document.createElement('option');
        opt.value = cls;
        opt.textContent = cls;
        select.appendChild(opt);
      });
    }

    function filterAndRender() {
      if (g_dataLoadStatus !== 'success') return;
      
      const classFilter = document.getElementById('classSelect')?.value || '';
      const searchText = document.getElementById('searchInput')?.value?.toLowerCase() || '';
      
      g_filteredStudents = g_students.filter(s => {
        const matchClass = !classFilter || s.class.trim() === classFilter.trim();
        const matchSearch = !searchText || 
          s.name.toLowerCase().includes(searchText) ||
          s.father.toLowerCase().includes(searchText) ||
          s.enrollment.toLowerCase().includes(searchText) ||
          (s.uid && s.uid.toLowerCase().includes(searchText));
        
        return matchClass && matchSearch;
      });
      
      const badgeEl = document.getElementById('classTotalBadge');
      if (badgeEl) {
        if (classFilter) {
          badgeEl.innerHTML = `<div class="class-total-badge">üìö ${classFilter}: ${g_filteredStudents.length} Students</div>`;
        } else {
          badgeEl.innerHTML = '';
        }
      }
      
      renderStudentList();
      updateSelectAllCheckbox();
    }

    function renderStudentList() {
      const container = document.getElementById('studentList');
      if (!container) return;
      
      if (g_dataLoadStatus !== 'success') {
        container.innerHTML = '<div style="padding:40px;text-align:center;color:var(--muted);">Loading students...</div>';
        return;
      }
      
      container.innerHTML = '';
      
      if (g_filteredStudents.length === 0) {
        container.innerHTML = '<div style="padding:40px;text-align:center;color:var(--muted);">No students found</div>';
        return;
      }
      
      g_filteredStudents.forEach(student => {
        const identifier = student.identifier;
        const isMarked = g_todayAttendance[identifier] !== undefined;
        const status = g_todayAttendance[identifier];
        
        const div = document.createElement('div');
        div.className = 'row-item';
        
        if (isMarked) {
          div.style.background = status === 'present' ? '#d1fae5' : '#fee2e2';
        } else if (g_selectedUIDs.has(identifier)) {
          div.classList.add('selected');
        }
        
        div.innerHTML = `
          <div class="student-info">
            <div class="name">${student.name} ${isMarked ? (status === 'present' ? '‚úÖ' : '‚ùå') : ''}</div>
            <div class="meta">
              üë®‚Äçüëß ${student.father} | 
              üéì ${student.class} | 
              üÜî ${student.enrollment || student.uid || 'N/A'}
            </div>
          </div>
          ${isMarked ? 
            `<button class="btn-primary btn-${status === 'present' ? 'danger' : 'success'}" style="padding:8px 16px;font-size:12px;" onclick="editAttendance('${identifier}')">
              ${status === 'present' ? 'Mark Absent' : 'Mark Present'}
            </button>` :
            `<input type="checkbox" 
                   class="student-checkbox" 
                   data-identifier="${identifier}"
                   ${g_selectedUIDs.has(identifier) ? 'checked' : ''}>`
          }
        `;
        
        container.appendChild(div);
      });
      
      document.querySelectorAll('.student-checkbox').forEach(cb => {
        cb.addEventListener('change', handleCheckboxChange);
      });
      
      updateSelectedCount();
    }

    function editAttendance(identifier) {
      const currentStatus = g_todayAttendance[identifier];
      const newStatus = currentStatus === 'present' ? 'absent' : 'present';
      
      if (confirm(`Change attendance from ${currentStatus} to ${newStatus}?`)) {
        g_todayAttendance[identifier] = newStatus;
        saveToLocalStorage();
        renderStudentList();
        updateRoznamcha();
        
        const student = g_students.find(s => s.identifier === identifier);
        if (student) {
          uploadSingleAttendance(student, newStatus);
        }
      }
    }

    function handleCheckboxChange(e) {
      const cb = e.target;
      const identifier = cb.dataset.identifier;
      
      if (cb.checked) {
        g_selectedUIDs.add(identifier);
        cb.closest('.row-item').classList.add('selected');
      } else {
        g_selectedUIDs.delete(identifier);
        cb.closest('.row-item').classList.remove('selected');
      }
      
      updateSelectedCount();
      updateSelectAllCheckbox();
      saveToLocalStorage();
    }

    document.getElementById('selectAllCheckbox')?.addEventListener('change', (e) => {
      const checked = e.target.checked;
      
      g_filteredStudents.forEach(s => {
        const id = s.identifier;
        if (!g_todayAttendance[id]) {
          if (checked) {
            g_selectedUIDs.add(id);
          } else {
            g_selectedUIDs.delete(id);
          }
        }
      });
      
      renderStudentList();
      saveToLocalStorage();
    });

    function updateSelectAllCheckbox() {
      const checkbox = document.getElementById('selectAllCheckbox');
      if (!checkbox) return;
      
      const unmarkedStudents = g_filteredStudents.filter(s => !g_todayAttendance[s.identifier]);
      const allSelected = unmarkedStudents.length > 0 && 
        unmarkedStudents.every(s => g_selectedUIDs.has(s.identifier));
      
      checkbox.checked = allSelected;
    }

    function updateSelectedCount() {
      const count = g_selectedUIDs.size;
      document.getElementById('selectedCount').textContent = `${count} Selected`;
    }

    document.getElementById('submitBtn')?.addEventListener('click', submitAttendance);

    async function submitAttendance() {
      if (g_dataLoadStatus !== 'success') {
        alert('‚ùå Cannot submit: Student data not loaded!');
        return;
      }

      if (g_selectedUIDs.size === 0) {
        alert('‚ùå Please select at least one student!');
        return;
      }

      const selectedStudents = g_students.filter(s => 
        g_selectedUIDs.has(s.identifier) && !g_todayAttendance[s.identifier]
      );

      if (selectedStudents.length === 0) {
        alert('‚ùå All selected students have already been marked!');
        return;
      }

      g_pendingUploads.push(...selectedStudents);
      saveToLocalStorage();

      const total = selectedStudents.length;
      let success = 0, duplicate = 0, failed = 0;

      const btn = document.getElementById('submitBtn');
      btn.disabled = true;
      btn.textContent = `Uploading 0/${total}...`;

      showUploadToast(0, total);

      for (let i = 0; i < selectedStudents.length; i++) {
        const student = selectedStudents[i];
        
        try {
          const result = await uploadSingleAttendance(student, 'present');
          
          if (result.success) {
            success++;
            g_sessionStats.totalUploaded++;
            g_sessionStats.totalScanned++;
            g_todayAttendance[student.identifier] = 'present';
            g_allAttendance[student.identifier] = g_allAttendance[student.identifier] || [];
            g_allAttendance[student.identifier].push({date: new Date().toLocaleDateString(), status: 'present'});
            g_selectedUIDs.delete(student.identifier);
            g_pendingUploads = g_pendingUploads.filter(s => s.identifier !== student.identifier);
          } else if (result.alreadyMarked) {
            duplicate++;
            g_sessionStats.totalDuplicate++;
            g_todayAttendance[student.identifier] = 'present';
            g_selectedUIDs.delete(student.identifier);
            g_pendingUploads = g_pendingUploads.filter(s => s.identifier !== student.identifier);
          } else {
            failed++;
            g_sessionStats.totalFailed++;
          }
          
          btn.textContent = `Uploading ${i + 1}/${total}...`;
          updateUploadToast(i + 1, total, success, duplicate, failed);
          
          await new Promise(r => setTimeout(r, 800));
          
        } catch (error) {
          console.error('‚ùå Upload error:', error);
          failed++;
          g_sessionStats.totalFailed++;
        }
      }

      g_sessionStats.queueSize = g_pendingUploads.length;

      btn.disabled = false;
      btn.textContent = '‚úì Submit Attendance';
      hideUploadToast();

      saveToLocalStorage();
      renderStudentList();
      updateRoznamcha();
      updateSystemInfo();

      const message = `üìä Upload Complete!\n\n‚úÖ Success: ${success}\n‚ö†Ô∏è Duplicate: ${duplicate}\n‚ùå Failed: ${failed}`;
      alert(message);
    }

    async function uploadSingleAttendance(student, status) {
      let url = `${SCRIPT_URL}?action=insert&status=${status}`;
      
      if (student.enrollment) {
        url += `&enrollment=${encodeURIComponent(student.enrollment)}`;
      }
      
      url += `&name=${encodeURIComponent(student.name)}`;
      url += `&father=${encodeURIComponent(student.father)}`;
      
      if (student.uid) {
        url += `&uid=${encodeURIComponent(student.uid)}`;
      }
      
      console.log(`üì§ Uploading: ${student.name} - ${status}`);
      
      const response = await fetch(url, { method: 'GET' });
      const result = await response.json();
      
      console.log(`üì• Response:`, result);
      return result;
    }

    async function processPendingUploads() {
      if (g_pendingUploads.length === 0) return;
      
      console.log(`üîÑ Processing ${g_pendingUploads.length} pending uploads...`);
      
      const uploads = [...g_pendingUploads];
      
      for (const student of uploads) {
        try {
          const result = await uploadSingleAttendance(student, 'present');
          if (result.success || result.alreadyMarked) {
            g_pendingUploads = g_pendingUploads.filter(s => s.identifier !== student.identifier);
            g_todayAttendance[student.identifier] = 'present';
          }
        } catch (error) {
          console.error('Background upload failed:', error);
        }
      }
      
      g_sessionStats.queueSize = g_pendingUploads.length;
      saveToLocalStorage();
      console.log(`‚úÖ Background uploads complete. ${g_pendingUploads.length} remaining.`);
    }

    document.getElementById('searchInput')?.addEventListener('input', (e) => {
      filterAndRender();
    });

    // ===== STUDENT INFO SEARCH =====
    const studentSearchInput = document.getElementById('singleStudentSearch');
    const studentSearchDropdown = document.getElementById('studentSearchDropdown');
    
    studentSearchInput?.addEventListener('input', (e) => {
      const searchText = e.target.value.trim().toLowerCase();
      
      if (!searchText || searchText.length < 2) {
        studentSearchDropdown.classList.remove('show');
        return;
      }
      
      if (g_dataLoadStatus !== 'success' || g_students.length === 0) {
        studentSearchDropdown.innerHTML = '<div class="autocomplete-empty">No student data loaded</div>';
        studentSearchDropdown.classList.add('show');
        return;
      }
      
      const matchedStudents = g_students.filter(s => {
        return s.name.toLowerCase().includes(searchText) ||
               s.father.toLowerCase().includes(searchText) ||
               s.enrollment.toLowerCase().includes(searchText) ||
               (s.uid && s.uid.toLowerCase().includes(searchText));
      }).slice(0, 10); // Show max 10 results
      
      if (matchedStudents.length === 0) {
        studentSearchDropdown.innerHTML = '<div class="autocomplete-empty">No students found</div>';
        studentSearchDropdown.classList.add('show');
        return;
      }
      
      studentSearchDropdown.innerHTML = matchedStudents.map(s => `
        <div class="autocomplete-item" onclick="showStudentDetails('${s.identifier}')">
          <div class="autocomplete-item-avatar ${s.gender.toLowerCase() === 'm' ? 'male' : 'female'}">
            ${s.gender === 'M' ? 'üë®‚Äçüéì' : 'üë©‚Äçüéì'}
          </div>
          <div class="autocomplete-item-info">
            <div class="autocomplete-item-name">${s.name}</div>
            <div class="autocomplete-item-meta">
              <span>üë®‚Äçüëß ${s.father}</span>
              <span class="autocomplete-item-badge">üéì ${s.class}</span>
              <span class="autocomplete-item-badge">üÜî ${s.enrollment || s.uid || 'N/A'}</span>
            </div>
          </div>
        </div>
      `).join('');
      
      studentSearchDropdown.classList.add('show');
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.autocomplete-container')) {
        studentSearchDropdown?.classList.remove('show');
      }
    });
    
    function showStudentDetails(identifier) {
      const student = g_students.find(s => s.identifier === identifier);
      if (!student) return;
      
      studentSearchDropdown.classList.remove('show');
      studentSearchInput.value = student.name;
      
      const detailResult = document.getElementById('studentDetailResult');
      if (!detailResult) return;
      
      // Check attendance status
      const attendanceStatus = g_todayAttendance[identifier];
      const attendanceBadge = attendanceStatus === 'present' ? 
        '<div style="display:inline-block;background:linear-gradient(135deg,#10b981,#059669);color:white;padding:10px 22px;border-radius:30px;font-weight:700;font-size:13px;box-shadow:0 6px 16px rgba(16,185,129,0.4);letter-spacing:0.5px;text-transform:uppercase;">‚úÖ Present Today</div>' :
        attendanceStatus === 'absent' ?
        '<div style="display:inline-block;background:linear-gradient(135deg,#ef4444,#dc2626);color:white;padding:10px 22px;border-radius:30px;font-weight:700;font-size:13px;box-shadow:0 6px 16px rgba(239,68,68,0.4);letter-spacing:0.5px;text-transform:uppercase;">‚ùå Absent Today</div>' :
        '<div style="display:inline-block;background:linear-gradient(135deg,#f59e0b,#d97706);color:white;padding:10px 22px;border-radius:30px;font-weight:700;font-size:13px;box-shadow:0 6px 16px rgba(245,158,11,0.4);letter-spacing:0.5px;text-transform:uppercase;">‚è≥ Not Marked</div>';
      
      detailResult.innerHTML = `
        <div class="card" style="background:linear-gradient(135deg, #667eea08 0%, #764ba208 100%);border:3px solid var(--brand);margin-top:16px;padding:0;overflow:hidden;">
          <!-- Professional Header with Photo Frame -->
          <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);padding:30px 20px;text-align:center;position:relative;overflow:hidden;">
            <div style="position:absolute;top:0;left:0;right:0;bottom:0;background:url('data:image/svg+xml,%3Csvg width=\"100\" height=\"100\" xmlns=\"http://www.w3.org/2000/svg\"%3E%3Cpath d=\"M0 0L50 50L0 100L50 50L100 100L50 50L100 0L50 50Z\" fill=\"%23ffffff\" opacity=\"0.05\"/%3E%3C/svg%3E');opacity:0.3;"></div>
            <div style="width:120px;height:120px;margin:0 auto 20px;background:white;border-radius:20px;display:flex;align-items:center;justify-content:center;font-size:60px;box-shadow:0 15px 35px rgba(0,0,0,0.3);border:5px solid rgba(255,255,255,0.3);position:relative;z-index:1;">
              ${student.gender === 'M' ? 'üë®‚Äçüéì' : 'üë©‚Äçüéì'}
            </div>
            <div style="font-size:24px;font-weight:700;color:white;margin-bottom:10px;text-transform:uppercase;letter-spacing:0.5px;text-shadow:0 2px 8px rgba(0,0,0,0.3);position:relative;z-index:1;">
              ${student.name}
            </div>
            <div style="font-size:15px;color:rgba(255,255,255,0.95);font-weight:600;margin-bottom:16px;position:relative;z-index:1;">
              <span style="background:rgba(255,255,255,0.2);padding:6px 14px;border-radius:20px;display:inline-block;">
                üë®‚Äçüëß S/O: ${student.father}
              </span>
            </div>
            <div style="position:relative;z-index:1;">
              ${attendanceBadge}
            </div>
          </div>
          
          <!-- Formal Information Sections -->
          <div style="padding:24px 20px;">
            <!-- Primary Information -->
            <div style="background:white;border-radius:16px;padding:20px;margin-bottom:16px;box-shadow:0 4px 12px rgba(0,0,0,0.06);border-left:5px solid var(--brand);">
              <div style="font-size:11px;font-weight:700;color:var(--brand);text-transform:uppercase;letter-spacing:1px;margin-bottom:16px;display:flex;align-items:center;gap:8px;">
                <span style="width:3px;height:18px;background:var(--brand);border-radius:2px;"></span>
                PRIMARY IDENTIFICATION
              </div>
              <div style="display:grid;gap:14px;">
                ${student.uid ? `
                <div style="display:flex;align-items:center;">
                  <div class="detail-icon-box" style="background:linear-gradient(135deg,#667eea,#764ba2);">
                    üÜî
                  </div>
                  <div style="flex:1;min-width:0;">
                    <div style="font-size:10px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;">RFID Card Number</div>
                    <div style="font-size:16px;font-weight:700;color:var(--text);font-family:monospace;letter-spacing:0.5px;word-break:break-all;">${student.uid}</div>
                  </div>
                </div>
                ` : ''}
                
                <div style="display:flex;align-items:center;">
                  <div class="detail-icon-box" style="background:linear-gradient(135deg,#f59e0b,#d97706);">
                    üé´
                  </div>
                  <div style="flex:1;">
                    <div style="font-size:10px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;">Enrollment Number</div>
                    <div style="font-size:16px;font-weight:700;color:var(--text);">${student.enrollment || 'N/A'}</div>
                  </div>
                </div>
                
                <div style="display:flex;align-items:center;">
                  <div class="detail-icon-box" style="background:linear-gradient(135deg,#10b981,#059669);">
                    üî¢
                  </div>
                  <div style="flex:1;">
                    <div style="font-size:10px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;">Serial Number</div>
                    <div style="font-size:16px;font-weight:700;color:var(--text);">${student.srNo || 'N/A'}</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Personal Information -->
            <div style="background:white;border-radius:16px;padding:20px;margin-bottom:16px;box-shadow:0 4px 12px rgba(0,0,0,0.06);border-left:5px solid #10b981;">
              <div style="font-size:11px;font-weight:700;color:#10b981;text-transform:uppercase;letter-spacing:1px;margin-bottom:16px;display:flex;align-items:center;gap:8px;">
                <span style="width:3px;height:18px;background:#10b981;border-radius:2px;"></span>
                PERSONAL INFORMATION
              </div>
              <div style="display:grid;gap:14px;">
                <div style="display:flex;align-items:center;">
                  <div class="detail-icon-box" style="background:linear-gradient(135deg,${student.gender === 'M' ? '#3b82f6,#2563eb' : '#ec4899,#db2777'});">
                    ${student.gender === 'M' ? 'üë®' : 'üë©'}
                  </div>
                  <div style="flex:1;">
                    <div style="font-size:10px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;">Gender</div>
                    <div style="font-size:16px;font-weight:700;color:var(--text);">${student.gender === 'M' ? 'Male' : student.gender === 'F' ? 'Female' : 'N/A'}</div>
                  </div>
                </div>
                
                ${student.dob ? `
                <div style="display:flex;align-items:center;">
                  <div class="detail-icon-box" style="background:linear-gradient(135deg,#f59e0b,#d97706);">
                    üéÇ
                  </div>
                  <div style="flex:1;">
                    <div style="font-size:10px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;">Date of Birth</div>
                    <div style="font-size:16px;font-weight:700;color:var(--text);">${student.dob}</div>
                  </div>
                </div>
                ` : ''}
                
                ${student.bform ? `
                <div style="display:flex;align-items:center;">
                  <div class="detail-icon-box" style="background:linear-gradient(135deg,#06b6d4,#0891b2);">
                    üìÑ
                  </div>
                  <div style="flex:1;min-width:0;">
                    <div style="font-size:10px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;">B-Form Number</div>
                    <div style="font-size:14px;font-weight:700;color:var(--text);font-family:monospace;word-break:break-all;">${student.bform}</div>
                  </div>
                </div>
                ` : ''}
              </div>
            </div>

            <!-- Academic Information -->
            <div style="background:white;border-radius:16px;padding:20px;margin-bottom:16px;box-shadow:0 4px 12px rgba(0,0,0,0.06);border-left:5px solid #8b5cf6;">
              <div style="font-size:11px;font-weight:700;color:#8b5cf6;text-transform:uppercase;letter-spacing:1px;margin-bottom:16px;display:flex;align-items:center;gap:8px;">
                <span style="width:3px;height:18px;background:#8b5cf6;border-radius:2px;"></span>
                ACADEMIC INFORMATION
              </div>
              <div style="display:grid;gap:14px;">
                <div style="display:flex;align-items:center;">
                  <div class="detail-icon-box" style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);">
                    üéì
                  </div>
                  <div style="flex:1;">
                    <div style="font-size:10px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;">Current Class</div>
                    <div style="font-size:17px;font-weight:700;color:var(--text);">${student.class || 'N/A'}</div>
                  </div>
                </div>
                
                ${student.admission ? `
                <div style="display:flex;align-items:center;">
                  <div class="detail-icon-box" style="background:linear-gradient(135deg,#667eea,#764ba2);">
                    üìÖ
                  </div>
                  <div style="flex:1;">
                    <div style="font-size:10px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;">Date of Admission</div>
                    <div style="font-size:16px;font-weight:700;color:var(--text);">${student.admission}</div>
                  </div>
                </div>
                ` : ''}
              </div>
            </div>

            <!-- Guardian Information -->
            <div style="background:white;border-radius:16px;padding:20px;margin-bottom:20px;box-shadow:0 4px 12px rgba(0,0,0,0.06);border-left:5px solid #ef4444;">
              <div style="font-size:11px;font-weight:700;color:#ef4444;text-transform:uppercase;letter-spacing:1px;margin-bottom:16px;display:flex;align-items:center;gap:8px;">
                <span style="width:3px;height:18px;background:#ef4444;border-radius:2px;"></span>
                GUARDIAN CONTACT
              </div>
              <div style="display:grid;gap:14px;">
                ${student.mobile ? `
                <div style="display:flex;align-items:center;">
                  <div class="detail-icon-box" style="background:linear-gradient(135deg,#10b981,#059669);">
                    üìû
                  </div>
                  <div style="flex:1;">
                    <div style="font-size:10px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;">Father Mobile Number</div>
                    <div style="font-size:16px;font-weight:700;color:var(--text);font-family:monospace;">
                      <a href="tel:${student.mobile}" style="color:var(--brand);text-decoration:none;">${student.mobile}</a>
                    </div>
                  </div>
                </div>
                ` : ''}
                
                ${student.cnic ? `
                <div style="display:flex;align-items:center;">
                  <div class="detail-icon-box" style="background:linear-gradient(135deg,#ef4444,#dc2626);">
                    ü™™
                  </div>
                  <div style="flex:1;min-width:0;">
                    <div style="font-size:10px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;">Father CNIC Number</div>
                    <div style="font-size:14px;font-weight:700;color:var(--text);font-family:monospace;word-break:break-all;">${student.cnic}</div>
                  </div>
                </div>
                ` : ''}
              </div>
            </div>
          
            <!-- Action Buttons -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
              <button onclick="markStudentAttendance('${identifier}', 'present')" 
                      class="action-btn-present"
                      style="padding:14px;border:none;border-radius:12px;background:linear-gradient(135deg,#10b981,#059669);color:white;font-weight:700;font-size:14px;cursor:pointer;box-shadow:0 4px 12px rgba(16,185,129,0.4);transition:all 0.3s;text-transform:uppercase;letter-spacing:0.5px;">
                ‚úÖ Mark Present
              </button>
              <button onclick="markStudentAttendance('${identifier}', 'absent')" 
                      class="action-btn-absent"
                      style="padding:14px;border:none;border-radius:12px;background:linear-gradient(135deg,#ef4444,#dc2626);color:white;font-weight:700;font-size:14px;cursor:pointer;box-shadow:0 4px 12px rgba(239,68,68,0.4);transition:all 0.3s;text-transform:uppercase;letter-spacing:0.5px;">
                ‚ùå Mark Absent
              </button>
            </div>
          </div>
        </div>
      `;
    }
    
    function markStudentAttendance(identifier, status) {
      const student = g_students.find(s => s.identifier === identifier);
      if (!student) return;
      
      if (confirm(`Mark ${student.name} as ${status}?`)) {
        g_todayAttendance[identifier] = status;
        saveToLocalStorage();
        
        // Refresh the display
        showStudentDetails(identifier);
        
        // Upload to server
        uploadSingleAttendance(student, status);
        
        alert(`‚úÖ ${student.name} marked as ${status}!`);
      }
    }
    
    // Make function globally accessible
    window.showStudentDetails = showStudentDetails;
    window.markStudentAttendance = markStudentAttendance;
    window.loadRoznamchaData = loadRoznamchaData;
    window.startRoznamchaAutoRefresh = startRoznamchaAutoRefresh;

    function showUploadToast(current, total) {
      const existing = document.getElementById('uploadToast');
      if (existing) existing.remove();

      const toast = document.createElement('div');
      toast.id = 'uploadToast';
      toast.className = 'upload-toast';
      toast.innerHTML = `
        <div style="font-weight:700;margin-bottom:8px;">üì§ Uploading Attendance...</div>
        <div class="upload-progress-bar">
          <div class="upload-progress-fill" style="width:0%"></div>
        </div>
        <div id="uploadStats" style="font-size:12px;color:var(--muted);margin-top:6px;">
          0 / ${total} uploaded
        </div>
      `;
      document.body.appendChild(toast);
    }

    function updateUploadToast(current, total, success, duplicate, failed) {
      const progress = (current / total) * 100;
      const fill = document.querySelector('.upload-progress-fill');
      const stats = document.getElementById('uploadStats');
      
      if (fill) fill.style.width = `${progress}%`;
      if (stats) {
        stats.innerHTML = `${current} / ${total} | ‚úÖ ${success} | ‚ö†Ô∏è ${duplicate} | ‚ùå ${failed}`;
      }
    }

    function hideUploadToast() {
      setTimeout(() => {
        const toast = document.getElementById('uploadToast');
        if (toast) toast.remove();
      }, 2000);
    }

    // ===== ROZNAMCHA (DAILY REPORT) FROM GOOGLE SHEET =====
    async function loadRoznamchaData() {
      try {
        console.log('üì• Loading Roznamcha data from Google Sheet...');
        
        const response = await fetch(ROZNAMCHA_CSV_URL, {
          method: 'GET',
          cache: 'no-cache'
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const csvText = await response.text();
        const lines = csvText.split('\n');
        
        // Parse the CSV data
        const data = {
          day: '',
          date: '',
          percentage: '',
          classes: []
        };
        
        // Find the day (Tuesday, Monday, etc.)
        if (lines[1]) {
          const dayLine = lines[1].split(',');
          data.day = dayLine[0] || '';
        }
        
        // Find date and percentage from last rows
        for (let i = lines.length - 1; i >= 0; i--) {
          const line = lines[i].trim();
          if (!line) continue;
          
          const cols = parseCSVLine(line);
          if (cols[0] && cols[0].toLowerCase().includes('date')) {
            data.date = cols[1] || '';
          }
          if (cols[1] && cols[1].includes('%')) {
            data.percentage = cols[1];
          }
        }
        
        // Parse class data (rows 3-8 typically)
        for (let i = 3; i < lines.length - 3 && i < 12; i++) {
          const line = lines[i].trim();
          if (!line || line.toLowerCase().includes('total') || line.toLowerCase().includes('date')) continue;
          
          const cols = parseCSVLine(line);
          if (cols.length >= 10) {
            data.classes.push({
              name: cols[0] || '',
              presentBoys: parseInt(cols[1]) || 0,
              presentGirls: parseInt(cols[2]) || 0,
              presentTotal: parseInt(cols[3]) || 0,
              absentBoys: parseInt(cols[4]) || 0,
              absentGirls: parseInt(cols[5]) || 0,
              absentTotal: parseInt(cols[6]) || 0,
              totalBoys: parseInt(cols[7]) || 0,
              totalGirls: parseInt(cols[8]) || 0,
              totalStudents: parseInt(cols[9]) || 0
            });
          }
        }
        
        // Find total row
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i].trim();
          if (line.toLowerCase().startsWith('total')) {
            const cols = parseCSVLine(line);
            if (cols.length >= 10) {
              data.totals = {
                presentBoys: parseInt(cols[1]) || 0,
                presentGirls: parseInt(cols[2]) || 0,
                presentTotal: parseInt(cols[3]) || 0,
                absentBoys: parseInt(cols[4]) || 0,
                absentGirls: parseInt(cols[5]) || 0,
                absentTotal: parseInt(cols[6]) || 0,
                totalBoys: parseInt(cols[7]) || 0,
                totalGirls: parseInt(cols[8]) || 0,
                totalStudents: parseInt(cols[9]) || 0
              };
            }
            break;
          }
        }
        
        g_roznamchaData = data;
        console.log('‚úÖ Roznamcha data loaded successfully');
        updateRoznamcha();
        
      } catch (error) {
        console.error('‚ùå Roznamcha loading failed:', error);
        g_roznamchaData = null;
        updateRoznamcha();
      }
    }
    
    function updateRoznamcha() {
      const container = document.getElementById('roznamchaContent');
      if (!container) return;

      if (!g_roznamchaData) {
        container.innerHTML = `
          <div class="card" style="text-align:center;padding:40px;">
            <div class="loading-spinner"></div>
            <div style="margin-top:16px;color:var(--muted);font-weight:600;">Loading Roznamcha data from Google Sheet...</div>
            <button onclick="loadRoznamchaData()" class="btn-primary" style="margin-top:16px;padding:10px 20px;">
              üîÑ Reload
            </button>
          </div>
        `;
        return;
      }
      
      const data = g_roznamchaData;
      const percentage = parseInt(data.percentage) || 0;
      const percentageClass = percentage >= 90 ? 'percentage-excellent' : 
                             percentage >= 80 ? 'percentage-good' : 'percentage-warning';
      
      container.innerHTML = `
        <!-- Roznamcha Header -->
        <div class="card" style="background:linear-gradient(135deg, #1e293b 0%, #334155 100%);color:white;padding:20px;margin-bottom:16px;border-radius:16px;box-shadow:0 8px 20px rgba(0,0,0,0.3);">
          <div class="urdu-text" style="font-size:16px;font-weight:700;text-align:center;line-height:1.8;">
            ÿ±Ÿàÿ≤ÿßŸÜ€Å ÿ≠ÿßÿ∂ÿ±€å ⁄©Ÿà ŸÖÿ≠ŸÅŸàÿ∏ ÿ±⁄©⁄æŸÜ€í ⁄©€å ÿ±ÿ¨ÿ≥Ÿπÿ±€åÿ¥ŸÜ ŸÖ⁄©ŸÖŸÑ ÿ¥€åŸÜŸàÿßŸÑ ŸÖÿ±⁄©ÿ≤ ⁄©€í ÿ¥ŸÖÿ≥ ⁄©€í
          </div>
        </div>

        <!-- Day and Status Banner -->
        <div style="display:grid;grid-template-columns:1fr auto 1fr;gap:12px;margin-bottom:16px;">
          <div class="card" style="padding:16px;text-align:center;background:linear-gradient(135deg,#667eea15,#764ba215);border:2px solid var(--brand);">
            <div style="font-size:13px;color:var(--brand);font-weight:700;text-transform:uppercase;margin-bottom:6px;">Day</div>
            <div style="font-size:20px;font-weight:800;color:var(--text);">${data.day || 'Tuesday'}</div>
          </div>
          <div class="card" style="padding:16px;text-align:center;background:linear-gradient(135deg,${percentage >= 85 ? '#10b98115' : '#ef444415'},${percentage >= 85 ? '#059c6915' : '#dc262615'});border:2px solid ${percentage >= 85 ? '#10b981' : '#ef4444'};">
            <div class="percentage-badge ${percentageClass}" style="font-size:28px;padding:8px 20px;">
              ${data.percentage || '0%'}
            </div>
            <div style="font-size:11px;color:var(--muted);font-weight:700;margin-top:6px;">ATTENDANCE</div>
          </div>
          <div class="card" style="padding:16px;text-align:center;background:linear-gradient(135deg,#667eea15,#764ba215);border:2px solid var(--brand);">
            <div style="font-size:13px;color:var(--brand);font-weight:700;text-transform:uppercase;margin-bottom:6px;">Date</div>
            <div style="font-size:16px;font-weight:800;color:var(--text);">${data.date || new Date().toLocaleDateString('en-GB')}</div>
          </div>
        </div>

        <!-- Main Roznamcha Table -->
        <div class="card" style="padding:0;overflow:hidden;">
          <div style="overflow-x:auto;">
            <table class="roznamcha-table">
              <thead>
                <tr style="background:#1e293b;">
                  <th rowspan="2" style="color:white;border:2px solid #334155;min-width:100px;font-size:12px;">
                    <div style="font-weight:800;">CLASS</div>
                  </th>
                  <th colspan="3" style="background:#10b981;color:white;border:2px solid #059669;font-size:11px;">
                    <div class="urdu-text" style="font-weight:700;margin-bottom:2px;">ÿ≠ÿßÿ∂ÿ± ÿ∑ŸÑÿ®ÿßÿ°</div>
                    <div style="font-size:9px;opacity:0.9;">Present Students</div>
                  </th>
                  <th colspan="3" style="background:#ef4444;color:white;border:2px solid #dc2626;font-size:11px;">
                    <div class="urdu-text" style="font-weight:700;margin-bottom:2px;">ÿ∫€åÿ± ÿ≠ÿßÿ∂ÿ± ÿ∑ŸÑÿ®ÿßÿ°</div>
                    <div style="font-size:9px;opacity:0.9;">Absent Students</div>
                  </th>
                  <th colspan="3" style="background:#667eea;color:white;border:2px solid #4f46e5;font-size:11px;">
                    <div class="urdu-text" style="font-weight:700;margin-bottom:2px;">⁄©ŸÑ ÿ™ÿπÿØÿßÿØ ÿ∑ŸÑÿ®ÿßÿ°</div>
                    <div style="font-size:9px;opacity:0.9;">Total Students</div>
                  </th>
                </tr>
                <tr style="background:#334155;">
                  <th style="color:white;border:2px solid #475569;font-size:11px;font-weight:700;">Boys</th>
                  <th style="color:white;border:2px solid #475569;font-size:11px;font-weight:700;">Girls</th>
                  <th style="color:white;border:2px solid #475569;font-size:11px;font-weight:700;">Total</th>
                  <th style="color:white;border:2px solid #475569;font-size:11px;font-weight:700;">Boys</th>
                  <th style="color:white;border:2px solid #475569;font-size:11px;font-weight:700;">Girls</th>
                  <th style="color:white;border:2px solid #475569;font-size:11px;font-weight:700;">Total</th>
                  <th style="color:white;border:2px solid #475569;font-size:11px;font-weight:700;">Boys</th>
                  <th style="color:white;border:2px solid #475569;font-size:11px;font-weight:700;">Girls</th>
                  <th style="color:white;border:2px solid #475569;font-size:11px;font-weight:700;">Total</th>
                </tr>
              </thead>
              <tbody>
                ${data.classes.map(cls => `
                  <tr>
                    <td style="text-align:left;font-weight:800;color:#ef4444;background:#fef2f2;padding-left:12px;border:2px solid #fee2e2;font-size:12px;">${cls.name}</td>
                    <td style="background:#d1fae5;font-weight:700;color:#059669;border:2px solid #a7f3d0;font-size:13px;">${cls.presentBoys}</td>
                    <td style="background:#d1fae5;font-weight:700;color:#059669;border:2px solid #a7f3d0;font-size:13px;">${cls.presentGirls}</td>
                    <td style="background:#d1fae5;font-weight:800;color:#047857;border:2px solid #a7f3d0;font-size:14px;">${cls.presentTotal}</td>
                    <td style="background:#fee2e2;font-weight:700;color:#dc2626;border:2px solid #fecaca;font-size:13px;">${cls.absentBoys}</td>
                    <td style="background:#fee2e2;font-weight:700;color:#dc2626;border:2px solid #fecaca;font-size:13px;">${cls.absentGirls}</td>
                    <td style="background:#fee2e2;font-weight:800;color:#b91c1c;border:2px solid #fecaca;font-size:14px;">${cls.absentTotal}</td>
                    <td style="background:#e0e7ff;font-weight:700;color:#4f46e5;border:2px solid #c7d2fe;font-size:13px;">${cls.totalBoys}</td>
                    <td style="background:#fce7f3;font-weight:700;color:#db2777;border:2px solid #fbcfe8;font-size:13px;">${cls.totalGirls}</td>
                    <td style="background:#f3f4f6;font-weight:800;color:#1e293b;border:2px solid #e5e7eb;font-size:14px;">${cls.totalStudents}</td>
                  </tr>
                `).join('')}
                ${data.totals ? `
                <tr style="background:#1e293b;color:white;">
                  <td style="font-weight:800;font-size:13px;border:2px solid #334155;">Total</td>
                  <td style="font-weight:800;font-size:14px;border:2px solid #334155;">${data.totals.presentBoys}</td>
                  <td style="font-weight:800;font-size:14px;border:2px solid #334155;">${data.totals.presentGirls}</td>
                  <td style="font-weight:900;font-size:15px;border:2px solid #334155;">${data.totals.presentTotal}</td>
                  <td style="font-weight:800;font-size:14px;border:2px solid #334155;">${data.totals.absentBoys}</td>
                  <td style="font-weight:800;font-size:14px;border:2px solid #334155;">${data.totals.absentGirls}</td>
                  <td style="font-weight:900;font-size:15px;border:2px solid #334155;">${data.totals.absentTotal}</td>
                  <td style="font-weight:800;font-size:14px;border:2px solid #334155;">${data.totals.totalBoys}</td>
                  <td style="font-weight:800;font-size:14px;border:2px solid #334155;">${data.totals.totalGirls}</td>
                  <td style="font-weight:900;font-size:15px;border:2px solid #334155;">${data.totals.totalStudents}</td>
                </tr>
                ` : ''}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Summary Footer -->
        <div class="card" style="margin-top:16px;background:linear-gradient(135deg,#667eea08,#764ba208);border:2px solid var(--brand-light);">
          <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px;">
            <div style="text-align:center;flex:1;min-width:120px;">
              <div class="urdu-text" style="font-size:14px;font-weight:700;color:var(--brand);margin-bottom:8px;">ŸÖÿ¨ŸÖŸàÿπ€å ÿ≠ÿßÿ∂ÿ±€å</div>
              <div class="percentage-badge ${percentageClass}" style="font-size:32px;padding:10px 20px;">
                ${data.percentage || '0%'}
              </div>
            </div>
            <div style="text-align:center;flex:1;min-width:150px;">
              <div style="font-size:11px;color:var(--muted);font-weight:700;text-transform:uppercase;margin-bottom:8px;">Auto-Refresh</div>
              <div style="font-size:13px;font-weight:700;color:var(--brand);">Every 5 Minutes</div>
            </div>
            <div style="text-align:center;flex:1;min-width:120px;">
              <button onclick="loadRoznamchaData()" class="btn-primary" style="padding:10px 20px;font-size:13px;">
                üîÑ Refresh Now
              </button>
            </div>
          </div>
        </div>
      `;
    }
    
    // Start Roznamcha auto-refresh
    function startRoznamchaAutoRefresh() {
      // Clear existing interval
      if (g_roznamchaRefreshInterval) {
        clearInterval(g_roznamchaRefreshInterval);
      }
      
      // Load initial data
      loadRoznamchaData();
      
      // Auto-refresh every 5 minutes (300000 ms)
      g_roznamchaRefreshInterval = setInterval(() => {
        console.log('üîÑ Auto-refreshing Roznamcha data...');
        loadRoznamchaData();
      }, 5 * 60 * 1000);
      
      console.log('‚úÖ Roznamcha auto-refresh started (every 5 minutes)');
    }

    // ===== SYSTEM INFO =====
    function updateSystemInfo() {
      const content = document.getElementById('systemInfoContent');
      if (!content) return;
      
      const totalStudents = g_students.length;
      const currentTime = new Date().toLocaleString('en-GB', { timeZone: 'Asia/Karachi' });
      const dataStatus = g_dataLoadStatus === 'success' ? 'success' : 
                        g_dataLoadStatus === 'loading' ? 'warning' : 'error';
      const dataStatusText = g_dataLoadStatus === 'success' ? '‚úÖ Loaded' : 
                            g_dataLoadStatus === 'loading' ? '‚è≥ Loading' : '‚ùå Error';
      const dataStatusColor = g_dataLoadStatus === 'success' ? '#10b981' : 
                             g_dataLoadStatus === 'loading' ? '#f59e0b' : '#ef4444';
      
      content.innerHTML = `
        ${g_dataLoadStatus === 'success' ? `
        <div class="system-ready-banner">
          <div style="font-size:36px;margin-bottom:10px;">üì°</div>
          <div style="font-size:20px;font-weight:800;margin-bottom:6px;">System Ready - Real-Time Mode!</div>
          <div style="font-size:13px;opacity:0.9;margin-top:8px;">‚úÖ Connected to live Google Sheets database</div>
        </div>
        ` : ''}

        <div class="card" style="margin-bottom:16px;">
          <h3 style="color:var(--brand);margin-bottom:16px;font-size:18px;display:flex;align-items:center;gap:8px;">
            <span>üîå</span> System Connectivity Status
          </h3>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;">
            <div style="padding:12px;background:linear-gradient(135deg,#10b98115,#059c6915);border-radius:10px;border:2px solid #10b981;">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
                <span style="font-weight:700;font-size:13px;color:var(--text);">WiFi</span>
                <span class="status-badge success">‚úÖ Connected</span>
              </div>
            </div>
            <div style="padding:12px;background:linear-gradient(135deg,${dataStatusColor}15,${dataStatusColor}10);border-radius:10px;border:2px solid ${dataStatusColor};">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
                <span style="font-weight:700;font-size:13px;color:var(--text);">Student Data</span>
                <span class="status-badge ${dataStatus}">${dataStatusText}</span>
              </div>
            </div>
            <div style="padding:12px;background:linear-gradient(135deg,#10b98115,#059c6915);border-radius:10px;border:2px solid #10b981;">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
                <span style="font-weight:700;font-size:13px;color:var(--text);">Link Status</span>
                <span class="status-badge success">‚úÖ OK</span>
              </div>
            </div>
            <div style="padding:12px;background:linear-gradient(135deg,#10b98115,#059c6915);border-radius:10px;border:2px solid #10b981;">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
                <span style="font-weight:700;font-size:13px;color:var(--text);">Server</span>
                <span class="status-badge success">‚úÖ Online</span>
              </div>
            </div>
            <div style="padding:12px;background:linear-gradient(135deg,#fef3c715,#d9770615);border-radius:10px;border:2px solid #f59e0b;">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
                <span style="font-weight:700;font-size:13px;color:var(--text);">Sheet Write</span>
                <span class="status-badge warning">‚è≠Ô∏è Pending</span>
              </div>
            </div>
            <div style="padding:12px;background:linear-gradient(135deg,#10b98115,#059c6915);border-radius:10px;border:2px solid #10b981;">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
                <span style="font-weight:700;font-size:13px;color:var(--text);">SPIFFS Mount</span>
                <span class="status-badge success">‚úÖ OK</span>
              </div>
            </div>
            <div style="padding:12px;background:linear-gradient(135deg,#10b98115,#059c6915);border-radius:10px;border:2px solid #10b981;">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
                <span style="font-weight:700;font-size:13px;color:var(--text);">RC522 Scanner</span>
                <span class="status-badge success">‚úÖ Ready</span>
              </div>
            </div>
            <div style="padding:12px;background:linear-gradient(135deg,#10b98115,#059c6915);border-radius:10px;border:2px solid #10b981;">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
                <span style="font-weight:700;font-size:13px;color:var(--text);">NTP Time</span>
                <span class="status-badge success">‚úÖ Synced</span>
              </div>
            </div>
          </div>
          ${g_dataLoadStatus === 'success' ? `
          <div style="margin-top:12px;padding:12px;background:#d1fae5;border-radius:8px;text-align:center;">
            <strong style="color:#059669;">‚úÖ Real-Time Mode Active - ${totalStudents} students loaded from Google Sheets</strong>
          </div>
          ` : ''}
        </div>

        <div class="card" style="margin-bottom:16px;">
          <h3 style="color:var(--brand);margin-bottom:16px;font-size:18px;display:flex;align-items:center;gap:8px;">
            <span>üñ•Ô∏è</span> Hardware Information
          </h3>
          <div style="display:grid;gap:10px;">
            <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--brand-light);border-radius:8px;">
              <span style="font-weight:600;font-size:13px;color:var(--text);">üåê IP Address</span>
              <span style="font-weight:700;font-size:13px;color:var(--brand);font-family:monospace;">${IP_ADDRESS}</span>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--brand-light);border-radius:8px;">
              <span style="font-weight:600;font-size:13px;color:var(--text);">üîó MAC Address</span>
              <span style="font-weight:700;font-size:13px;color:var(--brand);font-family:monospace;">${MAC_ADDRESS}</span>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--brand-light);border-radius:8px;">
              <span style="font-weight:600;font-size:13px;color:var(--text);">üõ∞Ô∏è RF Scanner Model</span>
              <span style="font-weight:700;font-size:13px;color:var(--brand);">${SCANNER_MODEL}</span>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--brand-light);border-radius:8px;">
              <span style="font-weight:600;font-size:13px;color:var(--text);">üì∂ WiFi Name</span>
              <span style="font-weight:700;font-size:13px;color:var(--brand);">${WIFI_SSID}</span>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--brand-light);border-radius:8px;">
              <span style="font-weight:600;font-size:13px;color:var(--text);">‚öôÔ∏è Firmware Version</span>
              <span style="font-weight:700;font-size:13px;color:var(--brand);">${FIRMWARE_VERSION}</span>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--brand-light);border-radius:8px;">
              <span style="font-weight:600;font-size:13px;color:var(--text);">üß© Script Version</span>
              <span style="font-weight:700;font-size:13px;color:var(--brand);">${SCRIPT_VERSION}</span>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--brand-light);border-radius:8px;">
              <span style="font-weight:600;font-size:13px;color:var(--text);">üïí System Time</span>
              <span style="font-weight:700;font-size:13px;color:var(--brand);">${currentTime}</span>
            </div>
          </div>
        </div>
      `;
    }

    function saveToLocalStorage() {
      const today = new Date().toLocaleDateString('en-GB');
      localStorage.setItem('attendanceDate', today);
      localStorage.setItem('todayAttendance', JSON.stringify(g_todayAttendance));
      localStorage.setItem('allAttendance', JSON.stringify(g_allAttendance));
      localStorage.setItem('selectedUIDs', JSON.stringify([...g_selectedUIDs]));
      localStorage.setItem('sessionStats', JSON.stringify(g_sessionStats));
      localStorage.setItem('pendingUploads', JSON.stringify(g_pendingUploads));
    }

    function loadFromLocalStorage() {
      const today = new Date().toLocaleDateString('en-GB');
      const storedDate = localStorage.getItem('attendanceDate');
      
      if (storedDate === today) {
        const attendance = localStorage.getItem('todayAttendance');
        const allAttendance = localStorage.getItem('allAttendance');
        const selected = localStorage.getItem('selectedUIDs');
        const stats = localStorage.getItem('sessionStats');
        const pending = localStorage.getItem('pendingUploads');
        
        if (attendance) g_todayAttendance = JSON.parse(attendance);
        if (allAttendance) g_allAttendance = JSON.parse(allAttendance);
        if (selected) g_selectedUIDs = new Set(JSON.parse(selected));
        if (stats) g_sessionStats = JSON.parse(stats);
        if (pending) g_pendingUploads = JSON.parse(pending);
        
        console.log('‚úÖ Loaded from localStorage');
        
        if (g_pendingUploads.length > 0) {
          console.log(`üîÑ Found ${g_pendingUploads.length} pending uploads`);
          setTimeout(processPendingUploads, 2000);
        }
      } else {
        localStorage.removeItem('todayAttendance');
        localStorage.removeItem('selectedUIDs');
        g_todayAttendance = {};
        g_selectedUIDs = new Set();
      }
    }

    document.getElementById('loginBtn')?.addEventListener('click', handleLogin);
    document.getElementById('pinInput')?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') handleLogin();
    });

    function handleLogin() {
      const pin = document.getElementById('pinInput').value.trim();
      const errorEl = document.getElementById('loginError');
      
      if (pin === PIN) {
        errorEl.textContent = '';
        document.getElementById('viewLogin').classList.add('hidden');
        document.getElementById('viewMain').classList.remove('hidden');
        initializeApp();
      } else {
        errorEl.textContent = '‚ùå Invalid Password!';
        setTimeout(() => errorEl.textContent = '', 3000);
      }
    }

    setInterval(() => {
      const now = new Date();
      const dateStr = now.toLocaleDateString('en-GB');
      const timeStr = now.toLocaleTimeString('en-GB');
      const el = document.getElementById('loginDateTime');
      if (el) el.textContent = `${dateStr} ${timeStr}`;
    }, 1000);

    function initializeApp() {
      console.log('üöÄ Initializing GPS Sheinwal App v8.1 REAL-TIME...');
      loadFromLocalStorage();
      loadAllStudentsFast(); // This will retry up to 5 times if it fails
      startAutoSync();
      startRoznamchaAutoRefresh(); // Start Roznamcha auto-refresh on app load
    }

    function startAutoSync() {
      g_autoSyncInterval = setInterval(() => {
        console.log('üîÑ Auto-sync triggered...');
        saveToLocalStorage();
        if (g_pendingUploads.length > 0) {
          processPendingUploads();
        }
      }, 5 * 60 * 1000);
    }

    document.querySelectorAll('.main-tabs button').forEach(btn => {
      btn.addEventListener('click', (e) => {
        document.querySelectorAll('.main-tabs button').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        
        const sections = ['sectionAttendance', 'sectionReports', 'sectionRoznamcha', 'sectionSystemInfo'];
        sections.forEach(s => {
          const el = document.getElementById(s);
          if (el) el.classList.add('hidden');
        });
        
        if (e.target.id === 'tabAttendance') document.getElementById('sectionAttendance')?.classList.remove('hidden');
        if (e.target.id === 'tabReports') document.getElementById('sectionReports')?.classList.remove('hidden');
        if (e.target.id === 'tabRoznamcha') {
          document.getElementById('sectionRoznamcha')?.classList.remove('hidden');
          if (!g_roznamchaRefreshInterval) {
            startRoznamchaAutoRefresh();
          }
        }
        if (e.target.id === 'tabSystemInfo') {
          document.getElementById('sectionSystemInfo')?.classList.remove('hidden');
          updateSystemInfo();
        }
      });
    });

    document.querySelectorAll('.sub-tabs button').forEach(btn => {
      btn.addEventListener('click', (e) => {
        document.querySelectorAll('.sub-tabs button').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        
        const sections = ['subSectionManual', 'subSectionQR', 'subSectionStudentInfo'];
        sections.forEach(s => {
          const el = document.getElementById(s);
          if (el) el.classList.add('hidden');
        });
        
        if (e.target.id === 'subTabManual') document.getElementById('subSectionManual')?.classList.remove('hidden');
        if (e.target.id === 'subTabQR') document.getElementById('subSectionQR')?.classList.remove('hidden');
        if (e.target.id === 'subTabStudentInfo') document.getElementById('subSectionStudentInfo')?.classList.remove('hidden');
      });
    });

    document.getElementById('classSelect')?.addEventListener('change', filterAndRender);

    console.log('üì± GPS Sheinwal v8.1 REAL-TIME loaded');
    console.log('‚úÖ No test mode - only real-time data from Google Sheets');

    window.addEventListener('beforeunload', () => {
      saveToLocalStorage();
    });
  </script>
</body>
</html>
